# LLMNR Poisoning
- LLMNR is a protocol used to identify hosts when **DNS fails to do so**
	- Normal DNS sequence is
		- Check local cache
		- Check hosts file
		- Query DNS server
		- Fail -> LLMNR
	- LLMNR procedure (to capture NTLM authentication)
		- LLMNR broadcasts "who has HOSTNAME" to the local subnet
		- Any machine on that subnet can reply
		- Attack
			- After this, malicious host (via tools like **Responser**) can say "that's me" and trick victim into
				- Sending **NTLM authentication** (username + NTLMv2 Response) to the attacker
				- Allowing NTLM relay attacks against real services (SMB, HTTP)..

- Responder -> **Capturing NTLMv2 Response**
	- `sudo responder -I tun0 -dwP`
		- i is interface. if on network, is usually eth0
		- tun0 if on vpn
		- d for responding to DHCP requests
		- w for wpad
	- Listens for LLMNR broadcasts, and captures the NTLMv2 Response (hash)
		- Can then try to crack the hash
		- `hashcat -m 5600 hashes.txt rockyou.txt`

- Walkthrough example
	- Case study: user types `\\nonsense` in file explorer
		- Windows interprets this as a UNC path, meaning “connect to a share on host `nonsense`”.
	- Name resolution phase
		- Windows first tries **DNS** to resolve `nonsense`.
		- If DNS fails, it falls back to **LLMNR** or **NBT-NS** (depending on OS/config).
	- Attacker intercepts
		- The attacker’s machine (with Responder, for example) answers the LLMNR/NBT-NS query:  
		- “I am `nonsense` → here’s my IP.”
	- Client tries to authenticate
		- The victim’s machine now tries to connect to the fake “nonsense” SMB service (actually the attacker).
		- Since Kerberos requires a valid AD service principal (SPN) and a valid ticket from the domain controller, Kerberos **fails** here (no real `nonsense` host in AD).
	- Fallback to **NTLM**
		- Because Kerberos fails, Windows falls back to **NTLM authentication**.
		- The client sends an NTLM authentication **challenge–response exchange** to the attacker.
	- Attacker captures **NTLM** challenge-response
		- Can crack it offline with hashcat or 
		- Relay it to another server (if SMB signing is disabled)
			- SMB Relay

# SMB Relay
- Instead of cracking the hashes (NTLM challenge-response) gathered with Responder, can instead **relay those hashes** to specific machines and **potentially gain access**
- SMB Signing must be disabled or not enfored on target
	- See [[4. NTLM Summary]]

- Identifying hosts without SMB Signing
	- `nmap --script=smb2-security-mode.nse -p445 10.0.0.0/24 -Pn` 
	- Find: message siging emabled but not required
	- Put these hosts in targets.txt (for use later in relay script)
- Responder
	- Change the configuration to turn SMB and HTTP OFF
		- `sudo nano /etc/responder/Responder.conf`
		- Because we want hashes to not just be captured, but relayed
		- If we have SMB server on, for eg., local machine pretends to be the new server, and captures the authentication. The authentication ends there. No third machine to connect to.
		- With server mode off, Responder will still poison (say "i'm nonsense, connect to me", sends NTLM negotiate)
			- **BUT** it does not terminate the handshake itself, instead letting ntlmrelayx **forward it to the real target**.
	- Then run responder
		- `sudo responder -I tun0 -dwP`
- Relay
	- `sudo ntlmrelayx.py -tf targets.txt -smb2support`
		- targets.txt are the vulnerable machines found just now
		- -i to get a shell (reverse shell, need to bind to it on another window), -c to run command (eg. -c "whoami")
		- SAM dump: now have access to the **NT HASHES*!

# Gaining a shell after access
- psexec in metasploit
	- allos running of commands on remote Windows machine using administrative credentials
	- ms config, exploit/windows/smb/psexec
- *come back to this*


# IPv6 Attacks
- mitm6 (DNS Takeover)
	- Attacker sends rouge IPv6 Router Advertisements (RA) on LAN
		- pretends to be the **default gateway**, ie. the router, ie. the machine responsible for forwarding requests from this local network to the broader internet
	- Windows client auto-configure IPv6 and accept attacker as **default gateway + DNS server**
	- Then, **DNS Hijack**
		- Victim queries for DNS
			- eg. tries to ask for IP of Domain Contol
		- Attacker-controlled DNS replies with attacker's IP
		- Client connects to atacker instead of the real Domain Controller
	- Then, **Forced NTLM fallback and Relay NTLM** (seen previously)
		- Kerberos doesnt work since requires a valid SPN, NTLM fallback
		- Attacker relays NTLM credentials to the real Domain Controller over LDAP/SMP
		- Can request things like
			- Dump use lists
			- Add attacker to privileged groups..