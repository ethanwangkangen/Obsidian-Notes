# Server Message Block (SMB)
- network file and resource sharing protocol
- When client wants to access shared folder or printer on server, it must authenticate
- Windows supports 2 main authentication mechanisms over SMB:
	- Kerberos
	- NTLM/NTLMv2 (when Kerberos failes

# Kerberos with SMB
- **Client wants to access `\\fileserver\share`**
- Client checks **DNS/SPN (Service Principal Name)** for `fileserver` to get the Service Principal Name (SPN) (identifier for the service):
	- cifs/fileserver.example.com@EXAMPLE.COM
- Client uses TGT â†’ TGS to request a service ticket for that SPN.
- TGS issues ticket_s + Kc_s (encrypted with service key & client session key).
- Client sends AP-REQ to the SMB service:
	- ticket_s + authenticator
- Server decrypts ticket with its key (`Ks`), verifies authenticator (`Kc_s`), and grants access.

SMB Service
- SMB is a server process, implemented by the Lanman process/service
- Runs on a single machine, listening on network ports (TCP 445/139) for SMB requests from clients
- So when a client wants to access `\\fileserver\share`, it is talking to that server process
- This process handles
	- Authentication (Kerberos or NTLM)
	- Access control (permissions)
	- Reading/writing files over the network
- This service has an **account** and **secret key** in Active Directory
	- Key is Ks, for Kerberos tockets.
	- **SPN** (Service Principal Name)
		- see above

# Normal communication (DNS, Kerberos)
1. Client resolves server hostname
- eg. fileserver -> DNS -> fileserver.example.com -> IP address
2. Client requests service ticket from TGS (Kerberos)
3. TGS returns service ticket (ticket_s) + session key Kc_s
4. Client sends AP-REQ to SMB service

# When DNS resolution fails
- If client cannot resolve fileserver through DNS
	- May broadcast using **LLMNR or NBT-NS**
		- If attacker responds first, client thinks the attacker is the server
- SPN cannot be constructed 

# Under what circumstance does Kerberos fail?
- SPN missing or incorrect
	- Kerberos requires the **Service Principal Name (SPN)** for the service in Active Directory
		- ie. SPN required to request a service ticket from the TGS
	- DNS required for this
	- Why would this fail?
		- **DNS fails or returns a non-Fully Qualified Domain Name**
			- eg. Client only knows fileserver. If DNS cannot resolve fileserver, client cannot get `fileserver.example.com`. SPN requires the FQDN, so it cannot build `cifs/filerserver.example.com@REALM`
		- **Connection via IP**
			- If the client connects directly using `\\192.168.1.50\share`, there is no SPN tied to IP address, Kerberos tickets cannot be requested
		- **SPN missing or misconfigured in AD**
- Other reasons
	- **Time skew between client and KDC**
	- **Service or client does not support Kerberos**
	- **Cross-realm/trust issues**
	
- When Kerberos fails ->
	- **NTLM Fallback**



