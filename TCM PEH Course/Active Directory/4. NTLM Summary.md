
# NTLM Fallback
- NTlM Fallback happens when Kerberos fails (DNS/SPN failure, direct IP connections, rogue IPv6/DNS)...
- Attack types
	- NTLMv2 Hash Capture **(NTLMv2 Response, NOT NT HASH!)**
		- Methods:
			- LLMNR poisoning
			- IPv6 mitm (mitm6)
			- Rogue SMB/HTTP servers
		- Goal: make victim **authenticate to attacker** to capture the NTLMv2 response
			- Attacker can then crack hash offline to get pw (NT HASH & password), or use it directly in relay attacks
	- NTLM relay
		- Captured NTLMv2 authentication forwarded to real server that accepts NTLM
	- SMB relay/local admin compromise
		- Attacker relays NTLM auth to server with high privileges (eg. Domain Controller), to get domain-level compromise

# Terminology
- Password Hash (NT Hash) 
	- Client has a password, and a Password Hash (NT Hash) computed for it
	- NT hash = MD4(Unicode(password))
	- Never changes unless password changes
	- Stored on DC (in AD database/NTDS.dit) and inside LSASS on logged-in machine
- Challenge
	- Random 8-byte value sent by server during auth
- Response (NTLMv2 Response)
	- Client does not send the password or NT hash, instead computers
		- NTLMv2 Response = HMAC-MD5 (NT hash, (Challenge + ClientBob))
			- ClientBob includes things like timestamp, username, domain..
	- **This is what attacker captures in LLMMR poisoning/Responder attacks**

# SMB Signing -> prevents relay attacks
- Prevents SMB relay
- Normal NTLM over SMB
	- Client → Server: **Negotiate Protocol Request**
	- Server → Client: **Negotiate Protocol Response**
	- Client → Server: **NTLM Authentication Request**
		- Contains the username, domain, and the **NTLMv2 response** (hash-like value computed from challenge + password).
	- Server → Client: **Authentication Success/Fail*
	- After this, SMB session is authenticated and file operations can start.

- SMB relay attack
	- Attacker intercepts the handshake (via LLMNR, mitm6, poisoned WPAD)...
	- Instead of cracking the response hash, attacker forwards the NTLMv2 response to another SMB rservver
	- If that target accepts it, attacker is now logged in as the victim — **no password needed**.

- SMB signing
	- SMB signing requires that **every SMB message after authentication** (file read, write, RPC, etc.) is cryptographically signed.
	    - The signing key = derived from the ***NTLM session key***, which is computed using the victim’s **password**
    - Without the victim's password, attacker is unable to derive the session key and **cannot forge signatures**, thus their messages **will not be accepted by target**
    