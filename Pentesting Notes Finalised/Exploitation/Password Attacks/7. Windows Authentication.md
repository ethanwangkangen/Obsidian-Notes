![[Auth_process1.webp]]

1. Credential connection
	- LogonUI.exe is running. Prompts passwords for credentials at login
	- User types in username and password, sent via RPS messages from Win32k.sys
	- WinLogon passes them the input credentials to Local Security Authority Subsystem Service (LSASS)
2. LSASS
	- This is comprised of multiple modules, governs all authentication processes
	- Does not validate credentials itself, but *loads* authentication packages (DLLs) and calls them. The packages to the work
	- Packages example
		- msv1_0.dll - local/NTLm interactive authentication package, compares computed NT hashes against SAM (or verifies NTLM challenge responses)
		- kerberos.dll - kerberos client/server logic
		- netlogon.dll - used on domain controllers for netlogon services and ticket validation for certain network operations
	- Is the authority that decides, issues tokens, holds secrets needed (ie runtime vault)
		- If attacker can read Lsass memory/create lsass udmp, can recover tickets, keys etc.
	- Lsass decides which authentication package to use
		- a. Local -> calls msv1_0.dll to validate against local SAM
		- b,c. domain interactive logon -> kerberos.dll (preferred) or netlogon/kdc path
		- c. smartcard/cert -> kerberos pkinit path or certificate-based auth package
- 3a. Local account logon (SAM check)
	- **Security Account Manager (SAM)** is a database file in WIndows storing user account creds, used to authenticate local and remote users
		- Passwords stored as LM/NTLM hashes at `%SystemRoot%\system32\config\SAM
	- msv1_0 takes supplied password, computes NT hash, compares with the one in the SAM hive
		- If match, LSA builds logon session and access token contianing user SID, group SIDs, pris, logon type, session ID
		- Winlogon continues, loading user profile, starting shell under new token, desktop appears
- 3b. Domain logon using Keberos (preferred domain path)
	- See `<kerberos file>
- 3c. Network logon using NTLM (challenge/response)
	- See `<NTLM file>

Credential manager
- Built in feature of all Windows OS that allows user to store and manage credentials used to access network resources, websites and applications
- Credentials encrypted, stored at 
	- `PS C:\Users\[Username]\AppData\Local\Microsoft\[Vault/Credentials]\`

NTDS (more in Kerberos/AD section)
- `NTDS.dit` - file hosted in Domain Controller
	- stores AD data, inclusing user accounts, group accounts, computer accounts, group policy objects..


# Attacking SAM, SYSTEM, SECURITY
3 registry hives if we have local **admin access** to target
- `HKLM/SAM
	- pw hashes for local user accounts
- `HKLM\SYSTEM`
	- stores system boot key, used to encrypt SAM database
- `HKLM\SECURITY`
	- sensitive info used by LSA, including cached domain credentials (DCC2), cleartext passwords...

Saving copies of the hives
1. Launch cmd.exe with admin privileges
2. Save copies of hives
	- `reg.exe save hklm\sam C:\sam.save
	- `reg.exe save hklm\system C:\system.save`
	- `reg.exe save hklm\security C:\security.saave`