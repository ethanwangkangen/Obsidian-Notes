
Kerberos on Linux
- Most cases, Linux machines stores Kerberos tickets as `ccache files` in `tmp` directory
- Default, location of these tickets stored in environment variable `KRB5CCNAME`
- Kerberos also used for `keytab` files
	- Contapining pairs of Kerberos principals and encrypted keys dreived from the Kerberos password
	- Can use to authenticate to various remote systems using Kerberos without password

Eg. scenario
- We have a Linux01 connected to DC
	- This machine only reachable through MS01
- We can connect to MS01 via RDP, then ssh to the linux machine
- Or do port forwarding

# Identifying Linux and AD integration
- `realm list`
	- See if machine configured as Kerberos member
	- Give info on domain name, which users/groups permitted to log in
	- https://web.archive.org/web/20210624040251/https://www.2daygeek.com/how-to-identify-that-the-linux-server-is-integrated-with-active-directory-ad/
- If realm not available
	- `ps -ef | grep -i "winbind\|sssd"`
		- See if there are tools like winbind that are used to integrate Linux with AD

# Finding Kerberos Tickets in Linux
- Find files with `keytab` in the name
	- `find / -name *keytab* -ls 2>/dev/null`
- Find keytab files in Cronjobs
	- `crontab -l`
	- `cat` the scripts in there
- Finding `ccache` files
	1. See where the `ccache` files are stored
		- `env | grep -i krb5
			- Because location by default stored in KRB5CCNAME envir
	2. Search that location found above.
		- `ls -la /tmp
			- Assuming the location found above is `tmp` (which is it by default)

# Abusing KeyTab Files
- `klist` to see which user this is for
	- eg. `klist -k -t /opt/specialfiles/carlos.keytab `
- `kinit` to impersonate
	- eg. `kinit carlos@INLANEFREIGHT.HTB -k -t /opt/specialfiles/carlos.keytab
	- Should be authenticated as carlos now.
		- eg. can now do `smbclient //dc01/carlos -k -c ls`

# Extracting hashes from the Keytab file
- With `kinit`, can impersonate him to read shared folder on domain, but if we want access to his Linux account, need password

1. Run `keytabextract.py` on the keytab file
	- `python3 /opt/keytabextract.py /opt/specialfiles/carlos.keytab `
2. Retrieve ntlm hash, then do PTH attack (see prev page)
	- Can also crack with hashcat/JtR or  https://crackstation.net/
3. With the cracked password, can login as him
	- `su - carlos@inlanefreight.htb `

# Abusing Keytab ccache
- Can use the ccache files in `/tmp` if we are root