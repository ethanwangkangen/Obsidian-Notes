- Designed to run on top of NetBIOS over TCP/IP using TCP 139, UDP 137/138
- Microsoft add option to run SMB directly over TCP/IP using TCP 445 wihtout extra NetBIOS layer
- If 445 is open, expect modern SMB; if 139 is open (and 445 closed), youâ€™re likely on legacy NBT.

# Misconfigurations
- Anonymous authentication (null session)
	- Most tools that interact with SMB allow such connectivity, including `smblcient, smbmap, rpcclient, enm4linux`
- See [[4. SMB]] for use of smbmap, rpcclient..

# Protocol Specific Attacks
- Brute forcing, password spray
	- Say have a compiled username list and a password in mind, can spray with crackmapexec
	- `crackmapexec smb 10.10.110.17 -u userlist.txt -p 'Company01!' --local-auth
		- `--continue-on-success` to keep spraying even after valid password found
		- `--local-auth` if targetting non-domain joined computer

# Remote Code Execution (RCE)
- PsExec: tool to execute process on other systems without installing client software
	- Has a Windows service image inside executable which deploys to admin$ share on remote machine
	- Uses DCE/RPC interface over SMB to access WIndows Service Control Manager API, starts PSExec service on remote machine
	- PSExec service then creates a named pipe that can send commands to system
- Can use Linux implementations
	- Impacket PsExec
	- Impacket SMBExec
	- Impacket atexec
	- Crackmapexec - includes SMBExec

- Impacket Psexec
	- `impacket-psexec administrator:'Password123!'@10.10.110.17`
- Crackmapexec
	- `crackmapexec smb 10.10.110.17 -u Administrator -p 'Password123!' -x 'whoami' --exec-method smbexec`
	- Benefit: can run command on mjultiple users.
		- Eg. can enumerate logged on users for all machines within this network
		- `crackmapexec smb 10.10.110.0/24 -u administrator -p 'Password123!' --loggedon-users`
	- Extracting Hashes from SAM
		- See [[5. Windows Attacking]]`
		- `crackmapexec smb 10.10.110.17 -u administrator -p 'Password123!' --sam`
		- Can then pass NTLM hash to authenticate
			- `crackmapexec smb 10.10.110.17 -u Administrator -H 2B576ACBE6BCFDA7294D6BD18041B8FE

## Forced Authentication attacks
- Create fake SMB server to capture NTLM v1/v2 hashes
- Responder
	- LLMNR, NBT-NS, MDNS poisoner
	- `responder -I <interface name>`
	- Name resolution in Windows:
		- The hostname file share's IP address is required.
		- The local host file (C:\Windows\System32\Drivers\etc\hosts) will be checked for suitable records.
		- If no records are found, the machine switches to the local DNS cache, which keeps track of recently resolved names.
		- Is there no local DNS record? A query will be sent to the DNS server that has been configured.
		- If all else fails, the machine will issue a multicast query, requesting the IP address of the file share from other machines on the network.
	- Say user **mistype share folder's name**
		- All name resolutions faile since name don't exist
		- Machine sends multicast query including our server
		- Then we can reply maliciously isnce no measures to verify integrity
	- Saved hashes in `/usr/share/responder/logs`
		- Can copy to a file and crack with hashcat, module 5600
		- If cannot crack, can relay using impacket-ntlmrelayx or Responder MultiRelay.py
			- impacket-ntlmrelayx:
			- 1. Set SMB to OFF in responder config file `/etc/responder/Responder.cong`
			- 2. `impacket-ntlmrelayx --no-http-server -smb2support -t 10.10.110.146`
				- By default, dump SAM database, but can execute commands with `-c
				- Can create a Powershell reverse shell with www.revshells.com, set our machine IP address, port an option Powershell#3
				- See [[kiv]]
			- 3. Create listener on our server 
				- `nc -lvnp 9001`
			- 4. Execute reverse shell command to obtain reverse shell

# RPC
- See [[4. SMB]]


