# File Inclusion Prevention
- As far as possible, try to avoid passing user-controlled inputs into any file inclusion functions or APIs
	- Page should dynamically load back end, with no user interaction
	- If not possible, user whitelist of allowed user inputs

# Preventing Directory Traversal
- Use programming language/framwork's built in tool to pull only the filename
	- eg. PHP basename(), read the path and only return the filename portion
	- Downside: application cannot enter directories if it needs to
- Sanitise user input by recursively removing `../`
```
while(substr_count($input, '../', 0)) {
    $input = str_replace('../', '', $input);
};
```

# Web server config
- eg. Globally disable inclusion of remote files
	- In PHP, set `allow_url_fopen` and `allow_url_include` to off
- Can lock web applications to their web root directory
	- Common way: run application within Docker
	- In PHP, add `open_basedir = /var/www` in the php.ini file
- Disable functions
	- In PHP server config, eg.  `php.ini,
		- `disable_functions=system()`

# Web Application Firewall (WAF)


# Example
- Edit the php.ini file to block system(), then try to execute PHP Code that uses system. Read the /var/log/apache2/error.log file and fill in the blank: system() has been disabled for ________ reasons.
	- Hint: Place a PHP File in /var/www/html/ which contains a PHP Webshell using SYSTEM(), then use curl to execute the file. Be sure to restart apache after editing the PHP Configuration!
	- Put `<?php system($_GET["cmd"]); ?>` as `shell.php` inside the webroot, `/var/www/html`
	- Then restart apache
	- Execute the webshell by running 
		- `curl -s "http://10.129.29.112/shell.php?cmd=pwd"

Why does that execute the command?
1. HTTP request arrives
Apache receives an HTTP request for `/something.php`.

2. Apache routing kicks in
Apache sees the `.php` file extension and is configured to forward the request to the PHP interpreter, either via mod_php or PHP-FPM.

3. PHP interpreter executes the file
PHP does not serve the file contents like a static text file. Instead, it executes the PHP script from top to bottom. Any PHP code in the file runs immediately when the request is handled.

4. User input is already available
Data from the request is populated automatically into PHP superglobals:
- Query string parameters are available in `$_GET`
- POST body parameters are available in `$_POST`
- Request metadata such as headers and path information are available in `$_SERVER`

If the file contains logic that takes user-controlled input and performs unsafe operations with it, that logic will execute automatically as part of handling the request.

**The key mental model**

**Requesting a PHP file is not the same as downloading it. Requesting a PHP file means asking the server to execute a program.**