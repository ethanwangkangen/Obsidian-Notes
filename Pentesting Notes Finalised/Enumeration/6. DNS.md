Important ports: 53 (UDP)

*In this context, it means the target machine is a local DNS server*
# Domain Name Server

See [[2. Application - DNS]]

```c
www.mail.google.com
└──┬──┘ └──┬──┘ └───┬────┘
   |        |        |
subdomain   |      top-level domain (TLD)
           main domain / second-level domain

```

```c
                Root (.)
                  │
                 htb                ← TLD
                  │
          inlanefreight.htb         ← domain (parent zone)
           ├── app.inlanefreight.htb    ← host (A record)
           ├── mail1.inlanefreight.htb  ← host (A record)
           └── internal.inlanefreight.htb   ← subdomain
                   ├── nc1.internal.inlanefreight.htb  ← host
                   └── db.internal.inlanefreight.htb   ← host

```
# Full DNS Resolution process:
- Check `/etc/hosts`
	- Static local mapping. Even before the local cache
- Then check Local DNS Cache (stored in OS or browser cche)
- Then ask the OS-configured DNS resolver 
	- OS sends query to configured DNS resolver (usually ISP's or public one like 8.8.8.8)
		- this is what is in `/etc/resolv.conf`
- Then recursive Resolution begins
	- a. root server
		- 13 main root servers globally, respond with IP of the TLD server (eg. .com nameserver)
	- b. TLD server (top level domain)
		- returns the IP of the authoritative nameserver for google.come
	- c. authoritative DNS server
		- returns the actual A record (IP address) of google.com

| **Record Type** | **Meaning**                       | **Example**                                |
| --------------- | --------------------------------- | ------------------------------------------ |
| A               | Maps domain to IPv4               | `google.com → 142.250.190.36`              |
| AAAA            | Maps to IPv6                      | `google.com → 2607:f8b0:4005:...`          |
| CNAME           | Canonical name (alias)            | `www.example.com → example.com`            |
| MX              | Mail Exchange                     | `example.com → mail1.example.com`          |
| NS              | Name Servers                      | `example.com → ns1.dnsprovider.com`        |
| TXT             | Misc. text data (e.g., SPF, DKIM) | Used in email security                     |
| PTR             | Reverse lookup (IP → domain)      | `36.190.250.142.in-addr.arpa → google.com` |
| SOA             | Start of Authority                | Info about a DNS zone                      |
FQDN:
`<hostname>.<subdomain>.<second-level domain>.<top level domain>`

DNS usually unencrypted
- over port 53
- anyone on network path (ISP, wifi hotspot etc.) can see which domains are queried, and potentially modify or block the response


Options for encrypting DNS:

| Protocol                 | Transport   | Port | Description                                                      |
| ------------------------ | ----------- | ---- | ---------------------------------------------------------------- |
| **DNS over HTTPS (DoH)** | HTTPS (TCP) | 443  | DNS queries are sent as HTTPS requests (just like browsing).     |
| **DNS over TLS (DoT)**   | TLS (TCP)   | 853  | Encrypted version of DNS using its own port.                     |
| **DoQ (DNS over QUIC)**  | QUIC (UDP)  | 8853 | Fast, encrypted DNS using QUIC. Newer and less widely supported. |
# Zone
- Distinct part of domain namsespace that a specific entity/admin manages
- Is basically a container of DNS records for the part of the hierarchy
- Parent VS Child
	- Parent Zone: higher level zone that contains a record delegating authority to a subdomain
		- eg. `example.com` is parent zone of `dev.example.com`
	- Child zone: lower level zone delegated to another DNS server for independent management
		- eg. `dev.example.com`
- eg, `example.com`, and subdomains `ww.example.com, mail.example.com`
	- All of those names might belong to one zone (example.com), hosted on nameserver `ns1.example.com`
	- But can delegate a part of it, eg. `dev.example.com`, to another server -> child zone
- Zone file
	- text file that resides on DNS server
	- defines resource records withtin the zone, provides info on translating domain name into IP
	- Zone vs Domain
		- Domain: branch of the DNS tree, eg. example.com
		- Zone: part of the DNS tree that a specific DNS server manages
			- Can refer to a domain, but also can cover subdomains or multiple domains depending on config
	- Lists all DNS records for that portion of the DNS namespace
		- SOA (Start of Authority) → metadata about the zone (serial number, refresh interval, etc.).
		- NS (Name Server) → which servers are authoritative for the zone.
		- A / AAAA → hostnames → IP addresses.
		- MX → mail servers.
		- CNAME → aliases.
		- PTR (in reverse zones) → IP → hostname.
	- For Fully Qualified Domain Name (FQDN) to be resolved from IP address, DNS server must have reverse lookup file

```c
DNS Tree (simplified)
.
└─ com
   └─ example.com  (Zone 1)
      ├─ www         (inside Zone 1)
      ├─ ftp         (inside Zone 1)
      └─ dev.example.com  (Zone 2, separate server)
```


# Enumeration
1. Nmap
2. Identify domain from banners/network scope
3. Find authoritative nameserver, esp for parent zone first
	- `dig ns <domain> @<target IP>`
	- this is asking the server at `<target IP>` which name server (ns) is authoritative for inlanefreight.htb
		- this is important because you can only do AXFR on authoritative nameservers
4. Try zone transfer for parent zone
	- `dig axfr <domain> @<authoritative_NS_IP>
		- Might see A records, these are hosts/delegated subdomains/zones defined in the zone
		- eg. app.inlanefreight.htb, dev.inlanefreight.htb
	- Try to transfer each recod
		- `dig axfr app.inlanefreight.htb @ ip`
		- if it works, it means it is a separately delegated zone, and server for that allows zone transfer
	- Basically, recurrent AXFR

|Protocol / Tool|Command / Syntax|Purpose / Notes|
|---|---|---|
|**Nmap (Port Discovery)**|`nmap -p 53 -sU -sV <IP>`|Detects DNS service (UDP/53). Add `-Pn` if ICMP blocked.|
||`nmap --script=dns-* <target>`|Runs NSE scripts (e.g. zone transfer, enumeration, recursion).|
|**Basic DNS Lookup**|`dig <domain>`|Standard DNS A record lookup (maps domain → IP).|
||`nslookup <domain>`|Simpler lookup tool (Windows & Linux).|
||`host <domain>`|Lightweight alternative to `dig`.|
|**Reverse Lookup**|`dig -x <IP>`|Check PTR record (IP → domain). Useful for identifying internal hosts.|
|**Query Specific Record Types**|`dig <domain> MX`|Mail Exchange servers (often internal).|
||`dig <domain> TXT`|Can reveal SPF records, comments, API keys, flags.|
||`dig <domain> NS`|Nameserver records. Identify authoritative DNS servers for possible AXFR.|
||`dig <domain> SOA`|Start of Authority — reveals primary NS and admin contact.|
||`dig <domain> CNAME`|Canonical names (aliases).|
||`dig <domain> ANY`|Query all record types (many servers disable this).|
|**Zone Transfer (AXFR)**|`dig axfr @<ns-server> <domain>`|Attempt full zone transfer (downloads all DNS records). Must target authoritative NS.|
||`host -l <domain> <ns-server>`|Alternate zone transfer attempt (sometimes less filtered).|
||`dnsrecon -d <domain> -t axfr`|Automated AXFR enumeration on all NS records.|
|**Brute Force Subdomains**|`dnsenum <domain>`|Recursive enumeration — subdomains, NS, MX, and tries AXFR.|
||`dnsrecon -d <domain> -D /path/to/wordlist.txt -t brt`|Wordlist-based subdomain brute force.|
||`fierce --domain <domain>`|Classic recon tool for DNS subdomains and misconfigurations.|
|**Check for Zone Walking (NSEC/NSEC3)**|`dnsrecon -d <domain> -t zonewalk`|Exploits DNSSEC misconfigurations to list all domain entries.|
|**Find Hidden Subdomains (Passive)**|`crt.sh/?q=<domain>`|Certificate transparency search — find valid subdomains via SSL certs.|
||`subfinder -d <domain>`|Automated passive + active subdomain enumeration (API-based).|
|**Identify Recursive Queries**|`dig @<target-DNS-IP> <victim-domain>`|If response succeeds, target allows recursion (info disclosure, amplification).|
|**Find Transfer Misconfigurations**|`nmap -p 53 --script=dns-zone-transfer <IP>`|NSE test for zone transfer vulnerability.|
|**Brute-Force DNS with Nmap**|`nmap --script dns-brute --script-args dns-brute.domain=<domain>`|Nmap-based subdomain brute force.|
|**Identify Dynamic DNS Leaks**|`dig version.bind txt chaos @<target>`|Queries the version string of the BIND service (CHAOS class). Useful for vuln fingerprinting.|
|**Check for Wildcard DNS**|`dig doesnotexist.<domain>`|If it still resolves, wildcard DNS is active (can confuse brute force results).|
|**Enumerate via Reverse DNS Sweep**|`for i in $(seq 1 254); do dig -x <IP_base>.$i +short; done`|Reveals hostnames from reverse DNS zones.|
# Zone transfer - Asynchronous Full Transfer Zone (AXFR)
- Is more of replication than 'transfer'
- Transfer of zones to another server in DNS
- Original data of zone on DNS server -> primary name server for this zone
	- But one or more additional servers installed for reliability
		- Secondary name server
- DNS entries generally only created, modified, dleeted on primary
- `dig axfr inlanefreight.htb @10.129.14.128`

# Subdomain brute forcing
- manual
	- ` for sub in $(cat /opt/useful/seclists/Discovery/DNS/subdomains-top1million-110000.txt);do dig $sub.<domain> @<IP> | grep -v ';\|SOA' | sed -r '/^\s*$/d' | grep $sub | tee -a subdomains.txt;done
- dnsenum
	- `dnsenum --dnsserver <IP> --enum -p 0 -s 0 -o subdomains.txt -f /opt/useful/seclists/Discovery/DNS/subdomains-top1million-110000.txt inlanefreight.htb


# Config
Local DNS Config
- `/etc/bind/named.conf.local`
- Different zones defined here
	- Zones divided into individual files
	- Most cases, mainly for one domain only
	- Exceptions: ISP and public DNS servers
- Zone file
	- Text file that describes a DNS zone with the BIND file format

Configuration files
- 3 types
	- Local DNS config files
			- `name.conf.local`
			- `name.conf.options`
			- `name.conf.log`
		- Zone files
		- Reverse name resolution files


Dangerous settings

|**Option**|**Description**|
|---|---|
|`allow-query`|Defines which hosts are allowed to send requests to the DNS server.|
|`allow-recursion`|Defines which hosts are allowed to send recursive requests to the DNS server.|
|`allow-transfer`|Defines which hosts are allowed to receive zone transfers from the DNS server.|
|`zone-statistics`|Collects statistical data of zones.|



Example questions
 + Using the target DNS server’s IP, find the FQDN of the authoritative nameserver for the domain inlanefreight.htb (question was rephrased for clarity)
	 + The IP given is a target DNS server
	 + For the 'inlanefreight.htb' second-level domain, find out the Fully Qualified Domain Names that this DNS server is authoritative for.
	 + `dig NS inlanefreight.htb @DNS_IP`
		 + Ask the DNS server at DNS_IP for the nameserver for this domain.
		 + Ans: ns.inlanefreight.htb
+ Identify if its possible to perform a zone transfer and submit the TXT record as the answer. (Format: HTB{…))
	+ `dig axfr inlanefreight.htb @10.129.247.162`
		+ We see some A records, these are the hosts defined in this zone
		+ app.inlanefreight.htb.
		+ dev.inlanefreight.htb...
		+ etc.
	+ Try to transfer each record, eventually one works
		+ `dig axfr internal.inlanefreight.htb @ip`
			+ This means internal.inlanefreight.htb is in a separately delegated zone, and the server for that allows zone transfer
+  What is the FQDN of the host where the last octet ends with "x.x.x.203"? 
	+ Brute forcing hosts with dnsenum
	+ Try all the subdomains we saw before; app.inlanefreight.htb, ....
	+ `dnsenum --dnsserver 10.129.117.19 --enum -p 0 -s 0 -o subdomains.txt -f /opt/useful/seclists/Discovery/DNS/fierce-hostlist.txt dev.inlanefreight.htb`
		+ Key point: try different wordlists
		+ Subdomain-specific.

Workflow:
- Start with parent zone, eg. `inlanefreight.htb`, then identify authority NS
	- dig NS inlanefreight.htb@target_DNS_IP
- Try zone transfer (AXFR) on parent zone
	- dig AXFR inlanefreight.htb @<authoritative_NS_IP>
	- This gives: hosts in the parent zone (eg. app.inlanefreight.htb), and delegated subdomains/sub-zones (internal, dev)
- Enumerate subzones
	- look for NS records/delegation entries in the parent zone
- Query/AXFR subzones
	- for each subzone found, try
		- dig axfr internal.inlanefreight.htb @ip
- Brute force hosts
	- For subzones, 
		- dns enum --dnsserver <target_ip> dev.inlanefreight.htb
