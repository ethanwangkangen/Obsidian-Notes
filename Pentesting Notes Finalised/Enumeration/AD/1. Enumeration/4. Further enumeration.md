# Enumerating security controls

## Windows Defender
- `Get-MpComputerStatus` 
	- Look for RealTimeProtectionEnabled

## AppLocker
- Microsoft's whitelisting solution
- Common for cmd.exe and PowerShell.exe to be blocked, but can be bypassed
	- eg. PowerShell.exe can be blocked, but there are other PowerShell executable locations like `%SystemRoot%\SysWOW64\WindowsPowerShell\v1.0\powershell.exe` or `PowerShell_ISE.exe.`
- `Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections`

## PowerShell Constrained Language Mode
- Blocks many features needed to use PowerShell effectively
- `$ExecutionContext.SessionState.LanguageMode`

## LAPS
- Microsoft Local Administrator Password Solution
- Used to randomize and rotate local admin passwords on Windows hosts and prevent lateral movement
	- **local** admin, nothing to do with AD
	- Each local machine has an admin account (perhaps with the same name, eg. Administrator by default), but often in reality the same password is used for all admin accounts.
	- LAPS makes the passwords truly unique per machine.
		- Stores passwords in AD so only authorised users can read it
		- So and admin would have to query AD for the computer object, then read `ms-Mcs-AdmPwd` which would be the current local admin password. Then they would log into the local admin account with that password
- We can enumerate what domain users can read the LAPS password set for machines with LAPS installed and what machines do not have LAPS installed
- `Find-LAPSDelegatedGroups`
	- See which groups have bene delegated permission to read LAPS passwords
- `Find-AdmPwdExtendedRights`
	- Checks rights on each computer with LAPS enabled for any groups with read access and users with 'All Extended Rights'
		- The latter can read LAPS passwords, may be less protected
- `Get-LAPSComputers`
	- Search for computers that have LAPS enabled when passwords expire, and even the randomized passwords in cleartext if our user has access

# Credentialed Enumeration from Linux
- Already have foothold in domain, want to dig depeer
- Want info on
	- Domain user and compute attributes
	- Group membership
	- Group Policy Objects
	- ACLs
	- Trusts
	- ..
- But to use the tools below, need valid domain user credentials
	- So minimum need user's cleartext password, NTLM hash or SYSTEM access on domain-joined host

## CrackMapExec (CME)
- Can use with MSSQL, SMB, SSH, WinRM credentials
	- eg.
	- `sudo crackmapeec smb <IP of DC> -u <username> -p <password>`
	- Useful flags for now 
		- -u username
		- -p password
		- Target (IP or FQDN) Target host to enumerate, eg. DC
		- --users to enumerate Domain Users
		- --groups to enumerate domain groups
		- --loggedon-users attemps to enumerate what users are logged on to target, if any
		- --shares to enumerate available shares on remote host, and level of access our user account has to each share (read/write)
			- If find a share worth looking into, add `-M spider_plus=` flag to dig through each readable share and list all readable files
				- Will write output to jason file at `<output>
	- Take note of key groups like Administrators, Domain Admins, Executives
	- If we see 'pwn3d!'
		- Means that the account has local admin rights on that machine
		- DCs dont have separate local SAM, so if pwn3d on a DC, that just means that account is Domain Admin


Explanation of connecting to shares
- Eg. above, the DC (or target host) is the one that hosts the shares, we are trying to authenticate to the SMB service on that host, using domain credentials which are validated via AD
	- If we use username and password with SMB, it tries to authenticate with NTLM instead of kerberos.
## SMBMap
eg. 
- `smbmap -u forend -p Klmcargo2 -d INLANEFREIGHT.LOCAL -H 172.16.5.5`
- Enumerate SMB shares from Linux attack host
- If find an interesting share which is non standard, ie other thatn IPC, NETLOGON and SYSVOL, do recursive listing of directories in this share
	- ` -R 'Department Shares' --dir-only

## RPCClient
- `rpcclient -U "" -N <IP>`
	- Unauthenticated enumeration, if SMB NULL session
	- Take note of Relative Identifier (RID)
		- SID is combined with RID to make a unique value to represent object in a domain
- Enumerate users to gather RIDs
	- `enumdomusers`
- `queryuser 0x456`
	- where 0x457 is RID

## Impacket Suite
### psexec.py
- Need credentials for user with local admin privileges
	- eg. gotten from the password spraying section
- `psexec.py inlanefreight.local/<user>:'<password>'@172.16.5.125  
	- Drops us into system32 dir on target host

### wmiexec.py
- `wmiexec.py inlanefreight.local/<username>:'<password>'@<IP>`

### Windapsearch
- `python3 windapsearch.py --dc-ip 172.16.5.5 -u forend@inlanefreight.local -p Klmcargo2 --da`
	- --da: enumerate domain admins group members
	- -PU: find privileged users
- `-h` for functionalities


## Bloodhound.py
- With domain credentials 
- `bloodhound-python -h`
- `sudo bloodhound-python -u 'forend' -p 'Klmcargo2' -ns 172.16.5.5 -d inlanefreight.local -c all `
	- -ns: DC nameserver 
	- -d: domain name
	- -c all: all checks
	- View results with `ls`
- `sudo neo4j start`


# Windows Enumeration
## AD PowerShell Module
- `Get-Module
	- To check if AD Module imported
- `Import-Module ActiveDirectory`
- `Get-ADDomain`
- `Get-ADUser -Filter {ServicePrincipalName -ne "$null"} -Properties ServicePrincipalName`
	- Get accounts that may be susceptible to Kerberoasting
- `Get-ADTrust -Filter *`
	- Verify domain trust relationships
- `Get-ADGroup -Filter * | select name`
	- Find interesting names, then feed back into cmdlet
- `Get-ADGroup -Identity "Backup Operators"`
- `Get-ADGroupMember -Identity "Backup Operators"
	- To get members belonging to this group
	- Note down: if can take over this service account through some attack, can use its membership in the Backup Operators group to take over the domain
## PowerView
|**Command**|**Description**|
|---|---|
|`Export-PowerViewCSV`|Append results to a CSV file|
|`ConvertTo-SID`|Convert a User or group name to its SID value|
|`Get-DomainSPNTicket`|Requests the Kerberos ticket for a specified Service Principal Name (SPN) account|
|**Domain/LDAP Functions:**||
|`Get-Domain`|Will return the AD object for the current (or specified) domain|
|`Get-DomainController`|Return a list of the Domain Controllers for the specified domain|
|`Get-DomainUser`|Will return all users or specific user objects in AD|
|`Get-DomainComputer`|Will return all computers or specific computer objects in AD|
|`Get-DomainGroup`|Will return all groups or specific group objects in AD|
|`Get-DomainOU`|Search for all or specific OU objects in AD|
|`Find-InterestingDomainAcl`|Finds object ACLs in the domain with modification rights set to non-built in objects|
|`Get-DomainGroupMember`|Will return the members of a specific domain group|
|`Get-DomainFileServer`|Returns a list of servers likely functioning as file servers|
|`Get-DomainDFSShare`|Returns a list of all distributed file systems for the current (or specified) domain|
|**GPO Functions:**||
|`Get-DomainGPO`|Will return all GPOs or specific GPO objects in AD|
|`Get-DomainPolicy`|Returns the default domain policy or the domain controller policy for the current domain|
|**Computer Enumeration Functions:**||
|`Get-NetLocalGroup`|Enumerates local groups on the local or a remote machine|
|`Get-NetLocalGroupMember`|Enumerates members of a specific local group|
|`Get-NetShare`|Returns open shares on the local (or a remote) machine|
|`Get-NetSession`|Will return session information for the local (or a remote) machine|
|`Test-AdminAccess`|Tests if the current user has administrative access to the local (or a remote) machine|
|**Threaded 'Meta'-Functions:**||
|`Find-DomainUserLocation`|Finds machines where specific users are logged in|
|`Find-DomainShare`|Finds reachable shares on domain machines|
|`Find-InterestingDomainShareFile`|Searches for files matching specific criteria on readable shares in the domain|
|`Find-LocalAdminAccess`|Find machines on the local domain where the current user has local administrator access|
|**Domain Trust Functions:**||
|`Get-DomainTrust`|Returns domain trusts for the current domain or a specified domain|
|`Get-ForestTrust`|Returns all forest trusts for the current forest or a specified forest|
|`Get-DomainForeignUser`|Enumerates users who are in groups outside of the user's domain|
|`Get-DomainForeignGroupMember`|Enumerates groups with users outside of the group's domain and returns each foreign member|
|`Get-DomainTrustMapping`|Will enumerate all trusts for the current domain and any others seen.|
- `Get-DomainUser -Identity mmorgan -Domain inlanefreight.local | Select-Object -Property name,samaccountname,description,memberof,whencreated,pwdlastset,lastlogontimestamp,accountexpires,admincount,userprincipalname,serviceprincipalname,useraccountcontrol`
	- Domain user info
- `Get-DomainGroupMember -Identity "Domain Admins" -Recurse
	- Recursive Group membership
- `Get-DomainTrustMapping`
	- Trust enumeration
- `Test-AdminAccess -ComputerName ACADEMY-EA-MS01`
	- Test for local admin access on curent machine or remote one
- `Get-DomainUser -SPN -Properties samaccountname,ServicePrincipalName`

## SharpView
- ` .\SharpView.exe Get-DomainUser -Help`
- `.\SharpHound.exe -c All --zipfilename ILFREIGHT`
	- Then upload to bloodhound
## Shares
### Snaffler
- `Snaffler.exe -s -d inlanefreight.local -o snaffler.log -v data


## Living off the land

### Basic Enumeration Commands

| **Command**                                             | **Result**                                                                                 |
| ------------------------------------------------------- | ------------------------------------------------------------------------------------------ |
| `hostname`                                              | Prints the PC's Name                                                                       |
| `[System.Environment]::OSVersion.Version`               | Prints out the OS version and revision level                                               |
| `wmic qfe get Caption,Description,HotFixID,InstalledOn` | Prints the patches and hotfixes applied to the host                                        |
| `ipconfig /all`                                         | Prints out network adapter state and configurations                                        |
| `set`                                                   | Displays a list of environment variables for the current session (ran from CMD-prompt)     |
| `echo %USERDOMAIN%`                                     | Displays the domain name to which the host belongs (ran from CMD-prompt)                   |
| `echo %logonserver%`                                    | Prints out the name of the Domain controller the host checks in with (ran from CMD-prompt) |
### Host discovery and network info
|**Networking Commands**|**Description**|
|---|---|
|`arp -a`|Lists all known hosts stored in the arp table.|
|`ipconfig /all`|Prints out adapter settings for the host. We can figure out the network segment from here.|
|`route print`|Displays the routing table (IPv4 & IPv6) identifying known networks and layer three routes shared with the host.|
|`netsh advfirewall show allprofiles`|Displays the status of the host's firewall. We can dete|
### Table of Useful Net Commands

|**Command**|**Description**|
|---|---|
|`net accounts`|Information about password requirements|
|`net accounts /domain`|Password and lockout policy|
|`net group /domain`|Information about domain groups|
|`net group "Domain Admins" /domain`|List users with domain admin privileges|
|`net group "domain computers" /domain`|List of PCs connected to the domain|
|`net group "Domain Controllers" /domain`|List PC accounts of domains controllers|
|`net group <domain_group_name> /domain`|User that belongs to the group|
|`net groups /domain`|List of domain groups|
|`net localgroup`|All available groups|
|`net localgroup administrators /domain`|List users that belong to the administrators group inside the domain (the group `Domain Admins` is included here by default)|
|`net localgroup Administrators`|Information about a group (admins)|
|`net localgroup administrators [username] /add`|Add user to administrators|
|`net share`|Check current shares|
|`net user <ACCOUNT_NAME> /domain`|Get information about a user within the domain|
|`net user /domain`|List all users of the domain|
|`net user %username%`|Information about the current user|
|`net use x: \computer\share`|Mount the share locally|
|`net view`|Get a list of computers|
|`net view /all /domain[:domainname]`|Shares on the domains|
|`net view \computer /ALL`|List shares of a computer|
|`net view /domain`|List of PCs of the domain|