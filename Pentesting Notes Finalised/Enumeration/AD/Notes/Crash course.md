## 1. Core Architecture

Active Directory is built on four pillars:

1. Identity (users, computers, service accounts)
    
2. Authentication (Kerberos / NTLM)
    
3. Authorisation (groups + ACLs)
    
4. Replication (Domain Controllers)
    

If you compromise identity or authorisation, you escalate.  
If you compromise replication (Domain Controller), you win.

---

# 2. Domains, Forests, and Trusts

## Domain

A domain is:

- A security boundary
    
- A namespace (e.g. `corp.local`)
    
- A centralised identity store
    

All domain-joined machines trust the Domain Controller.

## Forest

A forest is:

- A collection of domains
    
- Sharing schema and configuration
    

Most OSCP labs use a single-domain forest.

## Trusts

Trusts allow:

- Users in Domain A to access resources in Domain B
    

Types:

- One-way vs two-way
    
- Transitive vs non-transitive
    
- External vs forest trust
    

From an attacker’s perspective:  
Trusts = pivot paths.

---

# 3. Domain Controllers (DC)

A Domain Controller:

- Authenticates users
    
- Stores AD database (NTDS.dit)
    
- Issues Kerberos tickets
    
- Enforces Group Policy
    
- Replicates directory data
    

Critical facts:

- All domain password hashes are stored in NTDS.dit
    
- DC runs LDAP, Kerberos, SMB
    
- Compromising a DC = domain compromise
    

---

# 4. Identity Types

## Local Accounts

- Exist only on one machine
    
- Stored in SAM
    
- Format: `MACHINE\user`
    
- Cannot authenticate to other machines unless reused
    

If you compromise local admin:  
You control one machine only.

Unless passwords are reused.

---

## Domain Accounts

- Stored in AD
    
- Can authenticate to any domain-joined machine
    
- Format: `DOMAIN\user`
    

Types:

- Standard users
    
- Admin users
    
- Service accounts
    
- Computer accounts
    

Domain accounts are what matter in AD attacks.

---

## Computer Accounts

Every domain-joined machine has an account.

Example:

`DC01$`

- Has password
    
- Can authenticate
    
- Has privileges
    

Sometimes abused in delegation attacks.

---

# 5. Groups and Privilege Model

Permissions in AD are group-based.

Users rarely have direct permissions.  
They inherit from groups.

Important built-in groups:

- Domain Users
    
- Domain Admins
    
- Enterprise Admins
    
- Backup Operators
    
- Account Operators
    
- Server Operators
    

Privilege escalation often equals:

Compromised user → find group → escalate via group.

---

# 6. Local Admin vs Domain Admin

## Local Administrator

- Full control over one machine
    
- Can dump SAM
    
- Can read LSASS
    
- Cannot modify AD
    

Useful for lateral movement.

---

## Domain Admin

- Admin on all domain machines
    
- Full AD control
    
- Can:
    
    - Reset any password
        
    - Add users to groups
        
    - Dump NTDS.dit
        
    - Modify GPO
        
    - Persist indefinitely
        

Domain Admin = objective.

---

# 7. Authentication Mechanisms

Two protocols dominate:

## NTLM

- Challenge-response protocol
    
- Hash-based
    
- Used by SMB and legacy systems
    

Attack implications:

- Pass-the-Hash
    
- Relay attacks
    

---

## Kerberos (Most Important)

Ticket-based authentication system.

Components:

- KDC (Key Distribution Center) on DC
    
- TGT (Ticket Granting Ticket)
    
- TGS (Ticket Granting Service)
    
- SPN (Service Principal Name)
    

Kerberos is central to:

- Kerberoasting
    
- AS-REP roasting
    
- Delegation abuse
    
- Golden Ticket attacks
    

---

# 8. Kerberos Authentication Flow

Step 1:  
User logs in.  
Requests TGT from DC.

Step 2:  
DC returns TGT encrypted with user’s password hash.

Step 3:  
User requests service ticket for a service (e.g. MSSQL).

Step 4:  
DC returns service ticket encrypted with service account’s password hash.

This encryption property enables roasting attacks.

---

# 9. Service Principal Names (SPN)

SPN = identifier that maps:

Service → Account

Example:

`MSSQLSvc/sql01.corp.local:1433`

That means:  
The SQL service runs under a specific domain account.

If an account has an SPN:  
You can request a service ticket for it.

That service ticket is encrypted with the account’s password hash.

This enables Kerberoasting.

---

# 10. Kerberoasting (Conceptual)

Prerequisite:  
Authenticated domain user.

Attack:

1. Request service ticket for SPN account.
    
2. Receive ticket encrypted with service account hash.
    
3. Extract hash.
    
4. Crack offline.
    

If cracked:  
You recover service account password.

Service accounts often:

- Have weak passwords
    
- Are privileged
    
- Run critical services
    

This is one of the most common AD attack paths.

---

# 11. AS-REP Roasting

Normal Kerberos requires pre-authentication.

If a user has:  
“Do not require Kerberos preauthentication”

Then:

1. You request authentication.
    
2. DC returns encrypted response.
    
3. Encrypted with user’s password hash.
    
4. Crack offline.
    

No credentials required.

This is misconfiguration-based escalation.

High impact if present.

---

# 12. Delegation

Delegation allows:

A service to act on behalf of a user.

Types:

- Unconstrained Delegation
    
- Constrained Delegation
    
- Resource-Based Constrained Delegation (RBCD)
    

Misconfigured delegation allows:

- Impersonation
    
- Ticket abuse
    
- Privilege escalation
    

Less common in basic OSCP, but critical at higher levels.

---

# 13. Access Control Lists (ACLs)

Every AD object has permissions.

Permissions include:

- GenericAll
    
- GenericWrite
    
- WriteDACL
    
- AddMember
    
- ResetPassword
    

If a user can:

- Modify a group
    
- Add themselves to Domain Admins
    
- Reset DA password
    
- Change ACLs
    

They escalate.

ACL abuse is a primary modern AD attack path.

---

# 14. NTDS.dit

The AD database file stored on DC.

Contains:

- All domain password hashes
    
- All account metadata
    
- All computer account hashes
    

If you dump NTDS:

You have every password hash in the domain.

---

# 15. Group Policy Objects (GPO)

GPOs define:

- Password policy
    
- Login scripts
    
- Software deployment
    
- Security settings
    

Stored in:  
SYSVOL share on DC.

If you can:

- Modify GPO
    
- Write to SYSVOL
    
- Inject malicious script
    

You escalate.

---

# 16. Common AD Attack Themes

Almost all AD compromises fall into:

1. Password reuse
    
2. Kerberoasting
    
3. AS-REP roasting
    
4. Local admin chaining
    
5. ACL abuse
    
6. Delegation abuse
    
7. NTDS dumping
    

If you focus on those seven categories, you cover 90% of exam scenarios.

---