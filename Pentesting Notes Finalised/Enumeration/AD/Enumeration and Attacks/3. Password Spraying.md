# Enumerating Password Policies
- Can get domain password policy in differnet ways

## With Credentials
- With valid domain credentials, can also get pw policy with CrackMapExec or rpcclient
	- `crackmapexec smb 172.16.5.5 -u avazquez -p Password123 --pass-pol`

## Without Credentials
- May obtain via LDAP anonymous bind or SMB NULL session
- SMB NULL session
	- possibly result of legacy DC..
	- allows unauthenticated attacker to get info about domain like listin of users, groups etc.
	- Can enumerate with tools like enum4linux, CrackMapExec, rpcclient
		- `rpcclient -U "" -N <IP>`
			- To check DC for SMB NULL session access
		- `querydominfo`
			- To get information on domain
		- `getdompwinfo`
			- To get password policy
	- Enum4linux
		- `enum4linux -p <IP>`
		- `enum4linux-ng -P <IP> -oA output`
			- For nicer formatting and output as YAML/json
	- Enumeration from Windows
		- `net use \\DC01\ipc$ "" /u:""`
		- First "" is password, then "" is for the username. Can try if have
- LDAP anonymous bind
	- Recall that LDAP is the protocol used by AD for query and responses
	- LDAP anonymous bind = connecting to an LDAP server anonymously
		- In AD, LDAP server is the DC
	- LDAP enumeration tools like windapsearch.py, ldapsearch, ldapdomaindump.py
		- ldapsearch
			- `ldapsearch -h 172.16.5.5 -x -b "DC=INLANEFREIGHT,DC=LOCAL" -s sub "*" | grep -m 1 -B 10 pwdHistoryLength`
	- From Windows
		- Assuming we are on an authenticated Windows host on the domain
		- built-in Windows binary `net.exe`
			- `net accounts`
		- PowerView
			- `import-module .\PowerView.ps1`
			- `Get-DomainPolicy`
		- Or tools like CrackMapExec ported to Windows, SharpMapExec..
# Making Target User List
- Assuming on internal machine
- With valid creds can just query AD for the user info
	- With SYSTEM account can also, since it impersonates computer.
	- Computer is treated as domain user account.
- With out valid creds, look for SMB NULL session or LDAP anon bind on DCs
	- To get list of all users within AD
	- Similar for getting password policy
- SMB NULL session
	- enum4linux
		- `enum4linux -U 172.16.5.5  | grep "user:" | cut -f2 -d"[" | cut -f1 -d"]"`
	- rpcclient
		- `rpccclient -U "" -N <IP>`
		- `enumdomusers`
	- crackmapexec
		- `crackmapexec smb 172.16.5.5 --users`
- LDAP Anonymous
	- ldapsearch
		- `ldapsearch -h 172.16.5.5 -x -b "DC=INLANEFREIGHT,DC=LOCAL" -s sub "(&(objectclass=user))"  | grep sAMAccountName: | cut -f2 -d" "`
			- -x: use simply bind, no Kerberos etc.
			- no -D or -W: anonymous bind
			- -b: where in directory to starch searching
				- INLANEFREIGHT.LOCAL searched
			- -s sub: search base DN and all child objects
			- "(&(objectclass=user))": search filter
	- `./windapsearch.py --dc-ip <IP> -u "" -U`
- Kerbrute Enumeration
	- Uses Kerberos Pre-Authentication
	- Sends TGT requests to DC without Keberos Pre-Authentication. If KDC responds with "PRINCIPAL UNKNOWN", username is invalid. If it asks for Pre-AUth, username exists
	- `kerbrute userenum -d inlanefreight.local --dc 172.16.5.5 /opt/jsmith.txt `

# Build User List with the credentials
- `sudo crackmapexec smb 172.16.5.5 -u htb-student -p Academy_student_AD! --users`