# External Recon

## Things to look for
- IP space
	- Valid ASN for target, netblocks in use for organisation public-facing infrastructure, cloud present and hostig providers, DNS record entries
- Domain Information
	- Administrators? Subdomains? Publicly accessible domain services present (mailservers, DNS, websites..)? Defenses in place?
- Schema format
	- Organisation email accounts, Ad usernames, password policies..
	- To build username list for spraying/brute forcing..
- Data disclosure
	- Publicly accessible files (.pdf, ..) for information on target
		- Eg. usernames, metadata..
- Breach data
	- Publicly released usernames, passwords, other criticall information that can help attacker gain foothold

## Where to look
|                                  |                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| -------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `ASN / IP registrars`            | [IANA](https://www.iana.org/), [arin](https://www.arin.net/) for searching the Americas, [RIPE](https://www.ripe.net/) for searching in Europe, [BGP Toolkit](https://bgp.he.net/)                                                                                                                                                                                                                                               |
| `Domain Registrars & DNS`        | [Domaintools](https://www.domaintools.com/), [PTRArchive](http://ptrarchive.com/), [ICANN](https://lookup.icann.org/lookup), manual DNS record requests against the domain in question or against well known DNS servers, such as `8.8.8.8`. Viewdns.info. nslookup (after getting nameserver)                                                                                                                                   |
| `Social Media`                   | Linkedin, Twitter, Facebook, your region's major social media sites, news articles. [Linkedin2username](https://github.com/initstring/linkedin2username). Google with filters like intext:"@inlanefreight.com", inurl:inlanefreight.com, filetype:pdf                                                                                                                                                                            |
| `Public-Facing Company Websites` | Often, the public website for a corporation will have relevant info embedded. News articles, embedded documents, and the "About Us" and "Contact Us" pages..                                                                                                                                                                                                                                                                     |
| `Cloud & Dev Storage Spaces`     | [GitHub](https://github.com/), [AWS S3 buckets & Azure Blog storage containers](https://grayhatwarfare.com/), [Google searches using "Dorks"](https://www.exploit-db.com/google-hacking-database)                                                                                                                                                                                                                                |
| `Breach Data Sources`            | [HaveIBeenPwned](https://haveibeenpwned.com/) to determine if any corporate email accounts appear in public breach data, [Dehashed](https://www.dehashed.com/) to search for corporate emails with cleartext passwords or hashes we can try to crack offline. Can try these passwords against any exposed login portals (Citrix, RDS, OWA, 0365, VPN, VMware Horizon, custom applications, etc.) that may use AD authentication. |
# Initial Enumeration of the DOmain
## Things to look for
- AD users
- AD joined computers
	- Key copmuters: DC, file servers, SQL servers, web servers, database servers..
- Key services
	- Kereros, NetBIOS, LDAP, DNS
- Vulnerable Hosts and services

## Identifying Hosts
- Wireshark, TCP dump to see hosts and network traffic captured
	- `sudo -E wireshark
	- `sudo tcpdump -i ens224
		- Replace ens224 with whatever the correct interface is
- Responder
	- `sudo responder -I ens224 -A`
- ICMP sweep with Fping
	- `fping -asgq 172.16.5.0/23
		- 172.. being the internal network subnet
			- Can find with `ifconfig` or `ip route` (even better)
		- a: show alive targets
		- s: print stats at end of scan
		- g: generate target list from CIDR network
		- q: not show per-target resuilts

## Further Enumeration
- Nmap
	- Put the hosts in a file, eg. hosts.txt, then run nmap
	- Want to find out what services each host is running
	- Identify critical hosts like DCs and web servers
	- `sudo nmap -v -A -iL hosts.txt
- SMB null/guest checks
	- `smbclient -L //<IP> -N`
		- Look for share names, anonymous access
	- **KIV**
- LDAP anonymous bind 
	- `ldapsearch -x -H ldap://172.16.5.5 -s base`
	- **KIV**
- Kerbrute
	- To enumerate domain accounts
	- Works by sending Kebrerod AS-REQ to domaincontroller, claiming to be ___ user.
	- DC responds with 
		- PREAUTH_REQUIRED -> user exists
		- PRINCIPAL_UNKNOWN -> user does not exist
	- Use wordlists like `jsith.txt` or `jsmith2.txt` from [InsideTrust](https://github.com/insidetrust/statistically-likely-usernames)
	- Steps
		- Clone repo
			- `sudo git clone https://github.com/ropnop/kerbrute.git`
		- List compile options
			- `make help`
		- Compile
			- `sudo make all`
		- List directories
			- `ls dist/
		- Add tool to path
			- `echo $PATH /home/htb-student/.local/bin:/snap/bin:/usr/sandbox/:/usr/local/bin:/usr/bin:/bin:/usr/local/games:/usr/games:/usr/share/games:/usr/local/sbin:/usr/sbin:/sbin:/snap/bin:/usr/local/sbin:/usr/sbin:/sbin:/usr/local/bin:/usr/bin:/bin:/usr/local/games:/usr/games:/home/htb-student/.dotnet/tools`
		- Move to bin 
			- `sudo mv kerbrute_linux_amd64 /usr/local/bin/kerbrute
		- Enumerate
			- `kerbrute userenum -d INLANEFREIGHT.LOCAL --dc 172.16.5.5 jsmith.txt -o valid_ad_users
				- 172.. is IP of the domain controller
				- jsmith.txt is the userlist we god from above
				- -d INLANEFREIHGT.LOCAL is the doain name

## System account
- Local system account `NT AUTHORITY\SYSSTEM` 
	- Built in account in Windows OS (Not part of AD)
	- Highest level of access in OS
	- SYSTEM account on domain-joined host
		- **able to enumerate AD by impersonating the computer account**
			- Remember that in AD there are user accounts and computer accounts.
			- Computer accounts are used by Windows itself (the machine)
			- So if attacker becomes SYSTEM, they control the process that uses it, so can do things like
				- send LDAP queries,
				- ask AD questions
				- receive answers