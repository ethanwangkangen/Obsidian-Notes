# Enumerating security controls

## Windows Defender
- `Get-MpComputerStatus` 
	- Look for RealTimeProtectionEnabled

## AppLocker
- Microsoft's whitelisting solution
- Common for cmd.exe and PowerShell.exe to be blocked, but can be bypassed
	- eg. PowerShell.exe can be blocked, but there are other PowerShell executable locations like `%SystemRoot%\SysWOW64\WindowsPowerShell\v1.0\powershell.exe` or `PowerShell_ISE.exe.`
- `Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections`

## PowerShell Constrained Language Mode
- Blocks many features needed to use PowerShell effectively
- `$ExecutionContext.SessionState.LanguageMode`

## LAPS
- Microsoft Local Administrator Password Solution
- Used to randomize and rotate local admin passwords on Windows hosts and prevent lateral movement
	- **local** admin, nothing to do with AD
	- Each local machine has an admin account (perhaps with the same name, eg. Administrator by default), but often in reality the same password is used for all admin accounts.
	- LAPS makes the passwords truly unique per machine.
		- Stores passwords in AD so only authorised users can read it
		- So and admin would have to query AD for the computer object, then read `ms-Mcs-AdmPwd` which would be the current local admin password. Then they would log into the local admin account with that password
- We can enumerate what domain users can read the LAPS password set for machines with LAPS installed and what machines do not have LAPS installed
- `Find-LAPSDelegatedGroups`
	- See which groups have bene delegated permission to read LAPS passwords
- `Find-AdmPwdExtendedRights`
	- Checks rights on each computer with LAPS enabled for any groups with read access and users with 'All Extended Rights'
		- The latter can read LAPS passwords, may be less protected
- `Get-LAPSComputers`
	- Search for computers that have LAPS enabled when passwords expire, and even the randomized passwords in cleartext if our user has access

# Credentialed Enumeration from Linux
- Already have foothold in domain, want to dig depeer
- Want info on
	- Domain user and compute attributes
	- Group membership
	- Group Policy Objects
	- ACLs
	- Trusts
	- ..
- But to use the tools below, need valid domain user credentials
	- So minimum need user's cleartext password, NTLM hash or SYSTEM access on domain-joined host

## CrackMapExec (CME)
- Can use with MSSQL, SMB, SSH, WinRM credentials
	- eg.
	- `sudo crackmapeec smb <IP of DC> -u <username> -p <password>`
	- Useful flags for now 
		- -u username
		- -p password
		- Target (IP or FQDN) Target host to enumerate, eg. DC
		- --users to enumerate Domain Users
		- --groups to enumerate domain groups
		- --loggedon-users attemps to enumerate what users are logged on to target, if any
		- --shares to enumerate available shares on remote host, and level of access our user account has to each share (read/write)
			- If find a share worth looking into, add `-M spider_plus=` flag to dig through each readable share and list all readable files
				- Will write output to jason file at `<output>
	- Take note of key groups like Administrator,s Domain Admins, Executives


Explanation of connecting to shares
- Eg. above, the DC (or target host) is the one that hosts the shares, we are trying to authenticate to the SMB service on that host, using domain credentials which are validated via AD
	- If we use username and password with SMB, it tries to authenticate with NTLM instead of kerberos.
## SMBMap
eg. 
- `smbmap -u forend -p Klmcargo2 -d INLANEFREIGHT.LOCAL -H 172.16.5.5`
- Enumerate SMB shares from Linux attack host
- If find an interesting share which is non standard, ie other thatn IPC, NETLOGON and SYSVOL, do recursive listing of directories in this share
	- ` -R 'Department Shares' --dir-only

## RPCClient
- `rpcclient -U "" -N <IP>`
	- Unauthenticated enumeration, if SMB NULL session
	- Take note of Relative Identifier (RID)
		- SID is combined with RID to make a unique value to represent object in a domain
- Enumerate users to gather RIDs
	- `enumdomusers`
- `queryuser 0x456`
	- where 0x457 is RID

## Impacket Suite
### psexec.py
- Need credentials for user with local admin privileges
	- eg. gotten from the password spraying section
- `psexec.py inlanefreight.local/<user>:'<password>'@172.16.5.125  
	- Drops us into system32 dir on target host

### wmiexec.py
- `wmiexec.py inlanefreight.local/<username>:'<password>'@<IP>`

### Windapsearch
- `python3 windapsearch.py --dc-ip 172.16.5.5 -u forend@inlanefreight.local -p Klmcargo2 --da`
	- --da: enumerate domain admins group members
	- -PU: find privileged users
- `-h` for functionalities


## Bloodhound.py
- With domain credentials 
- `bloodhound-python -h`
- `sudo bloodhound-python -u 'forend' -p 'Klmcargo2' -ns 172.16.5.5 -d inlanefreight.local -c all `
	- -ns: DC nameserver 
	- -d: domain name
	- -c all: all checks
	- View results with `ls`
- `sudo neo4j start`


# Windows Enumeration
## AD PowerShell Module
- `Get-Module
	- To check if AD Module imported
- `Import-Module ActiveDirectory`
- `Get-ADDomain`
- `Get-ADUser -Filter {ServicePrincipalName -ne "$null"} -Properties ServicePrincipalName`
	- Get accounts that may be susceptible to Kerberoasting
- `Get-ADTrust -Filter *`
	- Verify domain trust relationships
- `Get-ADGroup -Filter * | select name`
	- Find interesting names, then feed back into cmdlet
- `Get-ADGroup -Identity "Backup Operators"`
- `Get-ADGroupMember -Identity "Backup Operators"
	- To get members belonging to this group
	- Note down: if can take over this service account through some attack, can use its membership in the Backup Operators group to take over the domain
- 
