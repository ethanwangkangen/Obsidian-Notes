
Important TCP Ports: 111, 2049
# Network File System
- Same purpose as SMB, but only for Linux/Unix
- Based on ONC-RPC on TCP and UDP ports 111
	- NFS has no authentication, all done by RPC options
		- Most commonly via UNIX UID/GID and group memberships



# Enumeration
1. NMAP
	- `sudo nmap <IP> -p111,2049 -sV --script nfs*
2. List available NFS shares
	- `showmount -e <IP>
3. Mount the share
	- `mkdir target-NFS` //this is the local folder we are using to mount 
	- `sudo mount -t nfs <IP>:/ ./target-NFS/ -o nolock
		- :/ means exported root; asking server for the root of whatever directories it exports
	- `cd target-NFS`
	- `tree .`
4. Listing
	- `ls -l mnt/nfs` : with usernames and group names
	- `ls -n mnt/nfs` : with UIDs and GUIDs

- Notes
	- might need to be root on local machine to access mounted share
	- if root_squash set, cannot edit the backup.sh file even as root
	- can use NFS for further escalation
		- eg. have access to the system via SSH. want to read files from another folder that a specific user can read
			- Need to upload a shell to the NFS share that has the SUID of that user
				- Do this by setting the shell file owner as that user, then enable SUID
			- Then run the shell via the SSH user
				- Will act as the "owner" of the shell
		- Basically, if i run a shell program with SUID set to user1, i can read files that have permissions for user1 to readls

Config: `/etc/exports`

| **Option**         | **Description**                                                                                                                             |
| ------------------ | ------------------------------------------------------------------------------------------------------------------------------------------- |
| `rw`               | Read and write permissions.                                                                                                                 |
| `ro`               | Read only permissions.                                                                                                                      |
| `sync`             | Synchronous data transfer. (A bit slower)                                                                                                   |
| `async`            | Asynchronous data transfer. (A bit faster)                                                                                                  |
| `secure`           | Ports above 1024 will not be used.                                                                                                          |
| `insecure`         | Ports above 1024 will be used.                                                                                                              |
| `no_subtree_check` | This option disables the checking of subdirectory trees.                                                                                    |
| `root_squash`      | Assigns all permissions to files of root UID/GID 0 to the UID/GID of anonymous, which prevents `root` from accessing files on an NFS mount. |
How to share:
```c
root@nfs:~# echo '/mnt/nfs  10.129.14.0/24(sync,no_subtree_check)' >> /etc/exports
root@nfs:~# systemctl restart nfs-kernel-server 
root@nfs:~# exportfs

```
- Shared the folder /mnt/nfs to the subnet 10.129.14.0/24

Dangerous settings

| **Option**       | **Description**                                                                                                                                      |
| ---------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------- |
| `rw`             | Read and write permissions.                                                                                                                          |
| `insecure`       | Ports above 1024 will be used.<br>The first 1024 ports can only be used by root, but this setting allows users to use to use sockets above port 1024 |
| `nohide`         | If another file system was mounted below an exported directory, this directory is exported by its own exports entry.                                 |
| `no_root_squash` | All files created by root are kept with the UID/GID 0.                                                                                               |

Authentication
- Uses UIDs and GUIDs 
	- These are local by default. Live in `/etc/passwd and /etc/group`
	- So what if 'ethan' and 'alice' both have the same UID on diff PCs?
- Solution: NFS assumes client and server share the same UID/GUID scheme
	- eg. Active directory
	- so UID 1000 is really the same person everywhere
	- However still insecure
	- NSFv4 +Kerberos fixes this.
- To prevent abuse: root_squash
	- If client connects as root (UID 0), squashed to nobody
		- ie. so client's root cannot act as server's root
		- to prevent someone with root on any client deleting or chown files on the server

