Main components
- Remote Desktop Protocol (RDP)
- Windows Remote Management (WinRM)
- Windows Management Instrumentation (WMI)

For WinRM, RDP, see [[3. Online cracking - WinRM, SSH, RDP, SMB]]

# RDP
- Important ports
	- TCP 3389, can use UDP too
- For remote access to computer running Windows OS
- For RDP session, both network firewall and firewall of server must allow connections from outside
	- If Network Address Translation (NAT) used on route between client and server, remote needs the public IP address to reach the server, and port forwarding must be set up on the NAT router
- TLS/SSL available, but many Windows systems do not insist on this, accept inadequate encryption via RDP security
	- Even with TLS, identity-proving certs are self-signed, so can forge
- Remote Desktop service installed by default on Windows servers
	- Activated by Server Manager
	- By default allows connections to service only to hosts with Network Level Authentication (NLA)

Scanning
- `nmap -sV -sC ip -p 3389 --script rdp*`
- with --packet-trace
	- can see individual packages and contents
	- see that RSP cookies (mstshash=nmap) used by Nmap to interact with RDP server can be identified by threat hunters and various security services like Endpoint Detection and Response (EDR)
		- lock us out
- rdp-sec-check.pl
	- `sudo cpan`
	- `git clone https://github.com/CiscoCXSecurity/rdp-sec-check.git && cd rdp-sec-check`
	- `./rdp-sec-check.pl 10.129.201.248`

Authentication and connection to RSP servers
- xfreedp
	- `xfreerdp /u:cry0l1t3 /p:"P455w0rd!" /v:10.129.201.248`
- rdesktop
- Remmina


# WinRM
- Important ports
	- 5985, 5986 (https)
	- uses Simply Object Access Protocol (SOAP) to establish connections to remote hosts and their applcations
- Windows Remote Shell (WinRS)
	- Allows execution of arbitrary commands on remote system
- Scanning
	- nmap
	- can check if one or more remote servers can be reached via WinRM with PowerShell
		- Test-WsMan cmdlset
		- For Linux: evil-winrm
			- `evil-winrm -i 10.129.201.248 -u Cry0l1t3 -p P455w0rD!



# WMI
- Important ports
	- 135
- Implementation/extension of Common Information odel (CIM)
- Allows read and write access to almost all settings on Windows systems

Footprinting
- Initialisation of WMI communication always on 135, then moved to random port
	- `/usr/share/doc/python3-impacket/examples/wmiexec.py Cry0l1t3:"P455w0rD!"@10.129.201.248 "hostname"



| Protocol / Tool                                    | Command / Syntax                                                                                                              | Purpose                                                                                                                                | Notes                                                                                                |
| -------------------------------------------------- | :---------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------- |
| RDP — Windows native client                        | `mstsc /v:HOST[:PORT]`                                                                                                        | Open RDP session to host (GUI).                                                                                                        | Default port **3389**. Use `mstsc /admin` for console session.                                       |
| RDP — save/connect file                            | `mstsc my.rdp` (create via GUI Save)                                                                                          | Reuse connection settings (credentials, resolution).                                                                                   | .rdp file is editable plain text.                                                                    |
| RDP — Linux client (FreeRDP)                       | `xfreerdp /u:USER /p:PASS /v:HOST[:PORT] /cert-ignore`                                                                        | Connect from Linux to RDP host.                                                                                                        | ` /cert-ignore` disables cert checks (use carefully). Add `/clipboard` to share clipboard.           |
| RDP — rdesktop (older)                             | `rdesktop -u user -p pass host`                                                                                               | Alternative Linux RDP client (legacy).                                                                                                 | rdesktop lacks some modern features; FreeRDP preferred.                                              |
| RDP — list sessions / connect to console (Windows) | `qwinsta` / `rwinsta <ID>` / `tscon <sessionid> /dest:console`                                                                | Query / kill / attach sessions.                                                                                                        | Requires appropriate privileges.                                                                     |
| WinRM — enable local (Windows)                     | `winrm quickconfig` or PowerShell `Enable-PSRemoting -Force`                                                                  | Configure WinRM listener and firewall rules.                                                                                           | `winrm quickconfig` prompts to enable. `Enable-PSRemoting` is canonical.                             |
| WinRM — HTTP listener port                         | `winrm enumerate winrm/config/Listener`                                                                                       | Show listeners (5985 HTTP, 5986 HTTPS).                                                                                                | Use HTTPS (5986) in production.                                                                      |
| WinRM — test from Linux (Kerberos/NTLM)            | `evil-winrm -i HOST -u USER -p PASS`                                                                                          | Interactive WinRM shell (post-exploitation tool).                                                                                      | `evil-winrm` uses WinRM (PowerShell remoting) over HTTP/HTTPS.                                       |
| WinRM — PowerShell remoting (interactive)          | `Enter-PSSession -ComputerName HOST -Credential (Get-Credential)`                                                             | Start interactive remote PowerShell session.                                                                                           | Requires WinRM on target and appropriate creds.                                                      |
| WinRM — PowerShell remoting (run a command)        | `Invoke-Command -ComputerName HOST -ScriptBlock { whoami } -Credential $cred`                                                 | Execute PowerShell remotely.                                                                                                           | Use `-Authentication Kerberos` for domain auth if needed.                                            |
| WinRM — WinRS (legacy)                             | `winrs -r:HOST -u:USER -p:PASS "ipconfig /all"`                                                                               | Run single command via WinRM.                                                                                                          | Simpler but less featureful than PowerShell remoting.                                                |
| WMI — wmic (legacy CLI)                            | `wmic /node:HOST /user:USER /password:PASS process call create "cmd.exe /c whoami > C:\temp\o.txt"`                           | Remote command execution via WMI (creates process).                                                                                    | WMI uses DCOM / RPC; requires open ports and privileges.                                             |
| WMI — PowerShell (Get-WmiObject)                   | `Get-WmiObject -Class Win32_Process -ComputerName HOST -Credential $cred`                                                     | Query processes, services, hardware via WMI.                                                                                           | `Get-CimInstance` is the newer replacement (WS-Man).                                                 |
| WMI — PowerShell create process                    | `Invoke-WmiMethod -Class Win32_Process -Name Create -ArgumentList "cmd.exe /c calc.exe" -ComputerName HOST -Credential $cred` | Start a process remotely via WMI.                                                                                                      | This runs under SYSTEM if using appropriate privileges.                                              |
| WMI — Impacket `wmiexec.py`                        | `python3 wmiexec.py DOMAIN/USER:PASS@HOST`                                                                                    | Execute commands via WMI; outputs command results.                                                                                     | Useful from Linux for quick remote execution (NTLM auth).                                            |
| WMI — Impacket `smbexec.py`                        | `python3 smbexec.py USER:PASS@HOST`                                                                                           | Alternate remote execute using SMB+RPC.                                                                                                | Writes payload as service or uses SMB shares.                                                        |
| General — firewall / ports                         | —                                                                                                                             | RDP: TCP **3389**. WinRM: TCP **5985** (HTTP), **5986** (HTTPS). WMI/DCOM: TCP **135** + dynamic RPC high ports (usually 49152–65535). | If ports blocked, tunnelling (SSH, pivot) or SMB/HTTP-based alternatives required.                   |
| Authentication notes                               | —                                                                                                                             | RDP: RDP auth / NLA (CredSSP). WinRM: Kerberos/NTLM; WMI: DCOM/NTLM/Kerberos.                                                          | NLA requires valid credentials before session establishes. Pass-the-Hash & delegation caveats apply. |
| File transfer via WinRM                            | `Enter-PSSession` then `Set-Content` / `Copy-Item -ToSession`                                                                 | Copy files using PSRemoting session.                                                                                                   | Or use `Invoke-Command` + `Out-File` / `bitsadmin`/`certutil` if needed.                             |
