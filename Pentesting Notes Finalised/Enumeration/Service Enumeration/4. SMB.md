Important ports: TCP 445 (modern direct host connection), 139 (older NetBIOS session over TCP/IP)
# Server Message Block
- Network file sharing protocol
- Windows' version of NFS

# RPCClient
- Command line tool (from Samba) that lets a Linux box speak Microsoft RPC calls tver SMB to windows host

# Enumeration
1. Nmap Scan
	- `nmap -p 139,445 -sV --script=smb* <IP>`
2. Anonymous enumeration
	- `smbclient -L //<IP> -N`
		- list shares anonymously
		- try to connect to a share
		- `smbclient //<IP>/share -U <user>`, -N if anon
			- then download with `get <file>`
	- `rpcclient -U "" <IP>`
		- see if can connect via RPC anonymously
		- `enumdomains`
		- `enumdomusers`
			- get usernames + RIDs
			- then query users individually
				- `queryuser [rid]`
			- then can see their groups' RID, then query group
				- `querygroup [rid]`
3. Brute force usernames and RIDs
	- `for i in $(seq 500 1100);do rpcclient -N -U "" 10.129.14.128 -c "queryuser 0x$(printf '%x\n' $i)" | grep "User Name\|user_rid\|group_rid" && echo "";done
	- `samrdump.py <IP>`
4. Check guest access
	- `smbmap -H <IP> -u guest -p ""`
5. If SMBv1
	- check `--script smb-vuln-ms17-010` - potential RCE
6. With collected users, put into a list and bruteforce 
	- `hydra -L users.txt -P <wordlist.txt> smb://<IP>
7. Enumerate shares if foud a password from above
	- `netexec <IP> -u "user" -p "password" --shares`
8. Other enumations (KIV)
	- crackmap exec
		- `crackmapexec smb 10.129.14.128 --shares -u '' -p ''`
	- smbmap
		- `smbmap -H 10.129.14.129`
	- Enum4linux-ng
		- `git clone https://github.com/cddmp/enum4linux-ng.git`
		- `cd enum4linux-ng`
		- `pip3 install -r requirements.txt`
		- `./enum4linux-ng.py 10.129.14.128 -A`
9. Can also do spraying with netecev, if have a password in mind and want to spray usernames
	- See [[4. Spraying, Stuffing, Defaults]]


| **Protocol / Tool**        | **Command / Syntax**                                                                                                        | **Purpose / Notes**                                   |
| -------------------------- | --------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------- |
| **SMBclient**              | `smbclient -L //<IP> -U <user>`                                                                                             | List all shares on target (use `-N` for anonymous)    |
|                            | `smbclient //<IP>/<share> -U <user>`                                                                                        | Connect to a specific share                           |
|                            | `smbclient //<IP>/<share> -N`                                                                                               | Connect anonymously                                   |
|                            | `ls`                                                                                                                        | List files/directories in the share                   |
|                            | `cd <dir>`                                                                                                                  | Change directory inside the share                     |
|                            | `get <file>`                                                                                                                | Download file from share                              |
|                            | `mget <files>`                                                                                                              | Download multiple files                               |
|                            | `put <file>`                                                                                                                | Upload file to share (if writable)                    |
|                            | `mput <files>`                                                                                                              | Upload multiple files                                 |
|                            | `!<cmd>`                                                                                                                    | Run local system commands without leaving SMBclient   |
|                            | `help`                                                                                                                      | List all available SMBclient commands                 |
| **Nmap SMB scripts**       | `nmap -p 139,445 -sV --script=smb* <IP>`                                                                                    | Enumerate shares, users, info with NSE scripts        |
| **RPC / rpcclient**        | `rpcclient -U "" <IP>`                                                                                                      | Connect via RPC (null session/anonymous)              |
|                            | `rpcclient -U 'DOMAIN\\user%pass' IP`                                                                                       | Connect via RPC (with creds)                          |
|                            | `srvinfo`                                                                                                                   | Get server info (OS, version, server type)            |
|                            | `enumdomains`                                                                                                               | List domains/workgroups on server                     |
|                            | `querydominfo`                                                                                                              | Get domain info (users, groups, roles)                |
|                            | `netshareenumall`                                                                                                           | List all shares via RPC                               |
|                            | `netsharegetinfo <share>`                                                                                                   | Get detailed info about a share                       |
|                            | `enumdomusers`                                                                                                              | Enumerate all domain users                            |
|                            | `queryuser <RID>`                                                                                                           | Get info about a specific user                        |
|                            | `querygroup <RID>`                                                                                                          | Get info about a group                                |
|                            | **Bash RID brute-force**: `for i in $(seq 500 1100); do rpcclient -N -U "" <IP> -c "queryuser 0x$(printf '%x\n' $i)"; done` | Enumerate users if RIDs unknown                       |
| **Impacket / samrdump.py** | `samrdump.py <IP>`                                                                                                          | Enumerate users via RPC remotely                      |
| **SMBMap**                 | `smbmap -H <IP>`                                                                                                            | Enumerate shares and permissions                      |
| **CrackMapExec (CME)**     | `crackmapexec smb <IP> --shares -u '' -p ''`                                                                                | Enumerate shares with anonymous/null login            |
| **Enum4Linux-ng**          | `./enum4linux-ng.py <IP> -A`                                                                                                | Automated SMB/RPC enumeration, users, shares, OS info |
|                            |                                                                                                                             |                                                       |


Config file in `/etc/samba/smb.conf`


| **Setting**                    | **Description**                                                       |
| ------------------------------ | --------------------------------------------------------------------- |
| `[sharename]`                  | The name of the network share.                                        |
| `workgroup = WORKGROUP/DOMAIN` | Workgroup that will appear when clients query.                        |
| `path = /path/here/`           | The directory to which user is to be given access.                    |
| `server string = STRING`       | The string that will show up when a connection is initiated.          |
| `unix password sync = yes`     | Synchronize the UNIX password with the SMB password?                  |
| `usershare allow guests = yes` | Allow non-authenticated users to access defined share?                |
| `map to guest = bad user`      | What to do when a user login request doesn't match a valid UNIX user? |
| `browseable = yes`             | Should this share be shown in the list of available shares?           |
| `guest ok = yes`               | Allow connecting to the service without using a password?             |
| `read only = yes`              | Allow users to read files only?                                       |
| `create mask = 0700`           | What permissions need to be set for newly created files?              |
Dangerous settings:

| **Setting**                 | **Description**                                                     |
| --------------------------- | ------------------------------------------------------------------- |
| `browseable = yes`          | Allow listing available shares in the current share?                |
| `read only = no`            | Forbid the creation and modification of files?                      |
| `writable = yes`            | Allow users to create and modify files?                             |
| `guest ok = yes`            | Allow connecting to the service without using a password?           |
| `enable privileges = yes`   | Honor privileges assigned to specific SID?                          |
| `create mask = 0777`        | What permissions must be assigned to the newly created files?       |
| `directory mask = 0777`     | What permissions must be assigned to the newly created directories? |
| `logon script = script.sh`  | What script needs to be executed on the user's login?               |
| `magic script = script.sh`  | Which script should be executed when the script gets closed?        |
| `magic output = script.out` | Where the output of the magic script needs to be stored?            |

