# SSH
- Standard port 22
- OpenSSH, SSH-1 and SSH-2
- OpenSSH has 6 different authentication methods
	- Password
	- Public-key
	- Host-based
	- Keyboard
	- Challenge-response
	- GSSAPI

See [[3. Online cracking - WinRM, SSH, RDP, SMB]]

# Public key authentication
- SSH server and client authenticate
	- Server send **public host key** to client -> client use to verify identity of server
		- Attacker not able to imitate, since PKI is secure
	- Server authenticated, client's turn
		- Password?
		- Private key also can.
			- Server sends crypto problem with client's public key to client, then client decrypts it with private key, sends back solution, informing server it may establish legit connection

| Protocol / Tool                   | Command / Syntax                                     | Purpose / Notes                                                    |
| --------------------------------- | ---------------------------------------------------- | ------------------------------------------------------------------ |
| **SSH**                           | `ssh user@host`                                      | Basic SSH login with default key/password.                         |
|                                   | `ssh -p 2222 user@host`                              | Connect to non-standard port (2222).                               |
|                                   | `ssh -i key.pem user@host`                           | Use specific private key for authentication.                       |
|                                   | `ssh -v user@host`                                   | Verbose output for debugging (use `-vv` / `-vvv` for more detail). |
|                                   | `ssh -o PreferredAuthentications=password user@host` | Force password-based authentication.                               |
|                                   | `ssh -L 8080:localhost:80 user@host`                 | Local port forward → access remote service on localhost.           |
|                                   | `ssh -R 9000:localhost:22 user@host`                 | Remote port forward → expose local service to remote.              |
|                                   | `ssh -D 1080 user@host`                              | Dynamic port forward (SOCKS proxy).                                |
|                                   | `scp file.txt user@host:/tmp/`                       | Copy file to remote host via SSH.                                  |
|                                   | `scp user@host:/etc/passwd ./`                       | Copy file from remote host to local.                               |
|                                   | `sftp user@host`                                     | Interactive file transfer over SSH.                                |
| **Rsync (local/remote sync)**     | `rsync -avz file.txt /backup/`                       | Sync file locally (`-a` archive, `-v` verbose, `-z` compress).     |
|                                   | `rsync -avz dir1/ dir2/`                             | Sync directories locally.                                          |
| **Rsync over SSH**                | `rsync -avz file.txt user@host:/tmp/`                | Sync file to remote host over SSH (default).                       |
|                                   | `rsync -avz -e "ssh -p 2222" dir/ user@host:/data/`  | Use SSH on custom port.                                            |
|                                   | `rsync --progress file.iso user@host:/mnt/`          | Show transfer progress.                                            |
| **R-services (legacy, insecure)** | `rlogin host -l user`                                | Remote login (like telnet, unencrypted).                           |
|                                   | `rsh host command`                                   | Execute a single command on remote host.                           |
|                                   | `rcp file.txt host:/tmp/`                            | Copy file to remote host.                                          |
|                                   | `rexec -l user -p pass host command`                 | Execute command remotely with username/password.                   |
| **Other relevant**                | `ssh-copy-id user@host`                              | Copy local public key to remote `authorized_keys`.                 |
|                                   | `ssh-keygen -t rsa -b 4096`                          | Generate SSH keypair.                                              |
|                                   | `ssh-agent bash && ssh-add key.pem`                  | Load private key into agent.                                       |
|                                   | `netstat -tulnp                                      | grep ssh`                                                          |
|                                   | `systemctl status sshd`                              | Check SSH service status (Linux systemd).                          |

# Default config
- `cat /etc/ssh/sshd_config  | grep -v "#" | sed -r '/^\s*$/d'`

Dangerous Settings

|**Setting**|**Description**|
|---|---|
|`PasswordAuthentication yes`|Allows password-based authentication.|
|`PermitEmptyPasswords yes`|Allows the use of empty passwords.|
|`PermitRootLogin yes`|Allows to log in as the root user.|
|`Protocol 1`|Uses an outdated version of encryption.|
|`X11Forwarding yes`|Allows X11 forwarding for GUI applications.|
|`AllowTcpForwarding yes`|Allows forwarding of TCP ports.|
|`PermitTunnel`|Allows tunneling.|
|`DebianBanner yes`|Displays a specific banner when logging in.|
- Allowing password authentication allows brute-forcing a known username for possible passwords

Footprinting
- ssh-audit
	- `git clone https://github.com/jtesta/ssh-audit.git && cd ssh-audit`
	- `./ssh-audit.py 10.129.14.132`
- Change authentication method
	- See current authentications
		- `ssh -v user@ip`
	- For potential brute-force attacks, can specify authentication method with SSH client option PreferredAuthentications
		- `ssh -v user@ip -o PreferredAuthentications=password`

# Rsync
- Important ports
	- 873
- Can be configured to use SSH for secure file transfers by piggybacking on top of established SSH server connection
- Scanning
	- `sudo nmap -sV -p 873 127.0.0.1`
- Probing 
	- `nc -nv 127.0.0.1 873`
		- will show available shares, eg. dev
- Enumerating open share
	- `rsync -av --list-only rsync://127.0.0.1/dev`

# R-Services
- Important ports
	- 512, 513, 514
- Fore remote access between Unix Operating Systems, before SSH took over
- R-Commands suite
	- rcp (`remote copy`)
	- rexec (`remote execution`)
	- rlogin (`remote login`)
	- rsh (`remote shell`)
	- rstat
	- ruptime
	- rwho (`remote who`)

| **Command** | **Service Daemon** | **Port** | **Transport Protocol** | **Description**                                                                                                                                                                                                                                                            |
| ----------- | ------------------ | -------- | ---------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `rcp`       | `rshd`             | 514      | TCP                    | Copy a file or directory bidirectionally from the local system to the remote system (or vice versa) or from one remote system to another. It works like the `cp` command on Linux but provides `no warning to the user for overwriting existing files on a system`.        |
| `rsh`       | `rshd`             | 514      | TCP                    | Opens a shell on a remote machine without a login procedure. Relies upon the trusted entries in the `/etc/hosts.equiv` and `.rhosts` files for validation.                                                                                                                 |
| `rexec`     | `rexecd`           | 512      | TCP                    | Enables a user to run shell commands on a remote machine. Requires authentication through the use of a `username` and `password` through an unencrypted network socket. Authentication is overridden by the trusted entries in the `/etc/hosts.equiv` and `.rhosts` files. |
| `rlogin`    | `rlogind`          | 513      | TCP                    | Enables a user to log in to a remote host over the network. It works similarly to `telnet` but can only connect to Unix-like hosts. Authentication is overridden by the trusted entries in the `/etc/hosts.equiv` and `.rhosts` files.                                     |

Danger of r-services
- issues regarding access control for these protocols
- r-services rely on trusted info sent form remote client to host machine they are attempting to authenticate to
	- by default, use Pluggable Authentication Modules (PAM) for user authentication onto remote
	- BUT bypass authentication through use of **/etc/hosts.equiv** and **.rhosts** files on system
		- /etc/hosts.equiv
			- global configuration regarding al users on a system
			- list of trusted hosts
			- used to grant access to other systems on the network
			- when users on one of these hosts attempts to access the system, automatically granted access without further authentication
		- ./rhosts
			- pre-user configuration

/etc/hosts.equiv and ./rhosts files
- Syntax
	- `<username> <ip address> or`
	- `<username <hostname>`
	- + modifier can be used to specify anything
		- eg + +  -> any user from any host can log in without a password

Logging in
- `rlogin 10.0.17.2 -l htb-student`
- Then can abuse the rwho command to list all interactive sessions on local network by sending requests to UDP port 513
	- `rwho`
		- can see which hosts are logged in to which users
		- can use this to advantage when scoping out potential usernames to user during furhter attacks on hosts over network
- More information on authenticated users
	- `rusers -al 10.0.1.502`
