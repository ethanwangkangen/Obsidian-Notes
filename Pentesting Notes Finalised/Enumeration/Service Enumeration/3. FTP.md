Important ports: 20, 21, 990 for FTPS

*SFTP is not related to FTP, is a subset of SSH. FTP over SSL is FTPS

# File Transfer Protocol
- How it works
	- Both client server establish control channel through a TCP port 21 on the server
	- Then establish data channel via a different TCP port 20, used for data transmission
- Active vs Passive
	- Active: 
		- Client listens on a TCP port (ephemeral) and tells server which IP/port to connect to with the `PORT h1,h2,h3,h4,p1,p2` command.
		- Server initiates the data connection back to the client.
		- Problem on modern networks: client-side firewalls/NAT often block incoming connections → active mode often fails on clients behind NAT.
	- Passive:
		- Client sends `PASV`; server responds `227 Entering Passive Mode (h1,h2,h3,h4,p1,p2)`.
		- Client then connects to server IP:port (p1*256 + p2) for the data connection.
		- Common for NAT/firewalled clients — server opens ephemeral port(s) for data; server must allow or be configured with a passive port range.
- Anonymous ftp
	- Usually need credentials, but anon lets server operator allow any user to upload or download via FTP without password


# Enumeration Steps
1. Banner grabbing
	- `nc -nv <IP> 21`
	- Note this is raw TCP channel, can't use commands here
2. Anonymous login test
	- `ftp <IP> <port>`
	- `USER anonymous`
	- `PASS anything@domain.com`
	- or
	- `curl -v ftp://anonymous@IP/`
	- `nmap --script ftp-anon -p21 <IP>`
	- if FTPS, need openssl client
		- `openssl s_client -connect <IP>:21 -starttls ftp`
	- Note: sometimes `USER anonymous` may not work (eg. if connected to FTP proxy). Try just `anonymous`
3. Directory listing, file download etc.
	- `LIST`
		- If don't work, try `ls`
	- `wget ftp://user:pass@IP/(path)`
		- try with `-m` and `--no-passive-ftp`
		- `-m`: download the whole directory
		- `--no-passive-ftp`: forces active ftp mode
4. Writable directories/upload test
	- Try `STOR` or `PUT` to see if anon/low privileged user can upload
		- IF allowed and webroot is writable (common misconfiguration), upload a webshell
5. Brute-force/credential stuffing
	- `hydra -l username -P passlist ftp://target`
	- Weak/default accounts, resuse credentials..
6. Check FTP features and commands
	- `FEAT` for supported extensions
	- `SYST` to get OS type
	- `STAT`, `SITE` - SITE can reveal server-specific admin commands
7. Check for FXP/FTP bounce
	- `PORT` and `PASV` misuse can allow server-to-server file transfer (FXP) or bouncing — modern servers usually disable bounce, but worth testing.
8. Look for backup/credentials
	- Common filenames: `backup.tar`, `.ftpconfig`, `.htpasswd`, `id_rsa`, `config.php`, `.env`.
	- Search recursively; use `wget --recursive` if allowed.
9. Identify known vuln software
	- Banner/version → check exploit-db / searchsploit for known CVEs (e.g. vsftpd 2.3.4 backdoor).
	- Use searchsploit vsftpd etc. (You must handle responsibly and with lab permission.)
# FTPS (FTP over TLS/SSL)
- Explicit FTPS: client connects to port 21 then upgrades control channel to TLS via `AUTH TLS

# TFTP
- Trivial FTP
	- No user authentication
	- UDP

Default: vsFTPD
- default config in /etc/vsftpd.conf
- Also, /etc/ftpusers -> used to deny certain users access to the ftp service
- Dangerous settings
	- Optional settings that can be added to config file for anon login
	- For vsftpd, these are

| **Setting**                    | **Description**                                                                    |
| ------------------------------ | ---------------------------------------------------------------------------------- |
| `anonymous_enable=YES`         | Allowing anonymous login?                                                          |
| `anon_upload_enable=YES`       | Allowing anonymous to upload files?                                                |
| `anon_mkdir_write_enable=YES`  | Allowing anonymous to create new directories?                                      |
| `no_anon_password=YES`         | Do not ask anonymous for password?                                                 |
| `anon_root=/home/username/ftp` | Directory for anonymous.                                                           |
| `write_enable=YES`             | Allow the usage of FTP commands: STOR, DELE, RNFR, RNTO, MKD, RMD, APPE, and SITE? |
|                                |                                                                                    |
Other settings?

| **Setting**               | **Description**                                                                  |
| ------------------------- | -------------------------------------------------------------------------------- |
| `dirmessage_enable=YES`   | Show a message when they first enter a new directory?                            |
| `chown_uploads=YES`       | Change ownership of anonymously uploaded files?                                  |
| `chown_username=username` | User who is given ownership of anonymously uploaded files.                       |
| `local_enable=YES`        | Enable local users to login?                                                     |
| `chroot_local_user=YES`   | Place local users into their home directory?                                     |
| `chroot_list_enable=YES`  | Use a list of local users that will be placed in their home directory?           |
| `hide_ids=YES`            | All user and group information in directory listings will be displayed as "ftp". |
| `ls_recurse_enable=YES`   | Allows the use of recurse listings.                                              |



| Category                         | Command / Example                                      | Description                                           |
| -------------------------------- | ------------------------------------------------------ | ----------------------------------------------------- |
| **Connect / Login**              | `ftp <IP> <port>`                                      | Start FTP client session to target                    |
|                                  | `USER <username>`                                      | Provide username (e.g., anonymous)                    |
|                                  | `PASS <password>`                                      | Provide password (any for anonymous)                  |
|                                  | `QUIT`                                                 | Exit session                                          |
| **Modes**                        | `TYPE I`                                               | Binary mode (default for files)                       |
|                                  | `TYPE A`                                               | ASCII mode (text)                                     |
| **Passive / Active**             | `passive`                                              | Enable passive mode (firewall friendly)               |
|                                  | `quote PASV`                                           | Ask server for passive port                           |
|                                  | `PORT h1,h2,h3,h4,p1,p2`                               | Active mode (server connects back)                    |
| **Directory / Listing**          | `PWD`                                                  | Show current remote directory                         |
|                                  | `CWD /path/`                                           | Change remote directory                               |
|                                  | `LS -al`                                               | List files/directories                                |
|                                  | `LS -R`                                                | Recursive listing (if server allows)                  |
|                                  | `NLST`                                                 | Names-only listing                                    |
|                                  | `MLSD`                                                 | Machine-readable listing                              |
| **File Transfer**                | `GET file.txt`                                         | Download file                                         |
|                                  | `PUT file.txt`                                         | Upload file                                           |
|                                  | `APPE file.txt`                                        | Append to remote file                                 |
|                                  | `REST <offset>`                                        | Resume from byte offset                               |
|                                  | `mirror /remote /local`                                | Mirror directories (e.g., wget -m or lftp)            |
| **File Management**              | `DELE file.txt`                                        | Delete remote file                                    |
|                                  | `RNFR old.txt`                                         | Rename from (step 1)                                  |
|                                  | `RNTO new.txt`                                         | Rename to (step 2)                                    |
|                                  | `MKD newdir`                                           | Make directory                                        |
|                                  | `RMD olddir`                                           | Remove directory                                      |
| **Metadata / Info**              | `SIZE file.txt`                                        | Show file size                                        |
|                                  | `MDTM file.txt`                                        | Show last modified time                               |
|                                  | `STAT`                                                 | Show server/session status (ftp-syst)                 |
|                                  | `HELP`                                                 | Show help/commands                                    |
|                                  | `DEBUG`                                                | Enable debug mode (shows commands sent)               |
|                                  | `TRACE`                                                | Packet tracing for commands                           |
| **Security / Encryption**        | `AUTH TLS`                                             | Start explicit TLS (FTPS)                             |
|                                  | `PBSZ 0`                                               | Protection buffer (after TLS)                         |
|                                  | `PROT P`                                               | Protect data channel (encrypt)                        |
|                                  | `openssl s_client -connect <IP>:21 -starttls ftp`      | Connect to FTPS server, view certificate              |
| **Automation / Non-interactive** | `wget -m --no-passive ftp://anonymous:anonymous@<IP>/` | Mirror/download full FTP directory                    |
|                                  | `curl -O ftp://anonymous:anonymous@<IP>/file.txt`      | Download single file                                  |
|                                  | `curl -T localfile ftp://anonymous:anonymous@<IP>/`    | Upload file                                           |
|                                  | `lftp -u anonymous, -e "mirror / /local; bye" <IP>`    | Mirror FTP directories                                |
| **Nmap / NSE Enumeration**       | `sudo nmap -sV -p21 -sC -A <IP>`                       | Version scan, default script scan, aggressive scan    |
|                                  | `sudo nmap -p21 --script=ftp-anon,ftp-syst <IP>`       | Check for anonymous login, server STAT info           |
|                                  | `sudo nmap -sV -p21 -sC -A <IP> --script-trace`        | Trace NSE scripts, see commands/responses             |
| **Connection Testing**           | `nc -nv <IP> 21`                                       | Simple banner grab via TCP                            |
|                                  | `telnet <IP> 21`                                       | Connect to FTP for banner/interact                    |
| **Troubleshoot / Firewall**      | `passive / quote PASV`                                 | Switch to passive mode if data transfer/listing hangs |
|                                  | `wget --no-passive-ftp ftp://...`                      | Force passive FTP for non-interactive download        |

