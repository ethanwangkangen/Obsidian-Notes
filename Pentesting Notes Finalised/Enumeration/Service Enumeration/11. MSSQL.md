Important ports: 1433
# Microsoft SQL Server

- Microsoft SQL
- Sql Server Management Studio (SMSS)
	- Feature, can instsall separately or come with MSSQL
	- Commonly on server for initial configuration and long-term management of databases by admins
	- Client-side application, can be used on **any** system an admin is planning to manage db form
		- Not only on server hosting db
- Other clients can be used to access a database running MSSQL
	- mssql-cli
	- SQL server powershell
	- HeidiSQL
	- SQLPro
	- Impacket's mssqlclient.py
		- Most useful
		- `locate mssqlclient`


# Enumeration 
1. Nmap
	- `sudo nmap --script ms-sql-info,ms-sql-empty-password,ms-sql-xp-cmdshell,ms-sql-config,ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,ms-sql-dump-hashes --script-args mssql.instance-port=1433,mssql.username=sa,mssql.password=,mssql.instance-name=MSSQLSERVER -sV -p 1433 10.129.201.248`
		- mssql.username=`sa` -> guessed, default
			- `sa` is SQL server equivalent of root for database
		- no password``
2. Metasploit
	- mssql_ping
3. Mssqlclient.py
	- If have credentials (guessed or gained access), can remotely connect to MSSQL server and start interacting with databases using T-SQL (Transact-SQL)
	- `locate mssqlclient`
	- `python3 mssqlclient.py Administrator@10.129.201.248 -windows-auth`
	- If got password
		- Input after being prompetd



| Protocol / Tool                             | Command / Syntax                                                                              | Purpose / Notes                                                                   |
| ------------------------------------------- | --------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------- |
| **MSSQL ping (Nmap)**                       | `nmap -p 1433 --script ms-sql-info <target>`                                                  | Checks MSSQL service, version, and basic info.                                    |
| **Metasploit scan**                         | msql_ping in msfconsole                                                                       |                                                                                   |
| **Check empty password / weak auth (Nmap)** | `nmap -p 1433 --script ms-sql-empty-password --script-args mssql.instance-port=1433 <target>` | Tests if MSSQL accounts have empty passwords.                                     |
| **Finding Mssqlclient**                     | `locate mssqlclient`                                                                          |                                                                                   |
| **Enumerate tables / DB (Impacket)**        | `python3 mssqlclient.py <username>@<target>`                                                  | Connect interactively; run T-SQL commands like `SELECT name FROM sys.databases;`. |
| **SQL authentication with password**        | `python3 mssqlclient.py <username>:<password>@<target>`                                       | Use for SQL login (not Windows Auth).                                             |
| **Windows authentication**                  | `python3 mssqlclient.py <username>@<target> -windows-auth`                                    | Use domain/Windows credentials; password entered interactively.                   |
| **Enumerate databases**                     | `SELECT name FROM sys.databases;`                                                             | Lists all databases on the server.                                                |
| **List non-default databases**              | `SELECT name FROM sys.databases WHERE name NOT IN ('master','model','msdb','tempdb');`        | Useful for pentesting; ignores system DBs.                                        |
| **Switch database**                         | `USE <database_name>;`                                                                        | Switch to a target database.                                                      |
| **List tables**                             | `SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE='BASE TABLE';`             | Lists all tables in current database.                                             |
| **Query table contents**                    | `SELECT * FROM <table_name>;`                                                                 | Retrieves all rows from a table.                                                  |
| **Top N rows**                              | `SELECT TOP 10 * FROM <table_name>;`                                                          | MSSQL equivalent of MySQLâ€™s `LIMIT 10`.                                           |
| **Check users**                             | `SELECT name FROM sys.sql_logins;`                                                            | Enumerates SQL login accounts.                                                    |
| **Dump hashes (Impacket)**                  | `python3 mssqlclient.py -hashes <LMHASH:NTHASH> <username>@<target>`                          | Authenticate using NTLM hashes instead of password.                               |
| **Execute command**                         | `EXEC xp_cmdshell '<command>';`                                                               | Runs OS commands on the MSSQL server (requires privileges).                       |
| **Backup / restore**                        | `BACKUP DATABASE <db> TO DISK='C:\backup.bak';`                                               | Can be used for DB exfiltration if permissions allow.                             |
| **Enumerate roles/permissions**             | `SELECT * FROM sys.database_principals;`                                                      | Check privileges of users in a DB.                                                |

Default databases

|Default System Database|Description|
|---|---|
|`master`|Tracks all system information for an SQL server instance|
|`model`|Template database that acts as a structure for every new database created. Any setting changed in the model database will be reflected in any new database created after changes to the model database|
|`msdb`|The SQL Server Agent uses this database to schedule jobs & alerts|
|`tempdb`|Stores temporary objects|
|`resource`|Read-only database containing system objects included with SQL server|


Default configuration
- When admin installs MSSQL to be network accessible, SQL service likely runs as NT SERVICE\MSSQLSERVER
- Connecting from client side possible through Windows Authenticaoitn
	- By default, encryption not enforced when trying to ocnnect
	- Windows authentication -> Windows OS processes login requests, uses either local SAM database/domain controller hosting **Active Directory** before allowing connectivity to database management system

Dangerous settings
- MSSQL clients not using encryption to connect to the MSSQL server
- The use of self-signed certificates when encryption is being used. It is possible to spoof self-signed certificates
- The use of [named pipes](https://docs.microsoft.com/en-us/sql/tools/configuration-manager/named-pipes-properties?view=sql-server-ver15)
- Weak & default `sa` credentials. Admins may forget to disable this account






