Information layers

| **Layer**                | **Description**                                                                                        | **Information Categories**                                                                         |
| ------------------------ | ------------------------------------------------------------------------------------------------------ | -------------------------------------------------------------------------------------------------- |
| `1. Internet Presence`   | Identification of internet presence and externally accessible infrastructure.                          | Domains, Subdomains, vHosts, ASN, Netblocks, IP Addresses, Cloud Instances, Security Measures      |
| `2. Gateway`             | Identify the possible security measures to protect the company's external and internal infrastructure. | Firewalls, DMZ, IPS/IDS, EDR, Proxies, NAC, Network Segmentation, VPN, Cloudflare                  |
| `3. Accessible Services` | Identify accessible interfaces and services that are hosted externally or internally.                  | Service Type, Functionality, Configuration, Port, Version, Interface                               |
| `4. Processes`           | Identify the internal processes, sources, and destinations associated with the services.               | PID, Processed Data, Tasks, Source, Destination                                                    |
| `5. Privileges`          | Identification of the internal permissions and privileges to the accessible services.                  | Groups, Users, Permissions, Restrictions, Environment                                              |
| `6. OS Setup`            | Identification of the internal components and systems setup.                                           | OS Type, Patch Level, Network config, OS Environment, Configuration files, sensitive private files |
Domain Info
- Online presence
	- SSL certificates
		- Usually cerst include more than just a subdomain, and the cert is likely used for several domains
	- crt.sh
		- curl -s https://crt.sh/\?q\=inlanefreight.com\&output\=json | jq .
		- curl -s https://crt.sh/\?q\=inlanefreight.com\&output\=json | jq . | grep name | cut -d":" -f2 | grep -v "CN=" | cut -d'"' -f2 | awk '{gsub(/\\n/,"\n");}1;' | sort -u
			- Filtered by unique domains
		- Or can just upload the cert into the website. 
			- Google crt.sh
	- **(kiv, will get back to this)**


# FTP
- File Transfer Protocol
- How it works
	- Both client server establish control channel through a TCP port 21 on the server
	- Then establish data channel via a different TCP port 20, used for data transmission
- Active vs passive
	- Active: client establishes connection via TCp port 21, informs server which client-side port server can transmit responses
	- Passive: client protected by firewall, so server announces a port through which client can establish data channel. Client initiates connetion here, so firewall doesn't block
- Anonymous ftp
	- Usually need credentials, but anon lets server oeprator allow any user to upload or download via FTP without password

TFTP
- Trivial FTP
	- No user authentication
	- UDP

Default: vsFTPD
- default config in /etc/vsftpd.conf
- Also, /etc/ftpusers -> used to deny certain users access to the ftp service
- Dangerous settings
	- Optional settings that can be added to config file for anon login
	- For vsftpd, these are

| **Setting**                    | **Description**                                                                    |
| ------------------------------ | ---------------------------------------------------------------------------------- |
| `anonymous_enable=YES`         | Allowing anonymous login?                                                          |
| `anon_upload_enable=YES`       | Allowing anonymous to upload files?                                                |
| `anon_mkdir_write_enable=YES`  | Allowing anonymous to create new directories?                                      |
| `no_anon_password=YES`         | Do not ask anonymous for password?                                                 |
| `anon_root=/home/username/ftp` | Directory for anonymous.                                                           |
| `write_enable=YES`             | Allow the usage of FTP commands: STOR, DELE, RNFR, RNTO, MKD, RMD, APPE, and SITE? |
|                                |                                                                                    |
Other settings?

| **Setting**               | **Description**                                                                  |
| ------------------------- | -------------------------------------------------------------------------------- |
| `dirmessage_enable=YES`   | Show a message when they first enter a new directory?                            |
| `chown_uploads=YES`       | Change ownership of anonymously uploaded files?                                  |
| `chown_username=username` | User who is given ownership of anonymously uploaded files.                       |
| `local_enable=YES`        | Enable local users to login?                                                     |
| `chroot_local_user=YES`   | Place local users into their home directory?                                     |
| `chroot_list_enable=YES`  | Use a list of local users that will be placed in their home directory?           |
| `hide_ids=YES`            | All user and group information in directory listings will be displayed as "ftp". |
| `ls_recurse_enable=YES`   | Allows the use of recurse listings.                                              |

Commands
- See [[Basic Service Commands. FTP,..]]
- Interacting with ftp (banner grabbing)
	- `nc -nv 10.129.14.136 21`
		- Note: this is raw tcp channel. If want to actually use commands, do ftp ...
	- If FTP server runs with TLS/SSL encryption, then need a client
		- `openssl s_client -connect 10.129.14.136:21 -starttls ftp`

# SMB
- Windows uses SMB, Linux uses SAMBA
- Config file in `/etc/samba/smb.conf`

| **Setting**                    | **Description**                                                       |
| ------------------------------ | --------------------------------------------------------------------- |
| `[sharename]`                  | The name of the network share.                                        |
| `workgroup = WORKGROUP/DOMAIN` | Workgroup that will appear when clients query.                        |
| `path = /path/here/`           | The directory to which user is to be given access.                    |
| `server string = STRING`       | The string that will show up when a connection is initiated.          |
| `unix password sync = yes`     | Synchronize the UNIX password with the SMB password?                  |
| `usershare allow guests = yes` | Allow non-authenticated users to access defined share?                |
| `map to guest = bad user`      | What to do when a user login request doesn't match a valid UNIX user? |
| `browseable = yes`             | Should this share be shown in the list of available shares?           |
| `guest ok = yes`               | Allow connecting to the service without using a password?             |
| `read only = yes`              | Allow users to read files only?                                       |
| `create mask = 0700`           | What permissions need to be set for newly created files?              |
Dangerous settings:

| **Setting**                 | **Description**                                                     |
| --------------------------- | ------------------------------------------------------------------- |
| `browseable = yes`          | Allow listing available shares in the current share?                |
| `read only = no`            | Forbid the creation and modification of files?                      |
| `writable = yes`            | Allow users to create and modify files?                             |
| `guest ok = yes`            | Allow connecting to the service without using a password?           |
| `enable privileges = yes`   | Honor privileges assigned to specific SID?                          |
| `create mask = 0777`        | What permissions must be assigned to the newly created files?       |
| `directory mask = 0777`     | What permissions must be assigned to the newly created directories? |
| `logon script = script.sh`  | What script needs to be executed on the user's login?               |
| `magic script = script.sh`  | Which script should be executed when the script gets closed?        |
| `magic output = script.out` | Where the output of the magic script needs to be stored?            |

Adding a shared folder
- Configure in samba
- Adding shared file
	- Put it in the folder

Commands
- [[Basic Service Commands. FTP,..]]
- Won't repeat this

RPC
- Remote Procedure Call
	- Essentially a 'control language' for the server
	- Lets you ask the server questions and tells it what operastions to perform
- Commands in [[Basic Service Commands. FTP,..]]
- eg.
	- enumerate users with `enumdomusers`
	- then query users individually
		- `queryuser [rid]`
	- then can see their groups' RID, then query group
		- `querygroup [rid]`

Brute forcing user RIDs
- `for i in $(seq 500 1100);do rpcclient -N -U "" 10.129.14.128 -c "queryuser 0x$(printf '%x\n' $i)" | grep "User Name\|user_rid\|group_rid" && echo "";done
- `samrdump.py 10.129.14.128`

Other tools for RPC enumeration
- SMBmap
	- `smbmap -H 10.129.14.129`
- Crackmapexec
	- `crackmapexec smb 10.129.14.128 --shares -u '' -p ''`
- Enum4linux-ng
	- `git clone https://github.com/cddmp/enum4linux-ng.git`
	- `cd enum4linux-ng`
	- `pip3 install -r requirements.txt`
	- `./enum4linux-ng.py 10.129.14.128 -A`




