Information layers

| **Layer**                | **Description**                                                                                        | **Information Categories**                                                                         |
| ------------------------ | ------------------------------------------------------------------------------------------------------ | -------------------------------------------------------------------------------------------------- |
| `1. Internet Presence`   | Identification of internet presence and externally accessible infrastructure.                          | Domains, Subdomains, vHosts, ASN, Netblocks, IP Addresses, Cloud Instances, Security Measures      |
| `2. Gateway`             | Identify the possible security measures to protect the company's external and internal infrastructure. | Firewalls, DMZ, IPS/IDS, EDR, Proxies, NAC, Network Segmentation, VPN, Cloudflare                  |
| `3. Accessible Services` | Identify accessible interfaces and services that are hosted externally or internally.                  | Service Type, Functionality, Configuration, Port, Version, Interface                               |
| `4. Processes`           | Identify the internal processes, sources, and destinations associated with the services.               | PID, Processed Data, Tasks, Source, Destination                                                    |
| `5. Privileges`          | Identification of the internal permissions and privileges to the accessible services.                  | Groups, Users, Permissions, Restrictions, Environment                                              |
| `6. OS Setup`            | Identification of the internal components and systems setup.                                           | OS Type, Patch Level, Network config, OS Environment, Configuration files, sensitive private files |
Domain Info
- Online presence
	- SSL certificates
		- Usually cerst include more than just a subdomain, and the cert is likely used for several domains
	- crt.sh
		- curl -s https://crt.sh/\?q\=inlanefreight.com\&output\=json | jq .
		- curl -s https://crt.sh/\?q\=inlanefreight.com\&output\=json | jq . | grep name | cut -d":" -f2 | grep -v "CN=" | cut -d'"' -f2 | awk '{gsub(/\\n/,"\n");}1;' | sort -u
			- Filtered by unique domains
		- Or can just upload the cert into the website. 
			- Google crt.sh
	- **(kiv, will get back to this)**


# FTP
- File Transfer Protocol
- How it works
	- Both client server establish control channel through a TCP port 21 on the server
	- Then establish data channel via a different TCP port 20, used for data transmission
- Active vs passive
	- Active: client establishes connection via TCp port 21, informs server which client-side port server can transmit responses
	- Passive: client protected by firewall, so server announces a port through which client can establish data channel. Client initiates connetion here, so firewall doesn't block
- Anonymous ftp
	- Usually need credentials, but anon lets server oeprator allow any user to upload or download via FTP without password

TFTP
- Trivial FTP
	- No user authentication
	- UDP

Default: vsFTPD
- default config in /etc/vsftpd.conf
- Also, /etc/ftpusers -> used to deny certain users access to the ftp service
- Dangerous settings
	- Optional settings that can be added to config file for anon login
	- For vsftpd, these are

| **Setting**                    | **Description**                                                                    |
| ------------------------------ | ---------------------------------------------------------------------------------- |
| `anonymous_enable=YES`         | Allowing anonymous login?                                                          |
| `anon_upload_enable=YES`       | Allowing anonymous to upload files?                                                |
| `anon_mkdir_write_enable=YES`  | Allowing anonymous to create new directories?                                      |
| `no_anon_password=YES`         | Do not ask anonymous for password?                                                 |
| `anon_root=/home/username/ftp` | Directory for anonymous.                                                           |
| `write_enable=YES`             | Allow the usage of FTP commands: STOR, DELE, RNFR, RNTO, MKD, RMD, APPE, and SITE? |
|                                |                                                                                    |
Other settings?

| **Setting**               | **Description**                                                                  |
| ------------------------- | -------------------------------------------------------------------------------- |
| `dirmessage_enable=YES`   | Show a message when they first enter a new directory?                            |
| `chown_uploads=YES`       | Change ownership of anonymously uploaded files?                                  |
| `chown_username=username` | User who is given ownership of anonymously uploaded files.                       |
| `local_enable=YES`        | Enable local users to login?                                                     |
| `chroot_local_user=YES`   | Place local users into their home directory?                                     |
| `chroot_list_enable=YES`  | Use a list of local users that will be placed in their home directory?           |
| `hide_ids=YES`            | All user and group information in directory listings will be displayed as "ftp". |
| `ls_recurse_enable=YES`   | Allows the use of recurse listings.                                              |

Commands
- See [[Basic Service Commands. FTP,..]]
- Interacting with ftp (banner grabbing)
	- `nc -nv 10.129.14.136 21`
		- Note: this is raw tcp channel. If want to actually use commands, do ftp ...
	- If FTP server runs with TLS/SSL encryption, then need a client
		- `openssl s_client -connect 10.129.14.136:21 -starttls ftp`

# SMB
- Important ports: 139, 445
- Windows uses SMB, Linux uses SAMBA
- Config file in `/etc/samba/smb.conf`

| **Setting**                    | **Description**                                                       |
| ------------------------------ | --------------------------------------------------------------------- |
| `[sharename]`                  | The name of the network share.                                        |
| `workgroup = WORKGROUP/DOMAIN` | Workgroup that will appear when clients query.                        |
| `path = /path/here/`           | The directory to which user is to be given access.                    |
| `server string = STRING`       | The string that will show up when a connection is initiated.          |
| `unix password sync = yes`     | Synchronize the UNIX password with the SMB password?                  |
| `usershare allow guests = yes` | Allow non-authenticated users to access defined share?                |
| `map to guest = bad user`      | What to do when a user login request doesn't match a valid UNIX user? |
| `browseable = yes`             | Should this share be shown in the list of available shares?           |
| `guest ok = yes`               | Allow connecting to the service without using a password?             |
| `read only = yes`              | Allow users to read files only?                                       |
| `create mask = 0700`           | What permissions need to be set for newly created files?              |
Dangerous settings:

| **Setting**                 | **Description**                                                     |
| --------------------------- | ------------------------------------------------------------------- |
| `browseable = yes`          | Allow listing available shares in the current share?                |
| `read only = no`            | Forbid the creation and modification of files?                      |
| `writable = yes`            | Allow users to create and modify files?                             |
| `guest ok = yes`            | Allow connecting to the service without using a password?           |
| `enable privileges = yes`   | Honor privileges assigned to specific SID?                          |
| `create mask = 0777`        | What permissions must be assigned to the newly created files?       |
| `directory mask = 0777`     | What permissions must be assigned to the newly created directories? |
| `logon script = script.sh`  | What script needs to be executed on the user's login?               |
| `magic script = script.sh`  | Which script should be executed when the script gets closed?        |
| `magic output = script.out` | Where the output of the magic script needs to be stored?            |

Adding a shared folder
- Configure in samba
- Adding shared file
	- Put it in the folder

Commands
- [[Basic Service Commands. FTP,..]]
- Won't repeat this

RPC
- Remote Procedure Call
	- Essentially a 'control language' for the server
	- Lets you ask the server questions and tells it what operastions to perform
- Commands in [[Basic Service Commands. FTP,..]]
- eg.
	- enumerate users with `enumdomusers`
	- then query users individually
		- `queryuser [rid]`
	- then can see their groups' RID, then query group
		- `querygroup [rid]`

Brute forcing user RIDs
- `for i in $(seq 500 1100);do rpcclient -N -U "" 10.129.14.128 -c "queryuser 0x$(printf '%x\n' $i)" | grep "User Name\|user_rid\|group_rid" && echo "";done
- `samrdump.py 10.129.14.128`

Other tools for RPC enumeration
- SMBmap
	- `smbmap -H 10.129.14.129`
- Crackmapexec
	- `crackmapexec smb 10.129.14.128 --shares -u '' -p ''`
- Enum4linux-ng
	- `git clone https://github.com/cddmp/enum4linux-ng.git`
	- `cd enum4linux-ng`
	- `pip3 install -r requirements.txt`
	- `./enum4linux-ng.py 10.129.14.128 -A`

# NFS
- Important TCP Ports: 111, 2049
- Same purpose as SMB, but only for Linux/Unix
- Based on ONC-RPC on TCP and UDP ports 111
	- NFS has no authentication, all done by RPC options
		- Most commonly via UNIX UID/GID and group memberships
- Config: `/etc/exports`

| **Option**         | **Description**                                                                                                                             |
| ------------------ | ------------------------------------------------------------------------------------------------------------------------------------------- |
| `rw`               | Read and write permissions.                                                                                                                 |
| `ro`               | Read only permissions.                                                                                                                      |
| `sync`             | Synchronous data transfer. (A bit slower)                                                                                                   |
| `async`            | Asynchronous data transfer. (A bit faster)                                                                                                  |
| `secure`           | Ports above 1024 will not be used.                                                                                                          |
| `insecure`         | Ports above 1024 will be used.                                                                                                              |
| `no_subtree_check` | This option disables the checking of subdirectory trees.                                                                                    |
| `root_squash`      | Assigns all permissions to files of root UID/GID 0 to the UID/GID of anonymous, which prevents `root` from accessing files on an NFS mount. |
How to share:
```c
root@nfs:~# echo '/mnt/nfs  10.129.14.0/24(sync,no_subtree_check)' >> /etc/exports
root@nfs:~# systemctl restart nfs-kernel-server 
root@nfs:~# exportfs

```
- Shared the folder /mnt/nfs to the subnet 10.129.14.0/24

Dangerous settings

| **Option**       | **Description**                                                                                                                                      |
| ---------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------- |
| `rw`             | Read and write permissions.                                                                                                                          |
| `insecure`       | Ports above 1024 will be used.<br>The first 1024 ports can only be used by root, but this setting allows users to use to use sockets above port 1024 |
| `nohide`         | If another file system was mounted below an exported directory, this directory is exported by its own exports entry.                                 |
| `no_root_squash` | All files created by root are kept with the UID/GID 0.                                                                                               |
Footprinting
- As usual, namp with -sv and --script nfs*

Authentication
- Uses UIDs and GUIDs 
	- These are local by default. Live in `/etc/passwd and /etc/group`
	- So what if 'ethan' and 'alice' both have the same UID on diff PCs?
- Solution: NFS assumes client and server share the same UID/GUID scheme
	- eg. Active directory
	- so UID 1000 is really the same person everywhere
	- However still insecure
	- NSFv4 +Kerberos fixes this.
- To prevent abuse: root_squash
	- If client connects as root (UID 0), squashed to nobody
		- ie. so client's root cannot act as server's root
		- to prevent someone with root on any client deleting or chown files on the server

Mounting
- After discovering an NFS service, can mount it on local machine
- Show available NFS shares
	- `showmount -e 10.129.14.128`
- Mounting
	- `mkdir target-NFS` //this is the local folder we are using to mount 
	- `sudo mount -t nfs 10.129.14.128:/ ./target-NFS/ -o nolock
		- :/ means exported root; asking server for the root of whatever directories it exports
	- `cd target-NFS`
	- `tree .`
- Listing
	- `ls -l mnt/nfs` : with usernames and group names
	- `ls -n mnt/nfs` : with UIDs and GUIDs
- Notes
	- if root_squash set, cannot edit the backup.sh file even as root
	- can use NFS for further escalation
		- eg. have access to the system via SSH. want to read files from another folder that a specific user can read
			- Need to upload a shell to the NFS share that has the SUID of that user
				- Do this by setting the shell file owner as that user, then enable SUID
			- Then run the shell via the SSH user
				- Will act as the "owner" of the shell
		- Basically, if i run a shell program with SUID set to user1, i can read files that have permissions for user1 to readls


# DNS
- See [[2. Application - DNS]]
- Configuration files
	- 3 types
		- Local DNS config files
			- `name.conf.local`
			- `name.conf.options`
			- `name.conf.log`
		- Zone files
		- Reverse name resolution files

Local DNS Config
- `/etc/bind/named.conf.local`
- Different zones defined here
	- Zones divided into individual files
	- Most cases, mainly for one domain only
	- Exceptions: ISP and public DNS servers
- Zone file
	- Text file that describes a DNS zone with the BIND file format

Zone vs Domain
- Domain: branch of the DNS tree, eg. example.com
- Zone: part of the DNS tree that a specific DNS server manages
	- Can refer to a domain, but also can cover subdomains or multiple domains depending on config

Zone File
- Lists all DNS records for that portion of the DNS namespace
	- SOA (Start of Authority) → metadata about the zone (serial number, refresh interval, etc.).
	- NS (Name Server) → which servers are authoritative for the zone.
	- A / AAAA → hostnames → IP addresses.
	- MX → mail servers.
	- CNAME → aliases.
	- PTR (in reverse zones) → IP → hostname.
- For Fully Qualified Domain Name (FQDN) to be resolved from IP address, DNS server must have reverse lookup file

```c
DNS Tree (simplified)
.
└─ com
   └─ example.com  (Zone 1)
      ├─ www         (inside Zone 1)
      ├─ ftp         (inside Zone 1)
      └─ dev.example.com  (Zone 2, separate server)
```


Dangerous settings

|**Option**|**Description**|
|---|---|
|`allow-query`|Defines which hosts are allowed to send requests to the DNS server.|
|`allow-recursion`|Defines which hosts are allowed to send recursive requests to the DNS server.|
|`allow-transfer`|Defines which hosts are allowed to receive zone transfers from the DNS server.|
|`zone-statistics`|Collects statistical data of zones.|


Footprinting
- Find nameservers
	- NS query
		- `dig ns inlanefreight.htb @10.129.14.128`
			- This is asking, the server at 10.129.14.128, which Name Server (NS) is authoritative for inlanefreight.htb
	- Version query
		- `dig CH TXT version.bind 10.129.120.85`
- ANY query: get all available DNS records
	- `dig any inlanefreight.htb @10.129.14.128`

Zone transfer - Asynchronous Full Transfer Zone (AXFR)
- Is more of replication than 'transfer'
- Transfer of zones to another server in DNS
- Original data of zone on DNS server -> primary name server for this zone
	- But one or more additional servers installed for reliability
		- Secondary name server
- DNS entries generally only created, modified, dleeted on primary
- `dig axfr inlanefreight.htb @10.129.14.128`

Subdomain brute forcing
- ` for sub in $(cat /opt/useful/seclists/Discovery/DNS/subdomains-top1million-110000.txt);do dig $sub.inlanefreight.htb @10.129.14.128 | grep -v ';\|SOA' | sed -r '/^\s*$/d' | grep $sub | tee -a subdomains.txt;done
- dnsenum
	- `dnsenum --dnsserver 10.129.14.128 --enum -p 0 -s 0 -o subdomains.txt -f /opt/useful/seclists/Discovery/DNS/subdomains-top1million-110000.txt inlanefreight.htb
`
`
(kiv. come back to this)

`
