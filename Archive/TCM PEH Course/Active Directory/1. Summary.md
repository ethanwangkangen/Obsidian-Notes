AD Components
- Physical
	- Domain controller
		- Hosts a copy of the AD DS directory store
		- Provide authentication and authorization, etc.
		- Allow administrative access to manage user accounts and network resources
	- AD DS data store
		- Consists of the Ntds.dit file (important!)
		- Stored by default in %SystemRoot%\NTDS folder on all domain controllers
		- Accessible only through the domain controller processes and protocols
	- Global catalog server
	- Read-Only Domain Controller (RODC)
- Logical
	- Partitions 
	- Schema
		- Defines types of objects that cn be stored
		- Types
			- Class objects: what objects can be created in directory
			- Attribute objects: info that can be attached to object
	- Domains
		- Used to group and manage objects
	- Domain trees
		- Hierarchy of domains
		- eg. contoso.com -> emea.contoso.com (shares namespace with parent domain)
	- Forests
		- Collection of trees
		- Share common schema, common config partition, common globa catalog to enable searching
		- Enable trusts between all domains in forest
		- Share Enterprise Admins and Schema Admins groups
	- Sites
	- Organizational units (OU)
		- Containers that can group users, groups, computers etc.
		- Used rto represent organization hierarchically and logically
	- Trust
		- Directional
			- Flows one way, from trusting domain to trusted domain
		- Transactional
			- Two way
		- All domains in a forest trust all other domains in a forest
		- Trust can extend outside the forest

# Kerberos
- 

# SMB and authentication



# LLMNR Poisoning
LLMNR
- Used to identify hosts when DNS fails to do so
- Previously NBT-NS
- Key flaw: utilise user's username and NTLMv2 hash when appropriately responded to
- MITM
	- A victim machine tries to access a host (say `fileserver`) but DNS cannot resolve it.
		- eg. typing `\\fileserver\documents` into file explorer
			- windows tries to resolve `fileserver` into an IP address via DNS
		- Note: DNS here refers to Internal DNS. Companies run their own internal DNS servers to resolve internal hostnames.
	- The victim falls back to **LLMNR broadcast**:  
	    `"Who is fileserver? Respond with your IP."`
	- An attacker machine running a tool like **Responder** replies:  
	    `"I am fileserver. My IP is X.X.X.X."`
	- The victim now tries to authenticate **(via SMB)** with the fake server (the attacker).
	    - During authentication, the victim sends **NTLMv2 hashes** (Windows authentication mechanism).
	    - Attacker captures username, domain and NTLMv hash
    - The attacker captures these hashes and:
	    - Cracks them offline (e.g., with **hashcat**).
	    - Or relays them to another system if **NTLM relay attacks** are possible.
- Steps
	- 1. Responder
		- sudo responder -l tun0 -dwP 
			- tun for vpn tunnel, or eth0 depending on interface
		- tool that automatically listens for these requests, and poisons the response, saying "I am the server you're looking for"
		- then captures the authentication attempts and dumps NTLM hashes
	- 2. Event happens
	- 3. Grab hash
	- 4. Break hash 
		- hashcat
			- Better to do this on own system rather than VM, to make use of GPU


# SMB Relay
- Instead of cracking hashes, can relay those hashes to specific machines and potentially gain access
	- Essentially, attacker tries to impersonate the target after capturing its authenticaion attempt hash
- Requirements
	- SMB signing must be disabled or not enforced on the target
	- Relayed user credentials must be admin on machine for any real value
- Steps
	- 1. Identify hosts without SMB signing
		- nmap --script=smb2-security-mode.nse -p445 10.0.0.0/24
		- Result: 'message signing enabled but not required'
	- 2. Responder
		- need to edit configs
			- sudo nano /etc/responder/Responder.conf
			- turn SMB and HTTP OFF
		- then sun
			- sudo response -I tun0 -dwP
	- 3. SMB Relay
		- sudo ntlmrelayx.py -tf targets.txt -smb2support
			- target ips (found from the nmap scans) are in targets.txt
			- following this command, can -i for a shell or -c to input commands
				- if -i, will see the client shell being spawned at a certain port, just need to nc to that on attacker machine
					- shell is spawned at localhost, but is actually forwarding the commands to victim

# Gain Shell Access (SMB)
- Through metasploit
	- use exploit/windows/smb/psexec
		- can use password, if have. (associated with a user)
		- can use hash, from above exploit (SMB SAM)
- Through psexec.py (or wmiexec.py or smbexec.py)
	- password and domain
		- psexec.py marvel.local/fcastle:'Password1'@10.0.0.25
	- hash and user
		- psexec.py administrator@10.0.0.25 - hashes (LM:NT)

# IPv6 Attacks
- DNS takeover via mitm6












----
Questions
- How does SMB work
- What is NTLM
- How dow LLMNR and SMB Relay work exactly